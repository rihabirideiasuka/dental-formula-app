<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>口腔記録フォーム</title>
  <style>
    @page { size: A4; margin: 10mm; }
    html, body {
      margin: 0;
      padding: 0;
      width: 210mm;
      height: 297mm;
      font-family: "Arial", sans-serif;
      font-size: 10pt;
      box-sizing: border-box;
    }

    /* テーブルと基本フォーム */
    .container {
      padding: 10mm;
      border: 1px solid #000;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-bottom: 10px;
      font-size: 8.5pt;
      text-align: center;
      line-height: 1.1;
    }
    th, td {
      border: 1px solid black;
      padding: 2px 6px;
      white-space: nowrap;
      vertical-align: middle;
    }
    .label {
      text-align: center;
      font-weight: bold;
      background: #f0f0f0;
    }
    input[type="text"], input[type="date"], select {
      width: 100%;
      font-size: 10pt;
      border: none;
      outline: none;
      background: none;
    }

    /* セクションタイトルと名前 */
    .section-title {
      font-weight: bold;
      font-size: 11pt;
      margin: 12px 0 6px;
    }
    #name {
      font-size: 14pt;
      font-weight: bold;
    }

    /* 歯の描画 */
    .tooth-grid {
      display: grid;
      grid-template-columns: repeat(16, 24px);
      grid-gap: 5px;
      margin-left: 120px;
      position: relative;
    }
    .tooth {
      width: 24px;
      height: 24px;
      border: 1px solid #999;
      position: relative;
      text-align: center;
    }
    .number {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      z-index: 1;
    }
    .state {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
      z-index: 2;
    }
    .label-top, .label-bottom {
      font-size: 10px;
      font-weight: bold;
      color: blue;
      position: absolute;
      width: 100%;
      left: 0;
      text-align: center;
    }
    .label-top { top: -1.2em; }
    .label-bottom { bottom: -1.2em; }
    .center-divider {
      position: absolute;
      width: 0px;
      border-left: 1px solid black;
      z-index: 1;
    }
    .horizontal-divider {
      position: absolute;
      height: 0px;
      border-top: 1px solid black;
      z-index: 1;
    }

    /* モーダルとボタン */
    .modal {
      display: none;
      position: fixed;
      background: rgba(0,0,0,0.6);
      top: 0; left: 0; right: 0; bottom: 0;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      width: 90%;
      max-width: 350px;
      font-size: 20px;
    }
    .btn {
      padding: 0.8em 1.5em;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      cursor: pointer;
      background-color: white;
      margin: 0.5em;
    }
    .btn:hover {
      background-color: #0056b3;
      color: white;
    }

    /* その他レイアウト */
    .print-wrapper {
      display: flex;
      flex-direction: row;
      align-items: stretch;
      gap: 0;
    }
    .left-box {
      flex: 1;
      min-width: 400px;
      max-width: 600px;
      margin-right: 0;
    }
    .consent-box {
      font-size: 8pt;
      border: 1px solid black;
      padding: 6px;
      margin-left: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: center;
      min-width: 180px;
      height: 100%;
    }
    .signature-space {
      border-bottom: 1px solid black;
      height: 40px;
      margin-top: 8px;
    }

    .input-block {
      margin-bottom: 1em;
    }
    .label-text {
      font-size: 14px;
      margin-bottom: 0.3em;
    }
    .large-input {
      font-size: 16px;
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
    }

    #upper-toggle-wrapper, #lower-toggle-wrapper {
      position: absolute;
    }
    #br-lines {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
    }
  </style>

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const birthdayInput = document.getElementById('birthday');
      const ageInput = document.getElementById('age');
      if (birthdayInput && ageInput) {
        birthdayInput.addEventListener('change', () => {
          const birthDate = new Date(birthdayInput.value);
          if (!isNaN(birthDate)) {
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
              age--;
            }
            ageInput.value = age;
          }
        });
      }
    });
  </script>
</head>

<body onload="updateCenterDivider()">
  <div class="container">
    <h1 style="text-align:center; font-size:13pt; margin-bottom:10px;">口腔機能向上サービスに関する計画書・アセスメント・モニタリング・評価表</h1>

    <table>
      <tr>
        <td class="label" style="width: 60px;">ふりがな</td>
        <td style="width: 140px;"><input type="text" id="furigana" /></td>
        <td class="label" style="width: 25px;">男</td>
        <td style="width: 25px;"><input type="radio" name="gender" value="男" /></td>
        <td class="label" style="width: 25px;">女</td>
        <td style="width: 25px;"><input type="radio" name="gender" value="女" /></td>
        <td class="label" style="width: 60px;">生年月日</td>
        <td style="width: 110px;"><input type="date" id="birthday" /></td>
        <td class="label" style="width: 30px;">年齢</td>
        <td style="width: 40px;"><input type="text" id="age" placeholder="" readonly /></td>
      </tr>
      <tr>
        <td class="label" rowspan="2">氏名</td>
        <td rowspan="2"><input type="text" id="name" /></td>
        <td class="label" colspan="2" rowspan="2">要介護度</td>
        <td colspan="2" rowspan="2">
          <select id="careLevel">
            <option value="">選択</option>
            <option>要支援1</option>
            <option>要支援2</option>
            <option>要介護1</option>
            <option>要介護2</option>
            <option>要介護3</option>
            <option>要介護4</option>
            <option>要介護5</option>
          </select>
        </td>
        <td class="label" rowspan="2">日常生活<br>自立度</td>
        <td class="label">障害高齢者</td>
        <td colspan="2">
          <select id="adlDisability">
            <option value="">選択</option>
            <option>自立</option>
            <option>J1</option>
            <option>J2</option>
            <option>A1</option>
            <option>A2</option>
            <option>B1</option>
            <option>B2</option>
            <option>C1</option>
            <option>C2</option>
          </select>
        </td>
      </tr>
      <tr>
        <td class="label">認知症高齢者</td>
        <td colspan="2">
          <select id="adlDementia">
            <option value="">選択</option>
            <option>自立</option>
            <option>Ⅰ</option>
            <option>Ⅱa</option>
            <option>Ⅱb</option>
            <option>Ⅲa</option>
            <option>Ⅲb</option>
            <option>Ⅳ</option>
            <option>M</option>
          </select>
        </td>
      </tr>
    </table>


<h2 style="font-size: 14px;">歯式</h2>

<!-- Br操作ボタン -->
<button onclick="toggleBrMode()">Br作成</button>
<button onclick="clearBrLines()">Br消去</button>
<div id="brStatus" style="margin-top: 0.5em; font-size: 12px;">Br未選択</div>

<div style="display: flex; align-items: flex-start; margin-left: 20px;">
  <!-- 凡例ラベル -->
  <div class="legend" style="font-size: 11px; line-height: 1.8; margin-right: 8px;">
    <div>健全歯：／</div>
    <div>処置歯：○</div>
    <div>欠損歯：×</div>
    <div>う蝕：C</div>
    <div>ｲﾝﾌﾟﾗﾝﾄ：IMPL</div>
  </div>
  <!-- PD/FDボタン -->
  <div id="upper-toggle-wrapper"></div>
  <div id="lower-toggle-wrapper"></div>
  <!-- 歯の表示エリア -->
  <div style="position: relative;">
    <div id="br-lines"></div>
    <div class="tooth-grid" id="upperJaw"></div>
    <div class="center-divider"></div>
    <div class="horizontal-divider" id="horizontal-divider"></div>
    <div class="tooth-grid" id="lowerJaw" style="margin-top: 20px;"></div>
  </div>
</div>

<!-- モーダル -->
<div class="modal" id="modal">
  <div class="modal-content">
    <p>歯の状態を選択：</p>
    <button onclick="setState('○')">○</button>
    <button onclick="setState('×')">×</button>
    <button onclick="setState('／')">／</button>
    <button onclick="setState('△')">△</button>
    <button onclick="setState('')">消去</button>
    <p>補助ラベル：</p>
    <button onclick="setLabel('Cr')">Cr</button>
    <button onclick="setLabel('In')">In</button>
    <button onclick="setLabel('Fck')">Fck</button>
    <button onclick="setLabel('死根')">死根</button>
    <button onclick="setLabel('残根')">残根</button>
    <button onclick="setLabel('C')">C</button>
    <button onclick="setLabel('C4')">C4</button>
    <button onclick="setLabel('IMPL')">IMPL</button>
    <button onclick="setLabel('')">ラベル消去</button>
  </div>
</div>

<script>
const upperJaw = document.getElementById("upperJaw");
const lowerJaw = document.getElementById("lowerJaw");
const modal = document.getElementById("modal");
let selectedTooth = null;

const left = [8,7,6,5,4,3,2,1];
const right = [1,2,3,4,5,6,7,8];

function createTooth(id, jaw, position) {
  const div = document.createElement("div");
  div.className = "tooth";
  div.dataset.id = id;
  div.dataset.jaw = jaw;
  div.dataset.position = position;
  div.innerHTML = `
    <span class="number">${id}</span>
    <span class="state"></span>
    <div class="label-top"></div>
    <div class="label-bottom"></div>
  `;
  div.onclick = () => {
    if (brMode) {
      handleToothClickForBr(div);
    } else {
      selectedTooth = div;
      modal.style.display = "flex";
    }
  };
  return div;
}

left.concat(right).forEach((num, i) => upperJaw.appendChild(createTooth(num, "upper", i < 8 ? "left" : "right")));
left.concat(right).forEach((num, i) => lowerJaw.appendChild(createTooth(num, "lower", i < 8 ? "left" : "right")));

function setState(symbol) {
  if (!selectedTooth) return;
  selectedTooth.querySelector(".state").textContent = symbol;
  modal.style.display = "none";
}
function setLabel(label) {
  if (!selectedTooth) return;
  const elem = selectedTooth.dataset.jaw === "upper" ? ".label-top" : ".label-bottom";
  selectedTooth.querySelector(elem).textContent = label;
  modal.style.display = "none";
}
modal.onclick = e => { if (e.target === modal) modal.style.display = "none"; };

let brMode = false, brStart = null, brEnd = null, selectedBrRanges = [];

function toggleBrMode() {
  brMode = !brMode;
  brStart = brEnd = null;
  document.getElementById("brStatus").textContent = brMode ? "Brモード ON：何番～？" : "BrモードOFF";
}
function handleToothClickForBr(div) {
  const status = document.getElementById("brStatus");
  if (!brStart) {
    brStart = div;
    status.textContent = `何番まで？（開始: ${brStart.dataset.id}）`;
  } else {
    brEnd = div;
    if (brStart.dataset.jaw !== brEnd.dataset.jaw) {
      alert("同じ顎を選んでください");
      brStart = brEnd = null;
      return;
    }
    selectedBrRanges.push({
      start: brStart.dataset.id,
      end: brEnd.dataset.id,
      jaw: brStart.dataset.jaw
    });
    drawBrLine(brStart, brEnd);
    brMode = false;
    status.textContent = `Br選択完了：${brStart.dataset.id}〜${brEnd.dataset.id}`;
    brStart = brEnd = null;
  }
}
function drawBrLine(startElem, endElem) {
  const container = document.getElementById("br-lines");
  const r1 = startElem.getBoundingClientRect();
  const r2 = endElem.getBoundingClientRect();
  const p = container.getBoundingClientRect();
  const x1 = r1.left + r1.width / 2 - p.left;
  const x2 = r2.left + r2.width / 2 - p.left;
  const y = startElem.dataset.jaw === "upper" ? r1.top - p.top - 12 : r1.bottom - p.top + 10;
  const minX = Math.min(x1, x2), maxX = Math.max(x1, x2), midX = (minX + maxX) / 2;


  // 水平線（Brの横線）
  const line = document.createElement("div");
  Object.assign(line.style, {
    position: "absolute",
    top: y + "px",
    left: minX + "px",
    width: (maxX - minX + 1) + "px",
    height: "0px", // 高さ0で border-top を使用
    borderTop: "1px solid red"
  });

  // 左側の縦線
  const leftLine = document.createElement("div");
  Object.assign(leftLine.style, {
    position: "absolute",
    left: x1 + "px",
    width: "0px",
    height: "6px",
    borderLeft: "1px solid red",
    top: startElem.dataset.jaw === "upper" ? y + "px" : (y - 6) + "px"
  });

  // 右側の縦線
  const rightLine = document.createElement("div");
  Object.assign(rightLine.style, {
    position: "absolute",
    left: x2 + "px",
    width: "0px",
    height: "6px",
    borderLeft: "1px solid red",
    top: startElem.dataset.jaw === "upper" ? y + "px" : (y - 6) + "px"
  });


  const label = document.createElement("div");
  label.textContent = "Br";
  Object.assign(label.style, {
    position: "absolute", left: (midX - 5) + "px",
    top: startElem.dataset.jaw === "upper" ? (y - 12) + "px" : (y - 2) + "px",
    color: "red", fontSize: "10px", fontWeight: "bold"
  });

  [line, leftLine, rightLine, label].forEach(el => {
    el.className = "br-line";
    container.appendChild(el);
  });
}
function clearBrLines() {
  document.querySelectorAll(".br-line").forEach(e => e.remove());
  selectedBrRanges = [];
  document.getElementById("brStatus").textContent = "Br未選択";
}

function cyclePdFd(btn) {
  const states = ["", "PD", "FD"];
  const current = btn.textContent.trim();
  btn.textContent = states[(states.indexOf(current) + 1) % states.length];
}
function positionPdFdButtons() {
  const upper8 = [...upperJaw.querySelectorAll(".tooth")].find(t => t.dataset.id === "8" && t.dataset.position === "right");
  const lower8 = [...lowerJaw.querySelectorAll(".tooth")].find(t => t.dataset.id === "8" && t.dataset.position === "right");

  const upperWrapper = document.getElementById("upper-toggle-wrapper");
  const lowerWrapper = document.getElementById("lower-toggle-wrapper");

  // 初期化
  upperWrapper.innerHTML = "";
  lowerWrapper.innerHTML = "";

  // ボタン生成＆イベントバインド
  if (upper8) {
    const btn = document.createElement("button");
    btn.textContent = ""; // 初期は空
    btn.addEventListener("click", () => cyclePdFd(btn));
    upperWrapper.appendChild(btn);
    upperJaw.appendChild(upperWrapper);

    // グリッド内での相対位置
    requestAnimationFrame(() => {
      const offset = upper8.offsetLeft + upper8.offsetWidth + 4;
      upperWrapper.style.position = "absolute";
      upperWrapper.style.left = `${offset}px`;
      upperWrapper.style.top = `${upper8.offsetTop}px`;
    });
  }

  if (lower8) {
    const btn = document.createElement("button");
    btn.textContent = "";
    btn.addEventListener("click", () => cyclePdFd(btn));
    lowerWrapper.appendChild(btn);
    lowerJaw.appendChild(lowerWrapper);

    requestAnimationFrame(() => {
      const offset = lower8.offsetLeft + lower8.offsetWidth + 4;
      lowerWrapper.style.position = "absolute";
      lowerWrapper.style.left = `${offset}px`;
      lowerWrapper.style.top = `${lower8.offsetTop}px`;
    });
  }
}


window.addEventListener("load", () => {
  positionPdFdButtons();
  updateCenterDivider();
  updateHorizontalDivider();
});
window.addEventListener("resize", () => {
  positionPdFdButtons();
  updateCenterDivider();
  updateHorizontalDivider();
});


function updateCenterDivider() {
  const upper = document.getElementById("upperJaw");
  const lower = document.getElementById("lowerJaw");
  const divider = document.querySelector(".center-divider");

  if (upper && lower && divider) {
    const containerRect = upper.parentElement.getBoundingClientRect();
    const upperRect = upper.getBoundingClientRect();

    const leftOffset = upperRect.left - containerRect.left;
    const toothWidth = 24;
    const gap = 5;
    const midOffset = (toothWidth + gap) * 8 - (gap / 2);  // ちょうど中央の線（gapも考慮）

    divider.style.left = `${leftOffset + midOffset}px`;
    divider.style.top = `${upper.offsetTop}px`;
    divider.style.height = (lower.offsetTop + lower.offsetHeight - upper.offsetTop) + "px";
  }
}

function updateHorizontalDivider() {
  const upper = document.getElementById("upperJaw");
  const lower = document.getElementById("lowerJaw");
  const horizontal = document.getElementById("horizontal-divider");

  if (upper && lower && horizontal) {
    const containerRect = upper.parentElement.getBoundingClientRect();
    const upperRect = upper.getBoundingClientRect();

    // 歯グリッド左端（8番左）から
    const left = upperRect.left - containerRect.left;

    // 右8番（右側）の要素を取得
    const right8 = [...upper.querySelectorAll(".tooth")].find(t => t.dataset.id === "8" && t.dataset.position === "right");

    let rightEdge;
    if (right8) {
      const r8Rect = right8.getBoundingClientRect();
      rightEdge = r8Rect.right - containerRect.left + 8; // 少し余白追加
    } else {
      rightEdge = upperRect.right - containerRect.left;
    }

    horizontal.style.top = (lower.offsetTop - 10) + "px";
    horizontal.style.left = `${left}px`;
    horizontal.style.width = `${rightEdge - left}px`;
  }
}


</script>

    <!-- この下に「最初の項目→→→→→→→→→→→→→→→→→→→→かかりつけ医とか義歯の使用とか」を続けていきます -->
    <h2 class="section-title">口腔に関する基本情報</h2>
    <table style="font-size: 9.5pt; width: 100%; border-collapse: collapse; line-height: 1.1; margin-left: 0; text-align: left;">
      <tr>
        <td class="label" style="background: #e0e0e0; width: 20%;">現在の歯科受診 かかりつけ医</td>
        <td colspan="4">
          
          <label><input type="radio" name="kakaritsuke" value="あり">あり</label>
          <label><input type="radio" name="kakaritsuke" value="なし">なし</label>
        </td>
      </tr>
      <tr>
        <td class="label" style="background: #e0e0e0;">直近1年間の歯科受診</td>
        <td colspan="4">
          <label><input type="radio" name="shika_lastyear" value="あり">あり</label>
          （最終受診年月：<input type="month" name="lastVisitMonth" style="width: 130px;">）
          <label><input type="radio" name="shika_lastyear" value="なし">なし</label>
        </td>
      </tr>
      <tr>
        <td class="label" style="background: #e0e0e0;">義歯の使用</td>
        <td colspan="4">
          <label><input type="radio" name="gishi" value="あり" onclick="toggleGishiDetail(true)">あり</label>
          （
          <label><input type="radio" name="gishi_detail" value="部分" id="gishi_partial">部分</label>
          <label><input type="radio" name="gishi_detail" value="全部" id="gishi_full">全部</label>
          ）
          <label><input type="radio" name="gishi" value="なし" onclick="toggleGishiDetail(false)">なし</label>
        </td>
      </tr>
      <tr>
        <td class="label" style="background: #e0e0e0;">栄養補給法</td>
        <td colspan="4">
          <label><input type="radio" name="eiyou" value="経口のみ">経口のみ</label>
          <label><input type="radio" name="eiyou" value="一部経口">一部経口</label>
          （<label><input type="checkbox" name="nutrition_detail" value="経腸栄養">経腸栄養</label>
          <label><input type="checkbox" name="nutrition_detail" value="静脈栄養">静脈栄養</label>）
        </td>
      </tr>
      <tr>
        <td class="label" style="background: #f0f0f0;">食事形態</td>
        <td colspan="4">
          <label><input type="radio" name="shokuji" value="常食">常食</label>
          <label><input type="radio" name="shokuji" value="嚥下調整食">嚥下調整食</label>
          （コード：
          <label><input type="radio" name="shokuji_code" value="4">4</label>
          <label><input type="radio" name="shokuji_code" value="3">3</label>
          <label><input type="radio" name="shokuji_code" value="2-2">2-2</label>
          <label><input type="radio" name="shokuji_code" value="2-1">2-1</label>
          <label><input type="radio" name="shokuji_code" value="1j">1j</label>
          <label><input type="radio" name="shokuji_code" value="0t">0t</label>
          <label><input type="radio" name="shokuji_code" value="0j">0j</label>）
        </td>
      </tr>
      <tr>
        <td class="label" style="background: #e0e0e0; width: 30%;">誤嚥性肺炎の発症・既往</td>
        <td colspan="4">
          <label><input type="radio" name="goen" value="あり">あり</label>
          （直近の発症年月：<input type="month" name="goenMonth" style="width: 130px;">）
          <label><input type="radio" name="goen" value="なし">なし</label>
        </td>
      </tr>
      <tr>
        <td class="label">その他特記事項</td>
        <td colspan="4"><input type="text" name="tokkijikou" style="width: 100%;"></td>
      </tr>
    </table>

    <script>
      function toggleGishiDetail(enable) {
        document.getElementById('gishi_partial').disabled = !enable;
        document.getElementById('gishi_full').disabled = !enable;

        if (!enable) {
          document.getElementById('gishi_partial').checked = false;
          document.getElementById('gishi_full').checked = false;
        }
      }
    </script>



    <!-- この下に「1.口腔の健康状態の評価・再評価」を続けていきます -->

    <h2 class="section-title">1. 口腔の健康状態の評価・再評価（口腔に関する問題点等）</h2>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const examDate = document.getElementById('examDate');
        if (examDate) {
          const today = new Date().toISOString().split('T')[0];
          examDate.value = today;
        }
      });
    </script>


    <table style="font-size: 9.5pt; width: 100%; border-collapse: collapse; line-height: 1.1; margin-left: 0; text-align: left;">
      <tr>
        <td class="label" style="width:80px;">実施日</td>
        <td style="width:110px;"><input type="date" id="examDate" /></td>
        <td class="label" style="width:90px;">記入者</td>
        <td style="width:100px;"><input type="text" id="examWriter" /></td>
        <td style="white-space: nowrap;">
          <label><input type="checkbox" name="writerType" value="歯科衛生士" /> 歯科衛生士</label>
          <label><input type="checkbox" name="writerType" value="看護師" /> 看護師</label>
          <label><input type="checkbox" name="writerType" value="言語聴覚士" /> 言語聴覚士</label>
        </td>
      </tr>
    </table>


    <table style="font-size: 9.5pt; table-layout: fixed; width: 100%; margin: 0; line-height: 1.0;">
      <colgroup>
        <col style="width: 13%;">
        <col style="width: 10%;">
        <col style="width: 24%;">
        <col style="width: 13%;">
        <col style="width: 28%;">
      </colgroup>
      <tr>
        <td class="label" rowspan="2" style="text-align: center;">口腔衛生状態</td>
        <td class="label">口臭</td>
        <td><label><input type="radio" name="kou" value="あり">あり</label> <label><input type="radio" name="kou" value="なし">なし</label> <label><input type="radio" name="kou" value="分からない">分からない</label></td>
        <td class="label">義歯の汚れ</td>
        <td><label><input type="radio" name="gishi" value="あり">あり</label> <label><input type="radio" name="gishi" value="なし">なし</label> <label><input type="radio" name="gishi" value="分からない">分からない</label></td>
      </tr>
      <tr>
        <td class="label">歯の汚れ</td>
        <td><label><input type="radio" name="yogore" value="あり">あり</label> <label><input type="radio" name="yogore" value="なし">なし</label> <label><input type="radio" name="yogore" value="分からない">分からない</label></td>
        <td class="label">舌苔</td>
        <td><label><input type="radio" name="zettai" value="あり">あり</label> <label><input type="radio" name="zettai" value="なし">なし</label> <label><input type="radio" name="zettai" value="分からない">分からない</label></td>
      </tr>
    </table>

    <table style="font-size: 9.5pt; table-layout: fixed; width: 100%; margin: 0; line-height: 1.0;">
      <colgroup>
        <col style="width: 13%;">
        <col style="width: 10%;">
        <col style="width: 24%;">
        <col style="width: 13%;">
        <col style="width: 28%;">
      </colgroup>
      <tr>
        <td class="label" rowspan="3" style="text-align: center;">口腔機能の状態</td>
        <td class="label">奥歯の咬合</td>
        <td><label><input type="radio" name="kougou" value="あり">あり</label> <label><input type="radio" name="kougou" value="なし">なし</label> <label><input type="radio" name="kougou" value="分からない">分からない</label></td>
        <td class="label">口腔乾燥</td>
        <td><label><input type="radio" name="dry" value="あり">あり</label> <label><input type="radio" name="dry" value="なし">なし</label> <label><input type="radio" name="dry" value="分からない">分からない</label></td>
      </tr>
      <tr>
        <td class="label">食べこぼし</td>
        <td><label><input type="radio" name="koboshi" value="あり">あり</label> <label><input type="radio" name="koboshi" value="なし">なし</label> <label><input type="radio" name="koboshi" value="分からない">分からない</label></td>
        <td class="label">舌の動きが悪い</td>
        <td><label><input type="radio" name="tongue" value="あり">あり</label> <label><input type="radio" name="tongue" value="なし">なし</label> <label><input type="radio" name="tongue" value="分からない">分からない</label></td>
      </tr>
      <tr>
        <td class="label">むせ</td>
        <td style="white-space: nowrap;"><label><input type="radio" name="muse" value="あり">あり</label> <label><input type="radio" name="muse" value="なし">なし</label> <label><input type="radio" name="muse" value="分からない">分からない</label></td>
        <td class="label">ぶくぶくうがい</td>
        <td style="white-space: nowrap;"><label><input type="radio" name="ugai" value="できる">できる</label> <label><input type="radio" name="ugai" value="できない">できない</label> <label><input type="radio" name="ugai" value="分からない">分からない</label></td>
      </tr>
    </table>

    <table style="font-size: 9.5pt; width: 100%; border-collapse: collapse; line-height: 1.1; margin-left: 0; text-align: left;">
      <tr>
        <td class="label" style="width: 18%;">歯科受診の必要性</td>
        <td>
          <label><input type="radio" name="visit" value="あり">あり</label>
          <label><input type="radio" name="visit" value="なし">なし</label>
          <label><input type="radio" name="visit" value="分からない">分からない</label>
        </td>
      </tr>
    </table>

    <table style="font-size: 9.5pt; width: 100%; border-collapse: collapse; line-height: 1.1; margin-left: 0; text-align: left;">
      <tr>
        <td class="label" style="width: 13%; text-align: center; vertical-align: middle;">特記事項</td>
        <td>
          <label><input type="checkbox" name="tokkijikou1"> 歯（う蝕、修復物脱離等）、義歯（義歯不適合等）、歯周病、口腔粘膜（潰瘍等）の疾患の可能性</label><br>
          <label><input type="checkbox" name="tokkijikou2"> 音声・言語機能に関する疾患の可能性</label><br>
          <label><input type="checkbox" name="tokkijikou3"> その他（ <input type="text" style="width: 60%; display: inline-block;"> ）</label>
        </td>
      </tr>
    </table>


    <!-- この下に「2. 口腔機能改善管理指導計画を続けていきます -->

    <h2 class="section-title">2. 口腔機能改善管理指導計画</h2>
    <table style="font-size: 9.5pt; width: 100%; border-collapse: collapse; line-height: 1.1; margin-left: 0; text-align: left;">
      <tr>
        <td class="label" style="width:80px;">実施日</td>
        <td style="width:110px;"><input type="date" id="examDate" /></td>
        <td class="label" style="width:90px;">計画立案者</td>
        <td style="width:100px;"><input type="text" id="examWriter" /></td>
        <td style="white-space: nowrap;">
          <label><input type="checkbox" name="writerType" value="歯科衛生士" /> 歯科衛生士</label>
          <label><input type="checkbox" name="writerType" value="看護師" /> 看護師</label>
          <label><input type="checkbox" name="writerType" value="言語聴覚士" /> 言語聴覚士</label>
        </td>
      </tr>
      <tr>
      <td></td>
      <td></td>
      <td class="label" style="width:90px; text-align: center;">サービス提供者</td>
      <td style="width:100px;"><input type="text" name="providerName"></td>
      <td style="white-space: nowrap;">
        <label><input type="checkbox" name="provider" value="歯科衛生士"> 歯科衛生士</label>
        <label><input type="checkbox" name="provider" value="看護師"> 看護師</label>
        <label><input type="checkbox" name="provider" value="言語聴覚士"> 言語聴覚士</label>
      </td>
    </tr>
    </table>

    <table style="font-size: 9.5pt; width: 100%; border-collapse: collapse; line-height: 1.1; margin-left: 0; text-align: left;">
      <tr>
        <td class="label" style="width: 80px; text-align: center; vertical-align: middle;">目標</td>
        <td style="text-align: left;"> <!-- ← ここを追加 -->
          <div style="border-bottom: 1px dotted #000; padding-bottom: 4px; margin-bottom: 4px;">
            <label><input type="checkbox" name="goal1"> 歯科疾患</label>
            <label><input type="radio" name="goal1_detail" value="重症化防止"> 重症化防止</label>
            <label><input type="radio" name="goal1_detail" value="維持"> 維持</label>
            <label><input type="radio" name="goal1_detail" value="改善"> 改善</label>
          </div>

          <div style="border-bottom: 1px dotted #000; padding-bottom: 4px; margin-bottom: 4px;">
            <label><input type="checkbox" name="goal2"> 口腔衛生</label>
            <label><input type="radio" name="goal2_detail" value="維持"> 維持</label>
            <label><input type="radio" name="goal2_detail" value="改善"> 改善</label>
            <input type="text" name="goal2_text" placeholder="改善内容" style="width: 60%; display: none;">
          </div>

          <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 8px; border-bottom: 1px dotted #000; padding-bottom: 4px; margin-bottom: 4px;">
            <label><input type="checkbox" name="goal3"> 摂食嚥下等の口腔機能</label>
            <label><input type="radio" name="goal3_detail" value="維持"> 維持</label>
            <label><input type="radio" name="goal3_detail" value="改善"> 改善</label>
            <input type="text" name="goal3_text" placeholder="改善内容" style="flex: 1; min-width: 200px; display: none;">
          </div>

          <div style="border-bottom: 1px dotted #000; padding-bottom: 4px; margin-bottom: 4px;">
            <label><input type="checkbox" name="goal4"> 食形態</label>
            <label><input type="radio" name="goal4_detail" value="維持"> 維持</label>
            <label><input type="radio" name="goal4_detail" value="改善"> 改善</label>
            <input type="text" name="goal4_text" placeholder="改善内容" style="width: 60%; display: none;">
          </div>

          <div style="border-bottom: 1px dotted #000; padding-bottom: 4px; margin-bottom: 4px;">
            <label><input type="checkbox" name="goal5"> 栄養状態</label>
            <label><input type="radio" name="goal5_detail" value="維持"> 維持</label>
            <label><input type="radio" name="goal5_detail" value="改善"> 改善</label>
            <input type="text" name="goal5_text" placeholder="改善内容" style="width: 60%; display: none;">
          </div>

          <div style="border-bottom: 1px dotted #000; padding-bottom: 4px; margin-bottom: 4px;">
            <label><input type="checkbox" name="goal6"> 音声・言語機能</label>
            <label><input type="radio" name="goal6_detail" value="維持"> 維持</label>
            <label><input type="radio" name="goal6_detail" value="改善"> 改善</label>
            <input type="text" name="goal6_text" placeholder="改善内容" style="width: 60%; display: none;">
          </div>

          <div style="border-bottom: 1px dotted #000; padding-bottom: 4px; margin-bottom: 4px;">
            <label><input type="checkbox" name="goal7"> 誤嚥性肺炎の予防</label>
          </div>

          <div>
            <label><input type="checkbox" name="goal8"> その他（ <input type="text" style="width: 60%; display: inline-block;"> ）</label>
          </div>
        </td>
      </tr>
    </table>


    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const goalGroups = [2,3,4,5,6];
        goalGroups.forEach(i => {
          const radios = document.getElementsByName(`goal${i}_detail`);
          const input = document.querySelector(`[name='goal${i}_text']`);
          radios.forEach(r => {
            r.addEventListener('change', () => {
              if (r.value === '改善') {
                input.style.display = 'inline-block';
                input.required = true;
              } else {
                input.style.display = 'none';
                input.required = false;
              }
            });
          });
        });
      });
    </script>


    <table style="font-size: 9.5pt; width: 100%; border-collapse: collapse; margin: 0; line-height: 1.0; text-align: left;">
      <tr>
        <td class="label" style="width: 80px; text-align: center; vertical-align: middle; border: 1px solid #000;">実施内容</td>
        <td style="border: 1px solid #000; padding: 4px 2px; text-align: left;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; row-gap: 0; column-gap: 4px;">
            <label style="border-bottom: 1px dotted #000; padding-bottom: 2px; margin-bottom: 2px;">
              <input type="checkbox" name="content1"> 口腔清掃
            </label>
            <label style="border-bottom: 1px dotted #000; padding-bottom: 2px; margin-bottom: 2px;">
              <input type="checkbox" name="content2" checked> 口腔清掃に関する指導
            </label>
            <label style="border-bottom: 1px dotted #000; padding-bottom: 2px; margin-bottom: 2px;">
              <input type="checkbox" name="content3" checked> 摂食嚥下等の口腔機能に関する指導
            </label>
            <label style="border-bottom: 1px dotted #000; padding-bottom: 2px; margin-bottom: 2px;">
              <input type="checkbox" name="content4"> 音声・言語機能に関する指導
            </label>
            <label>
              <input type="checkbox" name="content5" checked> 誤嚥性肺炎の予防に関する指導
            </label>
            <label>
              <input type="checkbox" name="content6" checked> その他（<input type="text" value="集団口腔体操及び個別指導" style="width: 70%;">）
            </label>
          </div>
        </td>
      </tr>
    </table>



    <!-- この下に「3. 実施記録を続けていきます -->
    <h3 class="section-title">3. 実施記録</h3>
    <table style="font-size: 9.5pt; width: 100%; border-collapse: collapse; line-height: 1.1; margin-left: 0; text-align: left;">
      <tr>
        <td class="label" style="width:80px;">実施日</td>
        <td style="width:110px;"><input type="date" id="examDate" /></td>
        <td class="label" style="width:90px;">サービス提供者</td>
        <td style="width:100px;"><input type="text" id="examWriter" /></td>
        <td style="white-space: nowrap;">
          <label><input type="checkbox" name="writerType" value="歯科衛生士" /> 歯科衛生士</label>
          <label><input type="checkbox" name="writerType" value="看護師" /> 看護師</label>
          <label><input type="checkbox" name="writerType" value="言語聴覚士" /> 言語聴覚士</label>
        </td>
      </tr>
    </table>
    <table style="font-size: 9.5pt; width: 100%; border-collapse: collapse; line-height: 1.1; margin-left: 0; text-align: left;">
      <tr>
        <!-- 左列 -->
        <td style="width: 50%; border: 1px solid #000; vertical-align: top; background: #e0e0e0;">
          <div style="display: grid; grid-template-columns: 1fr; row-gap: 4px;">
            <label style="border-bottom: 1px dotted #000; padding-bottom: 2px;">
              <input type="checkbox" name="record1"> 口腔清掃
            </label>
            <label style="border-bottom: 1px dotted #000; padding-bottom: 2px;">
              <input type="checkbox" name="record2" checked> 摂食嚥下等の口腔機能に関する指導
            </label>
            <label>
              <input type="checkbox" name="record3" checked> 誤嚥性肺炎の予防に関する指導
            </label>
          </div>
        </td>

        <!-- 右列 -->
        <td style="width: 50%; border: 1px solid #000; vertical-align: top; background: #f8f8f8;">
          <div style="display: grid; grid-template-columns: 1fr; row-gap: 4px;">
            <label style="border-bottom: 1px dotted #000; padding-bottom: 2px;">
              <input type="checkbox" name="record4" checked> 口腔清掃に関する指導
            </label>
            <label style="border-bottom: 1px dotted #000; padding-bottom: 2px;">
              <input type="checkbox" name="record5"> 音声・言語機能に関する指導
            </label>
            <label>
              <input type="checkbox" name="record6" checked> その他（<input type="text" name="record6_text" value="集団口腔体操及び個別指導" style="width: 70%;">）
            </label>
          </div>
        </td>
      </tr>
    </table>






    <h4>RSSTとオーラルディアドコキネシス</h4>


    <div class="print-wrapper" style="display: flex; align-items: flex-start; gap: 1rem;">
      <!-- 左の表 -->
      <div class="left-box" style="flex: 1;">
        <table style="table-layout: auto; border-collapse: collapse; font-size: 9.5pt; font-family: sans-serif; text-align: center; width: 100%;">
          <thead>
            <tr style="height: 28px;">
              <th style="text-align: left;">※RSST→30秒間の咽頭挙上の回数</th>
              <th id="header1">1回目</th>
              <th id="header2">2回目</th>
              <th id="header3">3回目</th>
            </tr>
          </thead>
          <tbody>
            <tr style="height: 28px;">
              <th style="text-align: left;">RSST（正常値3回以上）</th>
              <td id="rsst1"></td><td id="rsst2"></td><td id="rsst3"></td>
            </tr>
            <tr style="height: 28px;">
              <th style="text-align: left;">パ（回/秒） 男4.4～7.2 女4.2～7.2</th>
              <td id="pa1"></td><td id="pa2"></td><td id="pa3"></td>
            </tr>
            <tr style="height: 28px;">
              <th style="text-align: left;">タ（回/秒） 男4.2～7.0 女4.4～7.2</th>
              <td id="ta1"></td><td id="ta2"></td><td id="ta3"></td>
            </tr>
            <tr style="height: 28px;">
              <th style="text-align: left;">カ（回/秒） 男4.0～6.6 女4.1～6.7</th>
              <td id="ka1"></td><td id="ka2"></td><td id="ka3"></td>
            </tr>
          </tbody>
        </table>

        <!-- ボタン -->
        <div style="text-align: left; margin-top: 0.8rem;">
          <button class="btn" onclick="openModal()">記録する</button>
          <button class="btn" onclick="editLast()">記録訂正</button>
        </div>
      </div>

      <!-- 右の同意欄 -->
      <div class="consent-box" style="
        font-size: 9.5pt;
        border: 1px solid black;
        padding: 6px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        text-align: center;
        min-width: 180px;
        margin-top: 0;
      ">
        <strong>説明日・同意日</strong>
        <div style="margin-top: 4px;">令和　　　年　　　月　　　日</div>
        <div style="margin-top: 6px;">
          利用者同意書サイン（本人）<br><br>
          <div class="signature-space" style="border-bottom: 1px solid black; height: 40px; margin-top: 4px;"></div>
        </div>
      </div>
    </div>



    <!-- モーダル -->
    <div class="modal" id="rsstModal">
      <div class="modal-content">
        <h3>RSST・パ・タ・カ 記録入力</h3>
        <div class="input-block">
          <div class="label-text">RSST（回/30秒）</div>
          <input type="number" id="rsstInput" class="large-input" />
        </div>
        <div class="input-block">
          <div class="label-text">パ（回）</div>
          <input type="number" id="paInput" class="large-input" />
        </div>
        <div class="input-block">
          <div class="label-text">タ（回）</div>
          <input type="number" id="taInput" class="large-input" />
        </div>
        <div class="input-block">
          <div class="label-text">カ（回）</div>
          <input type="number" id="kaInput" class="large-input" />
        </div>
        <button class="btn" onclick="submitModal()">記録する</button>
        <button class="btn" onclick="closeModal()">キャンセル</button>
      </div>
    </div>

    <script>
      let recordCount = 0;

      function openModal() {
        document.getElementById("rsstModal").style.display = "flex";
        setTimeout(() => document.getElementById("rsstInput").focus(), 100);
      }

      function closeModal() {
        document.getElementById("rsstModal").style.display = "none";
        ["rsstInput", "paInput", "taInput", "kaInput"].forEach(id => {
          document.getElementById(id).value = "";
        });
        delete window.__editRSSTIndex;  // 訂正モードをリセット
      }

      function submitModal() {
        const rsst = document.getElementById("rsstInput").value;
        const pa = (parseInt(document.getElementById("paInput").value) / 10).toFixed(1);
        const ta = (parseInt(document.getElementById("taInput").value) / 10).toFixed(1);
        const ka = (parseInt(document.getElementById("kaInput").value) / 10).toFixed(1);

        if (!rsst || isNaN(pa) || isNaN(ta) || isNaN(ka)) {
          alert("すべての項目を正しく入力してください");
          return;
        }

        // 訂正時の処理
        if (window.__editRSSTIndex) {
          const i = window.__editRSSTIndex;

          // 記録を上書き
          document.getElementById(`rsst${i}`).textContent = rsst;
          document.getElementById(`pa${i}`).textContent = pa;
          document.getElementById(`ta${i}`).textContent = ta;
          document.getElementById(`ka${i}`).textContent = ka;

          // ヘッダーの更新（回数を元のまま維持）
          updateHeaders(recordCount);

          // 訂正後、インデックスをリセット
          delete window.__editRSSTIndex;
          closeModal();
          return;
        }

        // 新規記録の場合
        recordCount++;

        let rsstArr = [document.getElementById("rsst1").textContent, document.getElementById("rsst2").textContent, document.getElementById("rsst3").textContent];
        let paArr = [document.getElementById("pa1").textContent, document.getElementById("pa2").textContent, document.getElementById("pa3").textContent];
        let taArr = [document.getElementById("ta1").textContent, document.getElementById("ta2").textContent, document.getElementById("ta3").textContent];
        let kaArr = [document.getElementById("ka1").textContent, document.getElementById("ka2").textContent, document.getElementById("ka3").textContent];

        // 空いているセルを見つけて新規記録
        if (rsstArr.includes("")) {
          const i = rsstArr.findIndex(v => v === "") + 1;
          document.getElementById(`rsst${i}`).textContent = rsst;
          document.getElementById(`pa${i}`).textContent = pa;
          document.getElementById(`ta${i}`).textContent = ta;
          document.getElementById(`ka${i}`).textContent = ka;
        } else {
          // すべて埋まっている場合、データをずらす
          rsstArr = [rsstArr[1], rsstArr[2], rsst];
          paArr = [paArr[1], paArr[2], pa];
          taArr = [taArr[1], taArr[2], ta];
          kaArr = [kaArr[1], kaArr[2], ka];
          for (let i = 0; i < 3; i++) {
            document.getElementById(`rsst${i + 1}`).textContent = rsstArr[i];
            document.getElementById(`pa${i + 1}`).textContent = paArr[i];
            document.getElementById(`ta${i + 1}`).textContent = taArr[i];
            document.getElementById(`ka${i + 1}`).textContent = kaArr[i];
          }
        }

        // ヘッダーの更新（新規レコードに基づく）
        updateHeaders(recordCount);
        closeModal();
      }

      function editLast() {
        // 訂正対象の記録インデックスを検索
        const i = [3, 2, 1].find(i => document.getElementById(`rsst${i}`).textContent);
        if (!i) return alert("記録がありません");

        // モーダルに既存データをセット
        document.getElementById("rsstInput").value = document.getElementById(`rsst${i}`).textContent;
        document.getElementById("paInput").value = parseFloat(document.getElementById(`pa${i}`).textContent) * 10;
        document.getElementById("taInput").value = parseFloat(document.getElementById(`ta${i}`).textContent) * 10;
        document.getElementById("kaInput").value = parseFloat(document.getElementById(`ka${i}`).textContent) * 10;

        // 編集モードに入る
        openModal();

        // 訂正対象インデックスを保持
        window.__editRSSTIndex = i;
      }

      // ヘッダー更新のロジック（訂正後も更新しないように）
      function updateHeaders(recordCount) {
        const start = Math.max(1, recordCount - 2);
        document.getElementById("header1").textContent = `${start}回目`;
        document.getElementById("header2").textContent = `${start + 1}回目`;
        document.getElementById("header3").textContent = `${start + 2}回目`;
      }
    </script>
  </div>
</body>
</html>
