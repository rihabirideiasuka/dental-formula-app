<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å£è…”è¨˜éŒ²ã‚¢ãƒ—ãƒª</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }
    .tooth-grid {
      display: grid;
      grid-template-columns: repeat(16, 40px);
      grid-gap: 4px;
      justify-content: center;
      margin: 0;
      padding: 0;
      position: relative;
    }
    .tooth {
      width: 40px;
      height: 40px;
      border: 1px solid #999;
      margin: 2px;
      position: relative;
      text-align: center;
      box-sizing: border-box;
    }
    .tooth .number {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.2em;
      font-weight: bold;
      color: #555;
      z-index: 1;
    }
    .tooth .state {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.2em;
      font-weight: bold;
      z-index: 2;
    }
    .label-top, .label-bottom {
      font-size: 0.9em;
      font-weight: bold;
      color: blue;
      position: absolute;
      width: 100%;
      left: 0;
      text-align: center;
    }
    .label-top { top: -1.2em; }
    .label-bottom { bottom: -1.2em; }
    .modal {
      display: none;
      position: fixed;
      background: rgba(0,0,0,0.6);
      top: 0; left: 0; right: 0; bottom: 0;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 1rem;
      border-radius: 8px;
    }
    .modal-content button {
      font-size: 1.5em;
      padding: 0.5em 1em;
      margin: 0.3em;
    }
    #lowerJaw {
      margin-top: 40px;
      position: relative;
    }
    #lowerJaw::before {
      content: "";
      position: absolute;
      top: -20px;
      left: 0;
      right: 0;
      height: 2px;
      background: black;
    }
    .center-divider {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: black;
      left: calc(50% + 1px); /* â† å°‘ã—å³ã«ãšã‚‰ã—ãŸ */
      z-index: 0;
    }
  </style>
</head>
<body>

<h2>å£è…”çŠ¶æ…‹è¨˜éŒ²</h2>
<label>åˆ©ç”¨è€…åï¼š<input type="text" id="name" /></label>

<!-- ğŸ”½ Bréƒ¨åˆ†è¿½åŠ ï¼ -->
<button onclick="toggleBrMode()">Brãƒ¢ãƒ¼ãƒ‰ã‚’ON</button>
<p id="brStatus">Bræœªé¸æŠ</p>
<!-- ğŸ”¼ ã“ã“ã¾ã§ -->

<div style="position: relative;">
  <div class="tooth-grid" id="upperJaw"></div>
  <div class="center-divider"></div>
  <div class="tooth-grid" id="lowerJaw"></div>
</div>

<div class="modal" id="modal">
  <div class="modal-content">
    <p>æ­¯ã®çŠ¶æ…‹ã‚’é¸æŠï¼š</p>
    <button onclick="setState('â—‹')">â—‹</button>
    <button onclick="setState('Ã—')">Ã—</button>
    <button onclick="setState('ï¼')">ï¼</button>
    <button onclick="setState('')">æ¶ˆå»</button>
    <p>è£œåŠ©ãƒ©ãƒ™ãƒ«ï¼š</p>
    <button onclick="setLabel('Cr')">Cr</button>
    <button onclick="setLabel('In')">In</button>
    <button onclick="setLabel('Fck')">Fck</button>
    <button onclick="setLabel('IMPL')">IMPL</button>
    <button onclick="setLabel('æ­»æ ¹')">æ­»æ ¹</button>
    <button onclick="setLabel('æ®‹æ ¹')">æ®‹æ ¹</button>
    <button onclick="setLabel('C')">C</button>
    <button onclick="setLabel('C4')">C4</button>
    <button onclick="setLabel('')">ãƒ©ãƒ™ãƒ«æ¶ˆå»</button>
  </div>
</div>

<script>
  const upperJaw = document.getElementById("upperJaw");
  const lowerJaw = document.getElementById("lowerJaw");
  const modal = document.getElementById("modal");
  let selectedTooth = null;

  function createTooth(id, jaw) {
    const div = document.createElement("div");
    div.className = "tooth";
    div.dataset.id = id;
    div.dataset.jaw = jaw;

    const numberSpan = document.createElement("span");
    numberSpan.className = "number";
    numberSpan.textContent = id;

    const stateSpan = document.createElement("span");
    stateSpan.className = "state";
    stateSpan.textContent = "";

    const topLabel = document.createElement("div");
    topLabel.className = "label-top";
    const bottomLabel = document.createElement("div");
    bottomLabel.className = "label-bottom";

    div.appendChild(numberSpan);
    div.appendChild(stateSpan);
    div.appendChild(topLabel);
    div.appendChild(bottomLabel);

    div.onclick = () => {
      selectedTooth = div;
      modal.style.display = "flex";
    };

    return div;
  }

  const left = [8, 7, 6, 5, 4, 3, 2, 1];
  const right = [1, 2, 3, 4, 5, 6, 7, 8];

  [...left, ...right].forEach(num => {
    upperJaw.appendChild(createTooth(num, "upper"));
  });

  [...left, ...right].forEach(num => {
    lowerJaw.appendChild(createTooth(num, "lower"));
  });

  function setState(symbol) {
    if (!selectedTooth) return;
    selectedTooth.querySelector(".state").textContent = symbol;
    modal.style.display = "none";
  }

  function setLabel(label) {
    if (!selectedTooth) return;
    const jaw = selectedTooth.dataset.jaw;
    if (jaw === "upper") {
      selectedTooth.querySelector(".label-top").textContent = label;
    } else {
      selectedTooth.querySelector(".label-bottom").textContent = label;
    }
    modal.style.display = "none";
  }

  modal.onclick = (e) => {
    if (e.target === modal) modal.style.display = "none";
  };

  // ...ï¼ˆBrã«é–¢ã™ã‚‹éƒ¨åˆ†ã‚’è¿½åŠ ï¼‰

  let brMode = false;
  let brStart = null;
  let brEnd = null;
  const selectedBrRanges = [];

  function toggleBrMode() {
    brMode = !brMode;
    brStart = null;
    brEnd = null;
    document.getElementById("brStatus").textContent = brMode
      ? "Brãƒ¢ãƒ¼ãƒ‰ï¼šé–‹å§‹ã®æ­¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„"
      : "Brãƒ¢ãƒ¼ãƒ‰OFF";
  }

  function handleToothClickForBr(toothDiv) {
    if (!brStart) {
      brStart = toothDiv;
      document.getElementById("brStatus").textContent = "Brãƒ¢ãƒ¼ãƒ‰ï¼šçµ‚äº†ã®æ­¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„";
    } else {
      brEnd = toothDiv;
      const startId = brStart.dataset.id;
      const endId = brEnd.dataset.id;
      const jaw = brEnd.dataset.jaw;

      selectedBrRanges.push({ start: startId, end: endId, jaw });
      document.getElementById("brStatus").textContent =
        `Bré¸æŠå®Œäº†ï¼š${startId}ç•ªã€œ${endId}ç•ªï¼ˆ${jaw === "upper" ? "ä¸Šé¡" : "ä¸‹é¡"}ï¼‰`;

      brMode = false;
      brStart = null;
      brEnd = null;
    }
  }

  // div.onclick ã‚’ç½®ãæ›ãˆã¾ã™ï¼š
  function createTooth(id, jaw) {
    const div = document.createElement("div");
    div.className = "tooth";
    div.dataset.id = id;
    div.dataset.jaw = jaw;

    const numberSpan = document.createElement("span");
    numberSpan.className = "number";
    numberSpan.textContent = id;

    const stateSpan = document.createElement("span");
    stateSpan.className = "state";
    stateSpan.textContent = "";

    const topLabel = document.createElement("div");
    topLabel.className = "label-top";
    const bottomLabel = document.createElement("div");
    bottomLabel.className = "label-bottom";

    div.appendChild(numberSpan);
    div.appendChild(stateSpan);
    div.appendChild(topLabel);
    div.appendChild(bottomLabel);

    div.onclick = () => {
      if (brMode) {
        handleToothClickForBr(div);
      } else {
        selectedTooth = div;
        modal.style.display = "flex";
      }
    };

    return div;
  }

function submitData() {
  const userName = document.getElementById("name").value.trim();
  if (!userName) {
    alert("åˆ©ç”¨è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
    return;
  }

  // âœ… allTeeth ã‚’ã“ã“ã§å®šç¾©ï¼ˆé‡è¦ï¼ï¼‰
  const allTeeth = document.querySelectorAll(".tooth");

   // æ­¯ã®çŠ¶æ…‹ãƒ‡ãƒ¼ã‚¿åé›†
  const teeth = Array.from(allTeeth).map(div => {
    const state = div.querySelector(".state")?.textContent || "";
    const jaw = div.dataset.jaw;
    const label = jaw === "upper"
      ? div.querySelector(".label-top")?.textContent || ""
      : div.querySelector(".label-bottom")?.textContent || "";

    return {
      number: div.dataset.id,
      jaw: jaw,
      state: state.trim(),
      label: label.trim()
    };
  }).filter(tooth => tooth.state || tooth.label);  // // â† ç©ºã§ãªã„ã‚‚ã®ã ã‘æ®‹ã™  å…¥åŠ›ãŒã‚ã‚‹æ­¯ã ã‘é€ä¿¡

  // ãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰
  const data = {
    name: userName,
    record: "â‘ ", // å›ºå®š or é¸æŠã§å¤‰æ›´å¯
    teeth: teeth,
    brData: selectedBrRanges
  };

  console.log("é€ä¿¡ãƒ‡ãƒ¼ã‚¿:", data);


  fetch("https://script.google.com/macros/s/AKfycbzOQz96QsZx0QFbofXd6VdosJKAYNXVTi2bqMOdJKsS6gEv7u7pyj9odgRWtF39wBQh2A/exec", {
    method: "POST",
    body: JSON.stringify(data) // â† Content-Type ã‚’æŒ‡å®šã—ãªã„
  })
  .then(res => res.text())
  .then(text => {
    console.log("ä¿å­˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹:", text);
    document.getElementById("saveStatus").textContent = text;
  })
  .catch(err => {
    console.error("ä¿å­˜å¤±æ•—:", err);
    alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
  });
}

</script>

  <!-- ğŸ”½ ä¿å­˜ãƒœã‚¿ãƒ³ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã“ã“ã«è¿½åŠ  -->
  <button onclick="submitData()">ä¿å­˜</button>
  <p id="saveStatus"></p>
  <!-- ğŸ”¼ è¿½åŠ ã“ã“ã¾ã§ -->

</body>
</html>
