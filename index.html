<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>口腔記録アプリ</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }
    .tooth-grid {
      display: grid;
      grid-template-columns: repeat(16, 40px);
      grid-gap: 4px;
      justify-content: center;
      position: relative;
    }
    .tooth {
      width: 40px;
      height: 40px;
      border: 1px solid #999;
      margin: 2px;
      position: relative;
      text-align: center;
      box-sizing: border-box;
    }
    .tooth .number {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.2em;
      font-weight: bold;
      color: #555;
      z-index: 1;
    }
    .tooth .state {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.2em;
      font-weight: bold;
      z-index: 2;
    }
    .label-top, .label-bottom {
      font-size: 0.9em;
      font-weight: bold;
      color: blue;
      position: absolute;
      width: 100%;
      left: 0;
      text-align: center;
    }
    .label-top { top: -1.2em; }
    .label-bottom { bottom: -1.2em; }
    .modal {
      display: none;
      position: fixed;
      background: rgba(0,0,0,0.6);
      top: 0; left: 0; right: 0; bottom: 0;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 1rem;
      border-radius: 8px;
    }
    .modal-content button {
      font-size: 1.5em;
      padding: 0.5em 1em;
      margin: 0.3em;
    }
    #lowerJaw {
      margin-top: 40px;
      position: relative;
    }
    #lowerJaw::before {
      content: "";
      position: absolute;
      top: -20px;
      left: 0;
      right: 0;
      height: 2px;
      background: black;
    }
    .center-divider {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 2px;
      background-color: black;
      left: calc(50% + 1px);
      z-index: 0;
    }

    .choice-group {
      margin-bottom: 1em;
    }
    .choice-label {
      display: block;
      margin-top: 0.5em;
      font-weight: bold;
    }
    .choice-group button {
      margin: 2px;
      padding: 0.5em 1em;
      border: 1px solid #aaa;
      border-radius: 6px;
      background: #f9f9f9;
      cursor: pointer;
    }
    .choice-group button.selected {
      background-color: #4CAF50;
      color: white;
      border-color: #4CAF50;
    }
  </style>

</head>
<body>
<h2>口腔状態記録</h2>
<label>利用者名：<input type="text" id="name" /></label>
<button onclick="toggleBrMode()">BrモードをON</button>
<p id="brStatus">Br未選択</p>
<div style="position: relative;">
  <div class="tooth-grid" id="upperJaw"></div>
  <div class="center-divider"></div>
  <div class="tooth-grid" id="lowerJaw"></div>
</div>
<div class="modal" id="modal">
  <div class="modal-content">
    <p>歯の状態を選択：</p>
    <button onclick="setState('○')">○</button>
    <button onclick="setState('×')">×</button>
    <button onclick="setState('／')">／</button>
    <button onclick="setState('')">消去</button>
    <p>補助ラベル：</p>
    <button onclick="setLabel('Cr')">Cr</button>
    <button onclick="setLabel('In')">In</button>
    <button onclick="setLabel('Fck')">Fck</button>
    <button onclick="setLabel('IMPL')">IMPL</button>
    <button onclick="setLabel('死根')">死根</button>
    <button onclick="setLabel('残根')">残根</button>
    <button onclick="setLabel('C')">C</button>
    <button onclick="setLabel('C4')">C4</button>
    <button onclick="setLabel('')">ラベル消去</button>
  </div>
</div>
<!-- 上記の巻き微算の歯式コードの続き -->
<!-- 0. 事前情報入力フォーム -->
<section id="preliminary-info" style="margin-top: 2rem;">
  <h3>事前情報入力</h3>

  <!-- 歯科受診 -->
  <p>
    現在の歯科受診（かかりつけ医）:<br>
    <label><input type="radio" name="dentist-current" value="あり"> あり</label>
    <label><input type="radio" name="dentist-current" value="なし"> なし</label>
  </p>

  <!-- 直近1年間の受診 -->
  <p>
    直近1年間の歯科受診:<br>
    <label><input type="radio" name="dentist-year" value="あり" onchange="toggleLastVisitDate(true)"> あり</label>
    <label><input type="radio" name="dentist-year" value="なし" onchange="toggleLastVisitDate(false)"> なし</label>
    <div id="last-visit-date" style="display:none; margin-top: 0.5rem;">
      最終受診年月: <input type="month" id="last-visit-month">
    </div>
  </p>

  <!-- 義歯の使用 -->
  <p>
    義歯の使用:<br>
    <label><input type="radio" name="denture" value="あり" onchange="toggleDentureType(true)"> あり</label>
    <label><input type="radio" name="denture" value="なし" onchange="toggleDentureType(false)"> なし</label>
    <div id="denture-type" style="display:none; margin-top: 0.5rem;">
      <label><input type="radio" name="denture-type" value="部分"> 部分</label>
      <label><input type="radio" name="denture-type" value="全部"> 全部</label>
    </div>
  </p>

  <!-- 栄養補給法 -->
  <p>
    栄養補給法:<br>
    <label><input type="radio" name="nutrition" value="経口のみ" onchange="toggleNutritionSub(false)"> 経口のみ</label>
    <label><input type="radio" name="nutrition" value="一部経口" onchange="toggleNutritionSub(true)"> 一部経口</label>
    <div id="nutrition-sub" style="display:none; margin-top: 0.5rem;">
      <label><input type="checkbox" name="nutrition-sub" value="経腸栄養"> 経腸栄養</label>
      <label><input type="checkbox" name="nutrition-sub" value="静脈栄養"> 静脈栄養</label>
    </div>
  </p>

  <!-- 食事形態 -->
  <p>
    食事形態:<br>
    <label><input type="radio" name="meal" value="常食" onchange="toggleMealCode(false)"> 常食</label>
    <label><input type="radio" name="meal" value="嚥下調整食" onchange="toggleMealCode(true)"> 嚥下調整食</label>
    <div id="meal-code" style="display:none; margin-top: 0.5rem;">
      コード:
      <select id="meal-code-select">
        <option value="4">4</option>
        <option value="3">3</option>
        <option value="2-2">2-2</option>
        <option value="2-1">2-1</option>
        <option value="1j">1j</option>
        <option value="0t">0t</option>
        <option value="0j">0j</option>
      </select>
    </div>
  </p>

  <!-- 誤嚥性肺炎 -->
  <p>
    誤嚥性肺炎の発症・既往:<br>
    <label><input type="radio" name="pneumonia" value="あり" onchange="togglePneumoniaDate(true)"> あり</label>
    <label><input type="radio" name="pneumonia" value="なし" onchange="togglePneumoniaDate(false)"> なし</label>
    <div id="pneumonia-date" style="display:none; margin-top: 0.5rem;">
      直近の発症年月: <input type="month" id="pneumonia-month">
    </div>
  </p>

  <!-- 特記事項 -->
  <p>
    その他特記事項:<br>
    <input type="text" id="other-notes" style="width: 95%;">
  </p>
</section>

<script>
function toggleLastVisitDate(show) {
  document.getElementById('last-visit-date').style.display = show ? 'block' : 'none';
}
function toggleDentureType(show) {
  document.getElementById('denture-type').style.display = show ? 'block' : 'none';
}
function toggleNutritionSub(show) {
  document.getElementById('nutrition-sub').style.display = show ? 'block' : 'none';
}
function toggleMealCode(show) {
  document.getElementById('meal-code').style.display = show ? 'block' : 'none';
}
function togglePneumoniaDate(show) {
  document.getElementById('pneumonia-date').style.display = show ? 'block' : 'none';
}
</script>


<!-- 1 口腔の健康状態の評価・再評価 -->
<section id="oral-health-section" style="margin-top: 2rem;">
  <h3>1 口腔の健康状態の評価・再評価</h3>

  <label>実施日: <input type="date" id="eval-date"></label><br><br>

  <label>記入者:
    <select id="eval-author">
      <option value="山田　太郎">山田　太郎</option>
      <option value="坂口　建治">坂口　建治</option>
      <option value="本郷　彩">本郷　彩</option>
    </select>
  </label><br>

  <label>資格:
    <select id="eval-qualification">
      <option value="歯科衛生士">歯科衛生士</option>
      <option value="看護師">看護師</option>
      <option value="言語聴覚士">言語聴覚士</option>
    </select>
  </label><br><br>

  <strong>口腔衛生状態</strong><br>
  <div class="choice-group" data-group="口臭">
    <span class="choice-label">口臭:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="歯の汚れ">
    <span class="choice-label">歯の汚れ:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="義歯の汚れ">
    <span class="choice-label">義歯の汚れ:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="舌苔">
    <span class="choice-label">舌苔:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <strong>口腔機能の状態</strong><br>

  <div class="choice-group" data-group="奥歯の咬合">
    <span class="choice-label">奥歯の咬合:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="食べこぼし">
    <span class="choice-label">食べこぼし:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="むせ">
    <span class="choice-label">むせ:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="口腔乾燥">
    <span class="choice-label">口腔乾燥:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="舌の動きが悪い">
    <span class="choice-label">舌の動きが悪い:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="ぶくぶくうがい">
    <span class="choice-label">ぶくぶくうがい:</span>
    <button onclick="selectExclusive(this)">できる</button>
    <button onclick="selectExclusive(this)">できない</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="歯科受診の必要性">
    <span class="choice-label">歯科受診の必要性:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <br><strong>特記事項</strong><br>
  <div class="choice-group">
    <button onclick="selectNote(this)">歯（う蝕、修復物脱離等）、義歯、歯周病、口腔粘膜の疾患の可能性</button>
    <button onclick="selectNote(this)">音声・言語機能に関する疾患の可能性</button>
    <button onclick="selectNote(this)">その他</button>
    <input type="text" id="otherNote" placeholder="その他の内容を記入" style="display:none; width:90%; margin-top: 5px;">
  </div>
</section>

<script>
  // デフォルト日付
  document.getElementById("eval-date").value = new Date().toISOString().split('T')[0];

  function selectExclusive(btn) {
    const parent = btn.parentElement;
    Array.from(parent.querySelectorAll("button")).forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
  }

  function selectNote(btn) {
    const parent = btn.parentElement;
    Array.from(parent.querySelectorAll("button")).forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");

    const isOther = btn.textContent.includes("その他");
    document.getElementById("otherNote").style.display = isOther ? "inline" : "none";
  }
</script>


<!-- ※ 2. 指導計画 セクション -->
<section id="plan-section" style="margin-top: 2rem;">
  <h3>2. 口腔機能改善管理指導計画</h3>
  <label>作成日: <input type="date" id="plan-date"></label>
  <br>
  <label>作成者:
    <select id="plan-author">
      <option value="歯科衛生士">歯科衛生士</option>
      <option value="看護師">看護師</option>
      <option value="言語聴覚士">言語聴覚士</option>
    </select>
  </label>
  <br>
  <div>
    <label><input type="checkbox" name="plan-goal" value="歯科疾患"> 歯科疾患</label>
    <label><input type="checkbox" name="plan-goal" value="口腔衛生"> 口腔衛生</label>
    <label><input type="checkbox" name="plan-goal" value="咀嚼機能"> 咀嚼機能</label>
    <label><input type="checkbox" name="plan-goal" value="栄養状態"> 栄養状態</label>
    <label><input type="checkbox" name="plan-goal" value="言語機能"> 言語機能</label>
  </div>
  <label>その他: <input type="text" id="plan-other" style="width: 90%;"></label>
</section>

<!-- ※ 3. 実施記録 セクション -->
<section id="record-section" style="margin-top: 2rem;">
  <h3>3. 実施記録</h3>
  <label>実施年月日: <input type="date" id="record-date"></label>
  <br>
  <label>サービス提供者: <input type="text" id="provider"></label>
  <br>
  <div>
    <label><input type="checkbox" name="implementation" value="口腔清掃"> 口腔清掃</label>
    <label><input type="checkbox" name="implementation" value="摂食嚥下"> 摂食嚥下に関する指導</label>
    <label><input type="checkbox" name="implementation" value="言語機能"> 言語機能に関する指導</label>
    <label><input type="checkbox" name="implementation" value="誤嚥性肺炎"> 誤嚥性肺炎予防</label>
    <label><input type="checkbox" name="implementation" value="その他"> その他</label>
  </div>
  <label>その他の内容: <input type="text" id="record-note" style="width: 90%;"></label>
  <br>
  <label>RSST回数（1回目）: <input type="text" id="rsst1" size="5"></label>
  <label>RSST回数（2回目）: <input type="text" id="rsst2" size="5"></label>
  <label>RSST回数（3回目）: <input type="text" id="rsst3" size="5"></label>
</section>




<script>
  const upperJaw = document.getElementById("upperJaw");
  const lowerJaw = document.getElementById("lowerJaw");
  const modal = document.getElementById("modal");
  let selectedTooth = null;

  const left = [8, 7, 6, 5, 4, 3, 2, 1];
  const right = [1, 2, 3, 4, 5, 6, 7, 8];

  function createTooth(id, jaw, position) {
    const div = document.createElement("div");
    div.className = "tooth";
    div.dataset.id = id;
    div.dataset.jaw = jaw;
    div.dataset.position = position;

    const numberSpan = document.createElement("span");
    numberSpan.className = "number";
    numberSpan.textContent = id;

    const stateSpan = document.createElement("span");
    stateSpan.className = "state";
    stateSpan.textContent = "";

    const topLabel = document.createElement("div");
    topLabel.className = "label-top";
    const bottomLabel = document.createElement("div");
    bottomLabel.className = "label-bottom";

    div.appendChild(numberSpan);
    div.appendChild(stateSpan);
    div.appendChild(topLabel);
    div.appendChild(bottomLabel);

    div.onclick = () => {
      if (brMode) {
        handleToothClickForBr(div);
      } else {
        selectedTooth = div;
        modal.style.display = "flex";
      }
    };
    return div;
  }

  left.concat(right).forEach((num, i) => upperJaw.appendChild(createTooth(num, "upper", i < 8 ? "left" : "right")));
  left.concat(right).forEach((num, i) => lowerJaw.appendChild(createTooth(num, "lower", i < 8 ? "left" : "right")));

  function setState(symbol) {
    if (!selectedTooth) return;
    selectedTooth.querySelector(".state").textContent = symbol;
    modal.style.display = "none";
  }

  function setLabel(label) {
    if (!selectedTooth) return;
    const jaw = selectedTooth.dataset.jaw;
    if (jaw === "upper") {
      selectedTooth.querySelector(".label-top").textContent = label;
    } else {
      selectedTooth.querySelector(".label-bottom").textContent = label;
    }
    modal.style.display = "none";
  }

  modal.onclick = e => {
    if (e.target === modal) modal.style.display = "none";
  };

  let brMode = false;
  let brStart = null;
  let brEnd = null;
  const selectedBrRanges = [];

  function toggleBrMode() {
    brMode = !brMode;
    brStart = null;
    brEnd = null;
    document.getElementById("brStatus").textContent = brMode
      ? "Brモード：開始の歯をクリックしてください"
      : "BrモードOFF";
  }

  function handleToothClickForBr(div) {
    if (!brStart) {
      brStart = div;
      document.getElementById("brStatus").textContent = "Brモード：終了の歯をクリックしてください";
    } else {
      brEnd = div;
      selectedBrRanges.push({
        start: brStart.dataset.id,
        end: brEnd.dataset.id,
        jaw: brEnd.dataset.jaw,
        position: brEnd.dataset.position
      });
      document.getElementById("brStatus").textContent = `Br選択完了：${brStart.dataset.id}〜${brEnd.dataset.id}`;
      brMode = false;
      brStart = null;
      brEnd = null;
    }
  }

  function submitData() {
    const userName = document.getElementById("name").value.trim();
    if (!userName) return alert("利用者名を入力してください");

    const allTeeth = document.querySelectorAll(".tooth");
    const teeth = Array.from(allTeeth).map(div => {
      const state = div.querySelector(".state").textContent;
      const jaw = div.dataset.jaw;
      const position = div.dataset.position;
      const label = jaw === "upper"
        ? div.querySelector(".label-top").textContent
        : div.querySelector(".label-bottom").textContent;
      return {
        number: div.dataset.id,
        jaw,
        position,
        state: state.trim(),
        label: label.trim()
      };
    }).filter(t => t.state || t.label);

    const data = {
      name: userName,
      record: "①",
      teeth,
      brData: selectedBrRanges
    };

    console.log("送信データ:", data);

    fetch("https://script.google.com/macros/s/AKfycbyTHDv1zLlBbnS61BYPCd1-rbaYPRo41aCQe5C_WzKYfi5I--dy32SrZCXdMxgQ1TAxyQ/exec", {
      method: "POST",
      body: JSON.stringify(data)
    })
    .then(res => res.text())
    .then(text => {
      console.log("保存レスポンス:", text);
      document.getElementById("saveStatus").textContent = text;
    })
    .catch(err => {
      console.error("保存失敗:", err);
      alert("保存に失敗しました");
    });
  }
</script>
<button onclick="submitData()">保存</button>
<p id="saveStatus"></p>
</body>
</html>
