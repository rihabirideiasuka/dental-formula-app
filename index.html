<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>口腔記録フォーム</title>
  <style>
    @page { size: A4; margin: 3mm 4mm; }
    html, body {
      margin: 0;
      padding: 0;
      width: 210mm;
      min-height: 100vh;          /* 表示領域に対応（スクロール可能） */
      height: auto;               /* 高さは内容に応じて伸ばす */
      font-family: "Arial", sans-serif;
      font-size: 7pt;
      box-sizing: border-box;
      overflow-x: hidden;
      overflow-y: auto;           /* 縦スクロール可能にする */
    }

    .container {
      padding: 4mm;
      /* border: 1px solid #000; ← この行を削除またはコメントアウト */
      box-sizing: border-box;
      height: auto;               /* 高さを内容に合わせて伸縮 */
      overflow: visible;          /* はみ出し許可（必要に応じて scroll にしてもOK） */
      min-height: 297mm;          /* A4印刷レイアウトに近づける最低高さ */
    }


    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 6.8pt;         /* 最小限の読めるサイズ */
      line-height: 0.95;       /* 行の重なりを避けつつ詰める */
      margin-bottom: 0px;     /* テーブル間の隙間も最小限に */
    }

    th, td {
      border: 1px solid black;
      padding: 0px 1px;      /* 上下ゼロ、左右1pxにする */
      white-space: nowrap;
      vertical-align: middle;
    }


    .label {
      text-align: center;
      font-weight: bold;
      background: #f0f0f0;
    }
    input[type="text"], input[type="date"], select {
      width: 100%;
      font-size: 10pt;
      border: none;
      outline: none;
      background: none;
    }

    /* セクションタイトルと名前 */
    .section-title {
      font-weight: bold;
      font-size: 7.5pt;
      margin: 0;
      padding: 0;
      line-height: 1;
    }

    #name {
      font-size: 14pt;
      font-weight: bold;
    }

    /* 歯の描画 */
    .tooth-grid {
      display: grid;
      grid-template-columns: repeat(16, 24px);
      grid-gap: 5px;
      margin-left: 120px;
      position: relative;
    }
    .tooth {
      width: 24px;
      height: 24px;
      border: 1px solid #999;
      position: relative;
      text-align: center;
    }
    .number {
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      z-index: 1;
    }
    .state {
      position: absolute;
      top: 47%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      line-height: 1;
      font-family: "Arial Unicode MS", "Meiryo", sans-serif;
      z-index: 2;
    }
    .label-top, .label-bottom {
      font-size: 10px;
      font-weight: bold;
      color: blue;
      position: absolute;
      width: 100%;
      left: 0;
      text-align: center;
      display: flex;               /* ← 追加 */
      justify-content: center;     /* ← 横中央 */
      align-items: center;         /* ← 縦中央 */
      height: 1.2em;               /* ← 必要なら高さ固定 */

    }
    .label-top { top: -1.4em; } /* ← 上顎の補助ラベルの縦位置 */
    .label-bottom { bottom: -1.4em; }  /* ← 下顎の補助ラベルの縦位置 */
    .center-divider {
      position: absolute;
      width: 0px;
      border-left: 1px solid black;
      z-index: 1;
    }
    .horizontal-divider {
      position: absolute;
      height: 0px;
      border-top: 1px solid black;
      z-index: 1;
    }

    /* モーダルとボタン */
    .modal {
      display: none;
      position: fixed;
      background: rgba(0,0,0,0.6);
      top: 0; left: 0; right: 0; bottom: 0;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      width: 90%;
      max-width: 450px;
      font-size: 20px;
    }
    .btn {
      padding: 0.8em 1.5em;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      cursor: pointer;
      background-color: white;
      margin: 0.5em;
    }
    .btn:hover {
      background-color: #0056b3;
      color: white;
    }
    input[readonly] {
      background-color: #f9f9f9;
      cursor: pointer;
    }
    #otherInput input, #otherInput select {
      font-size: 16px;
      margin-top: 6px;
    }

    /* その他レイアウト */
    .print-wrapper {
      display: flex;
      flex-direction: row;
      align-items: stretch;
      gap: 0;
    }
    .left-box {
      flex: 1;
      min-width: 400px;
      max-width: 600px;
      margin-right: 0;
    }
    .consent-box {
      font-size: 8pt;
      border: 1px solid black;
      padding: 4px;
      margin-left: 0;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      text-align: center;
      flex-grow: 1;      /* ← 残りスペースを全て使う */
      min-width: 0;      /* ← 最小幅制限を外す */
      height: auto;
    }
    .signature-space {
      border-bottom: 1px solid black;
      height: 24px;
      margin-top: 4px;
    }

    .input-block {
      margin-bottom: 1em;
    }
    .label-text {
      font-size: 14px;
      margin-bottom: 0.3em;
    }
    .large-input {
      font-size: 16px;
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
    }

    #upper-toggle-wrapper, #lower-toggle-wrapper {
      position: absolute;
    }
    #br-lines {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      pointer-events: none;
    }

    /* 歯の状態選択ボタンの共通スタイル */
    .modal button.state-btn {
      font-size: 20px;
      padding: 10px 16px;
      margin: 6px;
      min-width: 60px;
      border-radius: 8px;
      border: 1px solid #888;
      background-color: #f8f8f8;
      cursor: pointer;
    }

    /* 補助ラベルのボタン大きくするために設置 */
    .label-btn {
      font-size: 18px;
      padding: 10px 16px;
      margin: 6px;
      min-width: 70px;
      border-radius: 8px;
      border: 1px solid #888;
      background-color: #f8f8f8;
      cursor: pointer;
    }
    /* モーダル表示の米村美奈子をボタン大きくするために設置 */
    .person-button {
      font-size: 20px;
      padding: 12px 24px;
      margin: 8px 0;
      width: 100%;
      border-radius: 8px;
      border: 1px solid #888;
      background-color: #f0f0f0;
      cursor: pointer;
    }

    .person-button:hover {
      background-color: #0056b3;
      color: white;
    }
    @media print {
      html, body {
        height: 297mm;
        overflow: hidden;
      }
      .container {
        border: none !important;
      }
      .no-print {
        display: none !important;
      }
      table {
        font-size: 6.5pt;
        line-height: 0.95;
        margin-bottom: 1px;
      }
      th, td {
        padding: 0px 1px;
      }
      h1, h2, h3, h4 {
        margin: 0;
        padding: 0;
        font-size: 8pt;
        line-height: 1.0;
      }
      /* ボタンの中身が空文字（PD/FDでない）なら印刷非表示 */
      .pd-fd-button:not(:empty):not(:blank) {
        display: inline-block;
      }
      .pd-fd-button:empty::before {
        content: none;
      }
      .pd-fd-button:empty {
        display: none !important;
      }
      #footer-info {
        position: absolute;
        bottom: 3mm;
        left: 0;
        width: 100%;
        text-align: center;      /* ← 管理者名等をセンターに印刷right;だと右端が切れる */
        font-size: 6pt;
        padding-right: 5mm;
      }
    }
  </style>
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const birthdayInput = document.getElementById('birthday');
      const ageInput = document.getElementById('age');
      if (birthdayInput && ageInput) {
        birthdayInput.addEventListener('change', () => {
          const birthDate = new Date(birthdayInput.value);
          if (!isNaN(birthDate)) {
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
              age--;
            }
            ageInput.value = age;
          }
        });
      }
    });
  </script>
</head>

<body onload="updateCenterDivider()">
  <div class="container">
    <h1 style="text-align:center; font-size:12pt; margin: 0;">
      口腔機能向上サービスに関する計画書・アセスメント・モニタリング・評価表
    </h1>
    <table>
      <tr>
        <td class="label" style="width: 60px;">ふりがな</td>
        <td style="width: 140px;"><input type="text" id="furigana" /></td>
        <td class="label" style="width: 25px;">男</td>
        <td style="width: 25px;"><input type="radio" name="gender" value="男" /></td>
        <td class="label" style="width: 25px;">女</td>
        <td style="width: 25px;"><input type="radio" name="gender" value="女" /></td>
        <td class="label" style="width: 60px;">生年月日</td>
        <td style="width: 110px;"><input type="date" id="birthday" /></td>
        <td class="label" style="width: 30px; text-align: center;">年齢</td>
        <td style="width: 40px; text-align: center;">
          <input type="text" id="age" placeholder="" readonly 
                style="max-width: 36px; font-size: 9pt; text-align: center;" />
        </td>

      </tr>
      <tr>
        <td class="label" rowspan="2">氏名</td>
        <td rowspan="2"><input type="text" id="name" /></td>
        <td class="label" colspan="2" rowspan="2">要介護度</td>
        <td colspan="2" rowspan="2">
          <select id="careLevel">
            <option value="">選択</option>
            <option>要支援1</option>
            <option>要支援2</option>
            <option>要介護1</option>
            <option>要介護2</option>
            <option>要介護3</option>
            <option>要介護4</option>
            <option>要介護5</option>
          </select>
        </td>
        <td class="label" rowspan="2">日常生活<br>自立度</td>
        <td class="label">障害高齢者</td>
        <td colspan="2">
          <select id="adlDisability">
            <option value="">選択</option>
            <option>自立</option>
            <option>J1</option>
            <option>J2</option>
            <option>A1</option>
            <option>A2</option>
            <option>B1</option>
            <option>B2</option>
            <option>C1</option>
            <option>C2</option>
          </select>
        </td>
      </tr>
      <tr>
        <td class="label">認知症高齢者</td>
        <td colspan="2">
          <select id="adlDementia">
            <option value="">選択</option>
            <option>自立</option>
            <option>Ⅰ</option>
            <option>Ⅱa</option>
            <option>Ⅱb</option>
            <option>Ⅲa</option>
            <option>Ⅲb</option>
            <option>Ⅳ</option>
            <option>M</option>
          </select>
        </td>
      </tr>
    </table>


<!--<h2 style="font-size: 14px;">歯式</h2>-->

<!-- Br操作ボタン -->
<button class="no-print" onclick="toggleBrMode()">Br作成</button>
<button class="no-print" onclick="clearBrLines()">Br消去</button>
<div id="brStatus" class="no-print" style="margin-top: 0.5em; font-size: 12px;">Br未選択</div>

<div style="display: flex; align-items: flex-start; margin-left: 20px;">
  <!-- 凡例ラベル -->
  <div class="legend" style="font-size: 11px; line-height: 1.8; margin-right: 8px;">
    <div>健全歯：／</div>
    <div>処置歯：○</div>
    <div>欠損歯：×</div>
    <div>う蝕：C</div>
    <div>ｲﾝﾌﾟﾗﾝﾄ：IMPL</div>
  </div>
  <!-- PD/FDボタン -->
  <div id="upper-toggle-wrapper"></div>
  <div id="lower-toggle-wrapper"></div>
  <!-- 歯の表示エリア ----------------------------------------------------------------------------------------------------------------------------->
  <div style="position: relative;">
    <div id="br-lines"></div>
    <div class="tooth-grid" id="upperJaw" style="margin-top: 30px; margin-bottom: 10px;"></div>
    <div class="center-divider"></div>
    <div class="horizontal-divider" id="horizontal-divider"></div>
    <div class="tooth-grid" id="lowerJaw" style="margin-top: 30px; margin-bottom: 30px;"></div>
  </div>
</div>

<!-- モーダル -->
<div class="modal" id="modal">
  <div class="modal-content">
    <p>歯の状態を選択：</p>
    <button class="state-btn" onclick="setState('○')">○</button>
    <button class="state-btn" onclick="setState('×')">×</button>
    <button class="state-btn" onclick="setState('／')">／</button>
    <button class="state-btn" onclick="setState('△')">△</button>
    <button class="state-btn" onclick="setState('')">消去</button>

    <p>補助ラベル：</p>
    <button class="label-btn" onclick="setLabel('Cr')">Cr</button>
    <button class="label-btn" onclick="setLabel('In')">In</button>
    <button class="label-btn" onclick="setLabel('Fck')">Fck</button>
    <button class="label-btn" onclick="setLabel('死根')">死根</button>
    <button class="label-btn" onclick="setLabel('残根')">残根</button>
    <button class="label-btn" onclick="setLabel('C')">C</button>
    <button class="label-btn" onclick="setLabel('C4')">C4</button>
    <button class="label-btn" onclick="setLabel('IMPL')">IMPL</button>
    <button class="label-btn" onclick="setLabel('')">ラベル消去</button>

  </div>
</div>

<script>
const upperJaw = document.getElementById("upperJaw");
const lowerJaw = document.getElementById("lowerJaw");
const modal = document.getElementById("modal");
let selectedTooth = null;

const left = [8,7,6,5,4,3,2,1];
const right = [1,2,3,4,5,6,7,8];

function createTooth(id, jaw, position) {
  const div = document.createElement("div");
  div.className = "tooth";
  div.dataset.id = id;
  div.dataset.jaw = jaw;
  div.dataset.position = position;
  div.innerHTML = `
    <span class="number">${id}</span>
    <span class="state"></span>
    <div class="label-top"></div>
    <div class="label-bottom"></div>
  `;
  div.onclick = () => {
    if (brMode) {
      handleToothClickForBr(div);
    } else {
      selectedTooth = div;
      modal.style.display = "flex";
    }
  };
  return div;
}

left.concat(right).forEach((num, i) => upperJaw.appendChild(createTooth(num, "upper", i < 8 ? "left" : "right")));
left.concat(right).forEach((num, i) => lowerJaw.appendChild(createTooth(num, "lower", i < 8 ? "left" : "right")));

function setState(symbol) {
  if (!selectedTooth) return;
  selectedTooth.querySelector(".state").textContent = symbol;
  modal.style.display = "none";
}
function setLabel(label) {
  if (!selectedTooth) return;
  const elem = selectedTooth.dataset.jaw === "upper" ? ".label-top" : ".label-bottom";
  selectedTooth.querySelector(elem).textContent = label;
  modal.style.display = "none";
}
modal.onclick = e => { if (e.target === modal) modal.style.display = "none"; };

let brMode = false, brStart = null, brEnd = null, selectedBrRanges = [];

function toggleBrMode() {
  brMode = !brMode;
  brStart = brEnd = null;
  document.getElementById("brStatus").textContent = brMode ? "Brモード ON：何番～？" : "BrモードOFF";
}
function handleToothClickForBr(div) {
  const status = document.getElementById("brStatus");
  if (!brStart) {
    brStart = div;
    status.textContent = `何番まで？（開始: ${brStart.dataset.id}）`;
  } else {
    brEnd = div;
    if (brStart.dataset.jaw !== brEnd.dataset.jaw) {
      alert("同じ顎を選んでください");
      brStart = brEnd = null;
      return;
    }
    selectedBrRanges.push({
      start: brStart.dataset.id,
      end: brEnd.dataset.id,
      jaw: brStart.dataset.jaw
    });
    drawBrLine(brStart, brEnd);
    brMode = false;
    status.textContent = `Br選択完了：${brStart.dataset.id}〜${brEnd.dataset.id}`;
    brStart = brEnd = null;
  }
}
function drawBrLine(startElem, endElem) {
  const container = document.getElementById("br-lines");
  const r1 = startElem.getBoundingClientRect();
  const r2 = endElem.getBoundingClientRect();
  const p = container.getBoundingClientRect();

  const x1 = r1.left + r1.width / 2 - p.left;
  const x2 = r2.left + r2.width / 2 - p.left;
  const minX = Math.min(x1, x2);
  const maxX = Math.max(x1, x2);
  const midX = (minX + maxX) / 2;

  const jaw = startElem.dataset.jaw;
  const verticalLineHeight = 6;

  // 基準y座標：上顎は下端 - 12px, 下顎は上端 + 10px
  const yBase = jaw === "upper"
    ? r1.top - p.top - 18 // ← ここをさらに上にずらすなら数字を増やす
    : r1.bottom - p.top + 12;

  // 横線のY座標は上顎は縦線の上端と同じ、下顎は縦線の下端
  const yHorizontal = jaw === "upper" ? yBase : yBase + verticalLineHeight;

  // 水平線（Brの横線）
  const line = document.createElement("div");
  Object.assign(line.style, {
    position: "absolute",
    top: `${yHorizontal}px`,
    left: `${minX}px`,
    width: `${maxX - minX + 1}px`,
    height: "0px",
    borderTop: "1px solid red"
  });

  // 左側の縦線
  const leftLine = document.createElement("div");
  Object.assign(leftLine.style, {
    position: "absolute",
    left: `${x1}px`,
    width: "0px",
    height: `${verticalLineHeight}px`,
    borderLeft: "1px solid red",
    top: `${yBase}px`
  });

  // 右側の縦線
  const rightLine = document.createElement("div");
  Object.assign(rightLine.style, {
    position: "absolute",
    left: `${x2}px`,
    width: "0px",
    height: `${verticalLineHeight}px`,
    borderLeft: "1px solid red",
    top: `${yBase}px`
  });

  // Brラベル
  const label = document.createElement("div");
  Object.assign(label.style, {
    position: "absolute",
    left: `${midX - 5}px`,
    top: jaw === "upper" ? `${yHorizontal - 12}px` : `${yHorizontal + 2}px`,
    color: "red",
    fontSize: "10px",
    fontWeight: "bold"
  });
  label.textContent = "Br";

  // 追加
  [line, leftLine, rightLine, label].forEach(el => {
    el.className = "br-line";
    container.appendChild(el);
  });
}

function clearBrLines() {
  document.querySelectorAll(".br-line").forEach(e => e.remove());
  selectedBrRanges = [];
  document.getElementById("brStatus").textContent = "Br未選択";
}

function cyclePdFd(btn) {
  const states = ["", "PD", "FD"];
  const current = btn.textContent.trim();
  btn.textContent = states[(states.indexOf(current) + 1) % states.length];
}
function positionPdFdButtons() {
  const upper8 = [...upperJaw.querySelectorAll(".tooth")].find(t => t.dataset.id === "8" && t.dataset.position === "right");
  const lower8 = [...lowerJaw.querySelectorAll(".tooth")].find(t => t.dataset.id === "8" && t.dataset.position === "right");

  const upperWrapper = document.getElementById("upper-toggle-wrapper");
  const lowerWrapper = document.getElementById("lower-toggle-wrapper");

  // 初期化
  upperWrapper.innerHTML = "";
  lowerWrapper.innerHTML = "";

  // ボタン生成＆イベントバインド
  if (upper8) {
    const btn = document.createElement("button");
    btn.className = "pd-fd-button";
    btn.textContent = ""; // 初期は空
    btn.addEventListener("click", () => cyclePdFd(btn));
    upperWrapper.appendChild(btn);
    upperJaw.appendChild(upperWrapper);

    // グリッド内での相対位置
    requestAnimationFrame(() => {
      const offset = upper8.offsetLeft + upper8.offsetWidth + 4;
      upperWrapper.style.position = "absolute";
      upperWrapper.style.left = `${offset}px`;
      upperWrapper.style.top = `${upper8.offsetTop}px`;
    });
  }

  if (lower8) {
    const btn = document.createElement("button");
    btn.className = "pd-fd-button";
    btn.textContent = ""; // 初期は空
    btn.addEventListener("click", () => cyclePdFd(btn));
    lowerWrapper.appendChild(btn);
    lowerJaw.appendChild(lowerWrapper);

    requestAnimationFrame(() => {
      const offset = lower8.offsetLeft + lower8.offsetWidth + 4;
      lowerWrapper.style.position = "absolute";
      lowerWrapper.style.left = `${offset}px`;
      lowerWrapper.style.top = `${lower8.offsetTop}px`;
    });
  }
}


window.addEventListener("load", () => {
  positionPdFdButtons();
  updateCenterDivider();
  updateHorizontalDivider();
});
window.addEventListener("resize", () => {
  positionPdFdButtons();
  updateCenterDivider();
  updateHorizontalDivider();
});


function updateCenterDivider() {
  const upper = document.getElementById("upperJaw");
  const lower = document.getElementById("lowerJaw");
  const divider = document.querySelector(".center-divider");

  if (upper && lower && divider) {
    const containerRect = upper.parentElement.getBoundingClientRect();
    const upperRect = upper.getBoundingClientRect();

    const leftOffset = upperRect.left - containerRect.left;
    const toothWidth = 24;
    const gap = 5;
    const midOffset = (toothWidth + gap) * 8 - (gap / 2);  // ちょうど中央の線（gapも考慮）

    divider.style.left = `${leftOffset + midOffset}px`;
    divider.style.top = `${upper.offsetTop}px`;
    divider.style.height = (lower.offsetTop + lower.offsetHeight - upper.offsetTop) + "px";
  }
}

function updateHorizontalDivider() {
  const upper = document.getElementById("upperJaw");
  const lower = document.getElementById("lowerJaw");
  const horizontal = document.getElementById("horizontal-divider");

  if (upper && lower && horizontal) {
    const containerRect = upper.parentElement.getBoundingClientRect();
    const upperRect = upper.getBoundingClientRect();

    // 歯グリッド左端（8番左）から
    const left = upperRect.left - containerRect.left;

    // 右8番（右側）の要素を取得
    const right8 = [...upper.querySelectorAll(".tooth")].find(t => t.dataset.id === "8" && t.dataset.position === "right");

    let rightEdge;
    if (right8) {
      const r8Rect = right8.getBoundingClientRect();
      rightEdge = r8Rect.right - containerRect.left + 8; // 少し余白追加
    } else {
      rightEdge = upperRect.right - containerRect.left;
    }

    horizontal.style.top = (lower.offsetTop - 15) + "px";
    horizontal.style.left = `${left}px`;
    horizontal.style.width = `${rightEdge - left}px`;
  }
}


</script>

    <!-- この下に「最初の項目→→→→→→→→→→→→→→→→→→→→かかりつけ医とか義歯の使用とか」を続けていきます -->
    <!-- <h2 class="section-title">口腔に関する基本情報</h2> -->
    <table style="font-size: 8.3pt; width: 100%; border-collapse: collapse; line-height: 1.05; margin-left: 0; text-align: left;">
      <tr>
        <td class="label" style="background: #e0e0e0; width: 15%;">かかりつけ歯科医師</td>
        <td style="width: 35%;">
          <label><input type="radio" name="kakaritsuke" value="あり">あり</label>
          <label><input type="radio" name="kakaritsuke" value="なし">なし</label>
        </td>
        <td class="label" style="background: #e0e0e0; width: 20%;">直近1年歯科受診</td>
        <td colspan="2">
          <label><input type="radio" name="shika_lastyear" value="あり">あり</label>
          （最終：<input type="month" name="lastVisitMonth" style="width: 110px;">）
          <label><input type="radio" name="shika_lastyear" value="なし">なし</label>
        </td>
      </tr>

      <tr>
        <td class="label" style="background: #e0e0e0; width: 15%;">義歯の使用</td>
        <td style="width: 35%;">
          <label><input type="radio" name="gishi" value="あり" onclick="toggleGishiDetail(true)">あり</label>
          （
          <label><input type="radio" name="gishi_detail" value="部分" id="gishi_partial">部分</label>
          <label><input type="radio" name="gishi_detail" value="全部" id="gishi_full">全部</label>
          ）
          <label><input type="radio" name="gishi" value="なし" onclick="toggleGishiDetail(false)">なし</label>
        </td>
        <td class="label" style="background: #e0e0e0; width: 15%;">栄養補給法</td>
        <td colspan="2">
          <label><input type="radio" name="eiyou" value="経口のみ">経口のみ</label>
          <label><input type="radio" name="eiyou" value="一部経口">一部経口</label>
          （
          <label><input type="checkbox" name="nutrition_detail" value="経腸栄養">経腸栄養</label>
          <label><input type="checkbox" name="nutrition_detail" value="静脈栄養">静脈栄養</label>
          ）
        </td>
      </tr>

      <tr>
        <td class="label" style="background: #e0e0e0;">食事形態</td>
        <td colspan="4">
          <label><input type="radio" name="shokuji" value="常食">常食</label>
          <label><input type="radio" name="shokuji" value="嚥下調整食">嚥下調整食</label>
          （コード：
          <label><input type="radio" name="shokuji_code" value="4">4</label>
          <label><input type="radio" name="shokuji_code" value="3">3</label>
          <label><input type="radio" name="shokuji_code" value="2-2">2-2</label>
          <label><input type="radio" name="shokuji_code" value="2-1">2-1</label>
          <label><input type="radio" name="shokuji_code" value="1j">1j</label>
          <label><input type="radio" name="shokuji_code" value="0t">0t</label>
          <label><input type="radio" name="shokuji_code" value="0j">0j</label>）
        </td>
      </tr>
      <tr>
        <td class="label" style="background: #e0e0e0; width: 30%;">誤嚥性肺炎の発症・既往</td>
        <td colspan="4">
          <label><input type="radio" name="goen" value="あり">あり</label>
          （直近の発症年月：<input type="month" name="goenMonth" style="width: 130px;">）
          <label><input type="radio" name="goen" value="なし">なし</label>
        </td>
      </tr>
      <tr>
        <td class="label">その他特記事項</td>
        <td colspan="4"><input type="text" name="tokkijikou" style="width: 100%;"></td>
      </tr>
    </table>

    <script>
      function toggleGishiDetail(enable) {
        document.getElementById('gishi_partial').disabled = !enable;
        document.getElementById('gishi_full').disabled = !enable;

        if (!enable) {
          document.getElementById('gishi_partial').checked = false;
          document.getElementById('gishi_full').checked = false;
        }
      }
    </script>



    <!-- この下に「1.口腔の健康状態の評価・再評価」を続けていきます -->

    <h2 class="section-title" style="margin: 0; padding: 0;">1. 口腔の健康状態の評価・再評価（口腔に関する問題点等）</h2>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const today = new Date().toISOString().split('T')[0];

        // 実施日を変更したとき、他の欄にも反映する
        const mainDateInput = document.getElementById('examDate');
        const planDateInput = document.getElementById('examDatePlan');
        const recordDateInput = document.getElementById('examDateRecord');

        // すべての実施日に初期値（本日）を設定
        if (mainDateInput) mainDateInput.value = today;
        if (planDateInput) planDateInput.value = today;
        if (recordDateInput) recordDateInput.value = today;

        // mainDateInput を変更したときに他の2つへ連動
        if (mainDateInput && planDateInput && recordDateInput) {
          mainDateInput.addEventListener('change', function () {
            planDateInput.value = mainDateInput.value;
            recordDateInput.value = mainDateInput.value;
          });
        }
      });

      function openPersonModal() {
        document.getElementById("personModal").style.display = "flex";
        document.getElementById("otherInput").style.display = "none";
      }

      function closePersonModal() {
        document.getElementById("personModal").style.display = "none";
      }

      function showOtherInput() {
        document.getElementById("otherInput").style.display = "block";
      }

      function selectPerson(name, qualification) {
        document.getElementById("examWriterMain").value = name;

        const checkboxes = document.getElementsByName("writerTypeMain");
        checkboxes.forEach(box => {
          box.checked = (box.value === qualification);
        });

        // 他の欄（計画立案者・サービス提供者）にも反映
        applyWriterToAll(name, qualification);

        closePersonModal();
      }

      function confirmOther() {
        const name = document.getElementById("otherName").value.trim();
        const role = document.getElementById("otherRole").value;
        if (!name || !role) {
          alert("氏名と資格を入力してください");
          return;
        }

        document.getElementById("examWriterMain").value = name;
        const checkboxes = document.getElementsByName("writerTypeMain");
        checkboxes.forEach(box => {
          box.checked = (box.value === role);
        });

        closePersonModal();
      }

    </script>
    <table style="font-size: 7pt; width: 100%; border-collapse: collapse; line-height: 1.0; margin-left: 0; text-align: left;">
      <tr style="height: 20px;">
        <td class="label" style="width:80px; padding: 1px;">実施日</td>
        <td style="width:110px; padding: 1px;">
          <input type="date" id="examDate" style="font-size: 8pt; width: 100%;" />
        </td>
        <td class="label" style="width:80px; padding: 1px;">記入者</td>
        <td style="width:100px; padding: 1px;">
          <input type="text" id="examWriterMain"
            placeholder="記入者を選択"
            readonly
            onclick="openPersonModal()"
            style="cursor:pointer; max-width: 90px; font-size: 7pt; width: 100%;" />
        </td>
        <td style="white-space: nowrap; padding: 1px;">
          <label style="font-size: 7pt;"><input type="checkbox" name="writerTypeMain" value="歯科衛生士" /> 歯科衛生士</label>
          <label style="font-size: 7pt;"><input type="checkbox" name="writerTypeMain" value="看護師" /> 看護師</label>
          <label style="font-size: 7pt;"><input type="checkbox" name="writerTypeMain" value="言語聴覚士" /> 言語聴覚士</label>
        </td>
      </tr>
    </table>



    <!-- モーダル -->
    <div id="personModal" class="modal" style="display:none; position:fixed; background:rgba(0,0,0,0.6); top:0; left:0; right:0; bottom:0; justify-content:center; align-items:center; z-index:1000;">
      <div class="modal-content" style="background:white; padding:1rem; border-radius:8px; width:90%; max-width:400px; font-size:18px;">
        <h3>記入者を選択</h3>

        <button class="person-button" onclick="selectPerson('米村　美奈子', '歯科衛生士')">米村　美奈子</button><br>
        <button class="person-button" onclick="selectPerson('近藤　真由美', '看護師')">近藤　真由美</button><br>


        <button onclick="showOtherInput()">その他</button>

        <div id="otherInput" style="display:none; margin-top:1em;">
          <input type="text" id="otherName" placeholder="氏名を入力" style="width:90%; margin-bottom:6px;"><br>
          <select id="otherRole" style="width:90%; margin-bottom:6px;">
            <option value="">資格を選択</option>
            <option value="歯科衛生士">歯科衛生士</option>
            <option value="看護師">看護師</option>
            <option value="言語聴覚士">言語聴覚士</option>
          </select><br>
          <button onclick="confirmOther()">入力して決定</button>
        </div>

        <button onclick="closePersonModal()" style="margin-top:1em;">キャンセル</button>
      </div>
    </div>



    <table style="font-size: 8.3pt; table-layout: fixed; width: 100%; margin: 0; line-height: 1.0;">
      <colgroup>
        <col style="width: 13%;">
        <col style="width: 10%;">
        <col style="width: 24%;">
        <col style="width: 13%;">
        <col style="width: 28%;">
      </colgroup>
      <tr>
        <td class="label" rowspan="2" style="text-align: center;">口腔衛生状態</td>
        <td class="label">口臭</td>
        <td><label><input type="radio" name="kou" value="あり">あり</label> <label><input type="radio" name="kou" value="なし">なし</label> <label><input type="radio" name="kou" value="分からない">分からない</label></td>
        <td class="label">義歯の汚れ</td>
        <td><label><input type="radio" name="gishi" value="あり">あり</label> <label><input type="radio" name="gishi" value="なし">なし</label> <label><input type="radio" name="gishi" value="分からない">分からない</label></td>
      </tr>
      <tr>
        <td class="label">歯の汚れ</td>
        <td><label><input type="radio" name="yogore" value="あり">あり</label> <label><input type="radio" name="yogore" value="なし">なし</label> <label><input type="radio" name="yogore" value="分からない">分からない</label></td>
        <td class="label">舌苔</td>
        <td><label><input type="radio" name="zettai" value="あり">あり</label> <label><input type="radio" name="zettai" value="なし">なし</label> <label><input type="radio" name="zettai" value="分からない">分からない</label></td>
      </tr>
    </table>

    <table style="font-size: 8.3pt; table-layout: fixed; width: 100%; margin: 0; line-height: 1.0;">
      <colgroup>
        <col style="width: 13%;">
        <col style="width: 10%;">
        <col style="width: 24%;">
        <col style="width: 13%;">
        <col style="width: 28%;">
      </colgroup>
      <tr>
        <td class="label" rowspan="3" style="text-align: center;">口腔機能の状態</td>
        <td class="label">奥歯の咬合</td>
        <td><label><input type="radio" name="kougou" value="あり">あり</label> <label><input type="radio" name="kougou" value="なし">なし</label> <label><input type="radio" name="kougou" value="分からない">分からない</label></td>
        <td class="label">口腔乾燥</td>
        <td><label><input type="radio" name="dry" value="あり">あり</label> <label><input type="radio" name="dry" value="なし">なし</label> <label><input type="radio" name="dry" value="分からない">分からない</label></td>
      </tr>
      <tr>
        <td class="label">食べこぼし</td>
        <td><label><input type="radio" name="koboshi" value="あり">あり</label> <label><input type="radio" name="koboshi" value="なし">なし</label> <label><input type="radio" name="koboshi" value="分からない">分からない</label></td>
        <td class="label">舌の動きが悪い</td>
        <td><label><input type="radio" name="tongue" value="あり">あり</label> <label><input type="radio" name="tongue" value="なし">なし</label> <label><input type="radio" name="tongue" value="分からない">分からない</label></td>
      </tr>
      <tr>
        <td class="label">むせ</td>
        <td style="white-space: nowrap;"><label><input type="radio" name="muse" value="あり">あり</label> <label><input type="radio" name="muse" value="なし">なし</label> <label><input type="radio" name="muse" value="分からない">分からない</label></td>
        <td class="label">ぶくぶくうがい</td>
        <td style="white-space: nowrap;"><label><input type="radio" name="ugai" value="できる">できる</label> <label><input type="radio" name="ugai" value="できない">できない</label> <label><input type="radio" name="ugai" value="分からない">分からない</label></td>
      </tr>
    </table>

    <table style="font-size: 8.3pt; width: 100%; border-collapse: collapse; line-height: 1.05; margin-left: 0; text-align: left;">
      <tr>
        <td class="label" style="width: 18%;">歯科受診の必要性</td>
        <td>
          <label><input type="radio" name="visit" value="あり">あり</label>
          <label><input type="radio" name="visit" value="なし">なし</label>
          <label><input type="radio" name="visit" value="分からない">分からない</label>
        </td>
      </tr>
    </table>

    <table style="font-size: 8.3pt; width: 100%; border-collapse: collapse; line-height: 1.05; margin-left: 0; text-align: left;">
      <tr>
        <td class="label" style="width: 13%; text-align: center; vertical-align: middle;">特記事項</td>
        <td>
          <label><input type="checkbox" name="tokkijikou1"> 歯（う蝕、修復物脱離等）、義歯（義歯不適合等）、歯周病、口腔粘膜（潰瘍等）の疾患の可能性</label><br>
          <label><input type="checkbox" name="tokkijikou2"> 音声・言語機能に関する疾患の可能性</label><br>
          <label><input type="checkbox" name="tokkijikou3"> その他（ <input type="text" style="width: 60%; display: inline-block;"> ）</label>
        </td>
      </tr>
    </table>


    <!-- この下に「2. 口腔機能改善管理指導計画を続けていきます -->

    <h2 class="section-title" style="margin: 0; padding: 0;">2. 口腔機能改善管理指導計画</h2>
    <table style="font-size: 7pt; width: 100%; border-collapse: collapse; line-height: 1.0; margin-left: 0; text-align: left;">
      <tr style="height: 20px;">
        <td class="label" rowspan="2" style="width:80px; vertical-align: middle; text-align: center; padding: 1px;">実施日</td>
        <td rowspan="2" style="width:110px; vertical-align: middle; padding: 1px;">
          <input type="date" id="examDatePlan" style="font-size: 8pt; width: 100%;" />
        </td>

        <td class="label" style="width:90px; padding: 1px;">計画立案者</td>
        <td style="width:100px; padding: 1px;">
          <input type="text" id="examWriterPlan" style="font-size: 7pt; width: 100%;" />
        </td>
        <td style="white-space: nowrap; padding: 1px;">
          <label style="font-size: 7pt;"><input type="checkbox" name="writerTypePlan" value="歯科衛生士" /> 歯科衛生士</label>
          <label style="font-size: 7pt;"><input type="checkbox" name="writerTypePlan" value="看護師" /> 看護師</label>
          <label style="font-size: 7pt;"><input type="checkbox" name="writerTypePlan" value="言語聴覚士" /> 言語聴覚士</label>
        </td>
      </tr>
      <tr style="height: 20px;">
        <td class="label" style="width:90px; text-align: center; padding: 1px;">サービス提供者</td>
        <td style="width:100px; padding: 1px;">
          <input type="text" id="examWriterProvider" style="font-size: 7pt; width: 100%;" />
        </td>
        <td style="white-space: nowrap; padding: 1px;">
          <label style="font-size: 7pt;"><input type="checkbox" name="writerTypeProvider" value="歯科衛生士" /> 歯科衛生士</label>
          <label style="font-size: 7pt;"><input type="checkbox" name="writerTypeProvider" value="看護師" /> 看護師</label>
          <label style="font-size: 7pt;"><input type="checkbox" name="writerTypeProvider" value="言語聴覚士" /> 言語聴覚士</label>
        </td>
      </tr>
    </table>



    <script>
    function applyWriterToAll(name, role) {
      // 計画立案者
      document.getElementById("examWriterPlan").value = name;
      const planChecks = document.getElementsByName("writerTypePlan");
      planChecks.forEach(c => c.checked = (c.value === role));

      // サービス提供者
      document.getElementById("examWriterProvider").value = name;
      const providerChecks = document.getElementsByName("writerTypeProvider");
      providerChecks.forEach(c => c.checked = (c.value === role));
    }
    </script>

<table style="font-size: 8.3pt; width: 100%; border-collapse: collapse; line-height: 1.0; margin: 0; text-align: left;">
  <tr>
    <td class="label" style="width: 80px; text-align: center; vertical-align: center;">目標</td>
    <td style="padding: 2px;">
      <div style="border-bottom: 1px dotted #000; padding-bottom: 1px; margin-bottom: 1px;">
        <label style="font-size: 8pt;"><input type="checkbox" name="goal1" id="goal1Check"> 歯科疾患</label>
        <label style="font-size: 8pt;"><input type="radio" name="goal1_detail" value="重症化防止" disabled> 重症化防止</label>
        <label style="font-size: 8pt;"><input type="radio" name="goal1_detail" value="維持" disabled> 維持</label>
        <label style="font-size: 8pt;"><input type="radio" name="goal1_detail" value="改善" disabled> 改善</label>
      </div>

      <div style="border-bottom: 1px dotted #000; padding-bottom: 1px; margin-bottom: 1px;">
        <label style="font-size: 8pt;"><input type="checkbox" name="goal2" id="goal2Check"> 口腔衛生</label>
        <label style="font-size: 8pt;"><input type="radio" name="goal2_detail" value="維持" disabled> 維持</label>
        <label style="font-size: 8pt;"><input type="radio" name="goal2_detail" value="改善" disabled> 改善</label>
        <input type="text" name="goal2_text" placeholder="改善内容" style="font-size: 8pt; width: 55%; height: 16px; display: none;">
      </div>

      <div style="border-bottom: 1px dotted #000; padding-bottom: 1px; margin-bottom: 1px;">
        <label style="font-size: 8pt;"><input type="checkbox" name="goal3" id="goal3Check"> 摂食嚥下等の口腔機能</label>
        <label style="font-size: 8pt;"><input type="radio" name="goal3_detail" value="維持" disabled> 維持</label>
        <label style="font-size: 8pt;"><input type="radio" name="goal3_detail" value="改善" disabled> 改善</label>
        <input type="text" name="goal3_text" placeholder="改善内容" style="font-size: 8pt; width: 55%; height: 16px; display: none;">
      </div>

      <div style="border-bottom: 1px dotted #000; padding-bottom: 1px; margin-bottom: 1px;">
        <label style="font-size: 8pt;"><input type="checkbox" name="goal4" id="goal4Check"> 食形態</label>
        <label style="font-size: 8pt;"><input type="radio" name="goal4_detail" value="維持" disabled> 維持</label>
        <label style="font-size: 8pt;"><input type="radio" name="goal4_detail" value="改善" disabled> 改善</label>
        <input type="text" name="goal4_text" placeholder="改善内容" style="font-size: 8pt; width: 55%; height: 16px; display: none;">
      </div>

      <div style="border-bottom: 1px dotted #000; padding-bottom: 1px; margin-bottom: 1px;">
        <label style="font-size: 8pt;"><input type="checkbox" name="goal5" id="goal5Check"> 栄養状態</label>
        <label style="font-size: 8pt;"><input type="radio" name="goal5_detail" value="維持" disabled> 維持</label>
        <label style="font-size: 8pt;"><input type="radio" name="goal5_detail" value="改善" disabled> 改善</label>
        <input type="text" name="goal5_text" placeholder="改善内容" style="font-size: 8pt; width: 55%; height: 16px; display: none;">
      </div>

      <div style="border-bottom: 1px dotted #000; padding-bottom: 1px; margin-bottom: 1px;">
        <label style="font-size: 8pt;"><input type="checkbox" name="goal6" id="goal6Check"> 音声・言語機能</label>
        <label style="font-size: 8pt;"><input type="radio" name="goal6_detail" value="維持" disabled> 維持</label>
        <label style="font-size: 8pt;"><input type="radio" name="goal6_detail" value="改善" disabled> 改善</label>
        <input type="text" name="goal6_text" placeholder="改善内容" style="font-size: 8pt; width: 55%; height: 16px; display: none;">
      </div>

      <div style="border-bottom: 1px dotted #000; padding-bottom: 1px; margin-bottom: 1px;">
        <label style="font-size: 8pt;"><input type="checkbox" name="goal7"> 誤嚥性肺炎の予防</label>
      </div>

      <div>
        <label style="font-size: 8pt;"><input type="checkbox" name="goal8"> その他（<input type="text" style="font-size: 8pt; height: 16px; width: 60%; display: inline-block;">）</label>
      </div>
    </td>
  </tr>
</table>




    <script>

      document.addEventListener('DOMContentLoaded', () => {
        for (let i = 1; i <= 6; i++) {
          const check = document.querySelector(`input[name="goal${i}"]`);
          const radios = document.querySelectorAll(`input[name="goal${i}_detail"]`);
          const input = document.querySelector(`input[name="goal${i}_text"]`);

          if (!check) continue;

          const update = () => {
            const enabled = check.checked;
            radios.forEach(r => {
              r.disabled = !enabled;
              if (!enabled) r.checked = false;
            });

            if (input) {
              const isImprovement = enabled && [...radios].some(r => r.value === "改善" && r.checked);
              input.style.display = isImprovement ? "inline-block" : "none";
              input.required = isImprovement;

              // () で囲む処理（見た目上の入力に）
              if (isImprovement && input.value && !input.value.startsWith("（")) {
                input.value = `（${input.value}）`;
              }

              // チェックを外した場合に括弧も除去（必要なら）
              if (!isImprovement && input.value.startsWith("（") && input.value.endsWith("）")) {
                input.value = input.value.slice(1, -1);
              }
            }
          };

          check.addEventListener("change", update);
          radios.forEach(r => r.addEventListener("change", update));
          input && input.addEventListener("blur", () => {
            if (input.value && !input.value.startsWith("（")) {
              input.value = `（${input.value}）`;
            }
          });

          update();
        }
      });

    </script>


    <table style="font-size: 8.3pt; width: 100%; border-collapse: collapse; margin: 0; line-height: 1.0; text-align: left;">
      <tr>
        <td class="label" style="width: 80px; text-align: center; vertical-align: center;">実施内容</td>
        <td style="padding: 2px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; row-gap: 2px; column-gap: 4px;">
            <label style="border-bottom: 1px dotted #000; font-size: 8pt; margin: 0; padding-bottom: 1px;">
              <input type="checkbox" name="content1"> 口腔清掃
            </label>
            <label style="border-bottom: 1px dotted #000; font-size: 8pt; margin: 0; padding-bottom: 1px;">
              <input type="checkbox" name="content2" checked> 口腔清掃に関する指導
            </label>
            <label style="border-bottom: 1px dotted #000; font-size: 8pt; margin: 0; padding-bottom: 1px;">
              <input type="checkbox" name="content3" checked> 摂食嚥下等の口腔機能に関する指導
            </label>
            <label style="border-bottom: 1px dotted #000; font-size: 8pt; margin: 0; padding-bottom: 1px;">
              <input type="checkbox" name="content4"> 音声・言語機能に関する指導
            </label>
            <label style="font-size: 8pt; margin: 0; padding-bottom: 1px;">
              <input type="checkbox" name="content5" checked> 誤嚥性肺炎の予防に関する指導
            </label>
            <label style="font-size: 8pt; margin: 0; padding-bottom: 1px;">
              <input type="checkbox" name="content6" checked>
              その他（<input type="text" value="集団口腔体操及び個別指導" style="font-size: 8pt; height: 16px; width: 70%;">）
            </label>
          </div>
        </td>
      </tr>
    </table>





    <!-- この下に「3. 実施記録を続けていきます -->
    <h3 class="section-title" style="margin: 0; padding: 0;">3. 実施記録</h3>
    <table style="font-size: 7pt; width: 100%; border-collapse: collapse; line-height: 1.0; margin-left: 0; text-align: left;">
      <tr style="height: 20px;">
        <td class="label" style="width:80px; padding: 1px;">実施日</td>
        <td style="width:110px; padding: 1px;">
          <input type="date" id="examDateRecord" style="font-size: 8pt; width: 100%;" />
        </td>

        <td class="label" style="width:90px; padding: 1px;">サービス提供者</td>
        <td style="width:100px; padding: 1px;">
          <input type="text" id="examWriterRecord" style="font-size: 7pt; width: 100%;" />
        </td>

        <td style="white-space: nowrap; padding: 1px;">
          <label style="font-size: 7pt;"><input type="checkbox" name="writerTypeRecord" value="歯科衛生士" /> 歯科衛生士</label>
          <label style="font-size: 7pt;"><input type="checkbox" name="writerTypeRecord" value="看護師" /> 看護師</label>
          <label style="font-size: 7pt;"><input type="checkbox" name="writerTypeRecord" value="言語聴覚士" /> 言語聴覚士</label>
        </td>
      </tr>
    </table>



    <script>
    function applyWriterToAll(name, role) {
      // 計画立案者
      document.getElementById("examWriterPlan").value = name;
      const planChecks = document.getElementsByName("writerTypePlan");
      planChecks.forEach(c => c.checked = (c.value === role));

      // サービス提供者（計画）
      document.getElementById("examWriterProvider").value = name;
      const providerChecks = document.getElementsByName("writerTypeProvider");
      providerChecks.forEach(c => c.checked = (c.value === role));

      // サービス提供者（実施記録）
      document.getElementById("examWriterRecord").value = name;
      const recordChecks = document.getElementsByName("writerTypeRecord");
      recordChecks.forEach(c => c.checked = (c.value === role));
    }
    </script>

    <table style="font-size: 8.3pt; width: 100%; border-collapse: collapse; margin: 0; line-height: 1.0; text-align: left;">
      <tr>
        <td class="label" style="width: 80px; text-align: center; vertical-align: center;">実施内容</td>
        <td style="padding: 2px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; row-gap: 2px; column-gap: 4px;">
            <label style="border-bottom: 1px dotted #000; font-size: 8pt; margin: 0; padding-bottom: 1px;">
              <input type="checkbox" name="record_content1"> 口腔清掃
            </label>
            <label style="border-bottom: 1px dotted #000; font-size: 8pt; margin: 0; padding-bottom: 1px;">
              <input type="checkbox" name="record_content2" checked> 口腔清掃に関する指導
            </label>
            <label style="border-bottom: 1px dotted #000; font-size: 8pt; margin: 0; padding-bottom: 1px;">
              <input type="checkbox" name="record_content3" checked> 摂食嚥下等の口腔機能に関する指導
            </label>
            <label style="border-bottom: 1px dotted #000; font-size: 8pt; margin: 0; padding-bottom: 1px;">
              <input type="checkbox" name="record_content4"> 音声・言語機能に関する指導
            </label>
            <label style="font-size: 8pt; margin: 0; padding-bottom: 1px;">
              <input type="checkbox" name="record_content5" checked> 誤嚥性肺炎の予防に関する指導
            </label>
            <label style="font-size: 8pt; margin: 0; padding-bottom: 1px;">
              <input type="checkbox" name="record_content6" checked>
              その他（<input type="text" value="集団口腔体操及び個別指導" style="font-size: 8pt; height: 16px; width: 70%;">）
            </label>
          </div>
        </td>
      </tr>
    </table>




    <h4 class="section-title" style="margin: 0; padding: 0;">RSSTとオーラルディアドコキネシス</h4>
    <div class="print-wrapper" style="display: flex; align-items: flex-start; gap: 1rem;">
      <!-- 左の表 -->
      <div class="left-box" style="flex: 0 0 440px; max-width: 440px;">
        <table style="table-layout: fixed; border-collapse: collapse; font-size: 7.5pt; font-family: sans-serif; text-align: center; width: 100%;">
          <colgroup>
            <col style="width: 46%;">
            <col style="width: 18%;">
            <col style="width: 18%;">
            <col style="width: 18%;">
          </colgroup>
          <thead>
            <tr style="height: 22px;">
              <th style="text-align: left;">※RSST→30秒間の咽頭挙上の回数</th>
              <th id="header1">1回目</th>
              <th id="header2">2回目</th>
              <th id="header3">3回目</th>
            </tr>
          </thead>
          <tbody>
            <tr style="height: 22px;">
              <th style="text-align: left; width: 48%;">RSST（正常値3回以上）</th>
              <td id="rsst1"></td><td id="rsst2"></td><td id="rsst3"></td>
            </tr>
            <tr style="height: 22px;">
              <th style="text-align: left; width: 48%;">パ（回/秒） 男4.4～7.2 女4.2～7.2</th>
              <td id="pa1"></td><td id="pa2"></td><td id="pa3"></td>
            </tr>
            <tr style="height: 22px;">
              <th style="text-align: left; width: 48%;">タ（回/秒） 男4.2～7.0 女4.4～7.2</th>
              <td id="ta1"></td><td id="ta2"></td><td id="ta3"></td>
            </tr>
            <tr style="height: 22px;">
              <th style="text-align: left; width: 48%;">カ（回/秒） 男4.0～6.6 女4.1～6.7</th>
              <td id="ka1"></td><td id="ka2"></td><td id="ka3"></td>
            </tr>
          </tbody>
        </table>

        <!-- RSST記録ボタン -->
        <div style="text-align: left; margin-top: 0.8rem;">
          <button class="btn no-print" onclick="openModal()">記録する</button>
          <button class="btn no-print" onclick="editLast()">記録訂正</button>
        </div>
      </div>

      <!-- 右の同意欄 -->
      <div class="consent-box" style="
        font-size: 9.5pt;
        border: 1px solid black;
        padding: 6px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        text-align: center;
        min-width: 180px;
        margin-top: 0;
      ">
        <strong>説明日・同意日</strong>
        <div style="margin-top: 0px;">　　　　年　　　　月　　　　日</div>
        <div style="margin-top: 0px;">
          利用者同意書サイン（本人）<br><br>
          <div class="signature-space" style="border-bottom: 1px solid black; height: 24px; margin-top: 4px;"></div>
        </div>
      </div>
    </div>



    <!-- モーダル -->
    <div class="modal" id="rsstModal">
      <div class="modal-content">
        <h3>RSST・パ・タ・カ 記録入力</h3>
        <div class="input-block">
          <div class="label-text">RSST（回/30秒）</div>
          <input type="text" inputmode="numeric" pattern="[0-9]*" id="rsstInput" class="large-input" autocomplete="off" enterkeyhint="next" />
        </div>
        <div class="input-block">
          <div class="label-text">パ（回）</div>
          <input type="text" inputmode="numeric" pattern="[0-9]*" id="paInput" class="large-input" autocomplete="off" enterkeyhint="next" />
        </div>
        <div class="input-block">
          <div class="label-text">タ（回）</div>
          <input type="text" inputmode="numeric" pattern="[0-9]*" id="taInput" class="large-input" autocomplete="off" enterkeyhint="next" />
        </div>
        <div class="input-block">
          <div class="label-text">カ（回）</div>
          <input type="text" inputmode="numeric" pattern="[0-9]*" id="kaInput" class="large-input" autocomplete="off" enterkeyhint="done" />
        </div>

        <!-- 必要であれば送信ボタンもここに追加 -->
        <button onclick="submitModal()">記録する</button>
        <button onclick="closeModal()">閉じる</button>
      </div>
    </div>

    <script>
      let recordCount = 0;

      function openModal() {
        document.getElementById("rsstModal").style.display = "flex";
        setTimeout(() => document.getElementById("rsstInput").focus(), 100);
      }


      function closeModal() {
        document.getElementById("rsstModal").style.display = "none";
        ["rsstInput", "paInput", "taInput", "kaInput"].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.value = "";
        });
        delete window.__editRSSTIndex;
      }


      function submitModal() {
        const rsst = document.getElementById("rsstInput").value;
        const pa = (parseInt(document.getElementById("paInput").value) / 10).toFixed(1);
        const ta = (parseInt(document.getElementById("taInput").value) / 10).toFixed(1);
        const ka = (parseInt(document.getElementById("kaInput").value) / 10).toFixed(1);

        if (!rsst || isNaN(pa) || isNaN(ta) || isNaN(ka)) {
          alert("すべての項目を正しく入力してください");
          return;
        }

        // 訂正時の処理
        if (window.__editRSSTIndex) {
          const i = window.__editRSSTIndex;

          // 記録を上書き
          document.getElementById(`rsst${i}`).textContent = rsst;
          document.getElementById(`pa${i}`).textContent = pa;
          document.getElementById(`ta${i}`).textContent = ta;
          document.getElementById(`ka${i}`).textContent = ka;

          // ヘッダーの更新（回数を元のまま維持）
          updateHeaders(recordCount);

          // 訂正後、インデックスをリセット
          delete window.__editRSSTIndex;
          closeModal();
          return;
        }

        // 新規記録の場合
        recordCount++;

        let rsstArr = [document.getElementById("rsst1").textContent, document.getElementById("rsst2").textContent, document.getElementById("rsst3").textContent];
        let paArr = [document.getElementById("pa1").textContent, document.getElementById("pa2").textContent, document.getElementById("pa3").textContent];
        let taArr = [document.getElementById("ta1").textContent, document.getElementById("ta2").textContent, document.getElementById("ta3").textContent];
        let kaArr = [document.getElementById("ka1").textContent, document.getElementById("ka2").textContent, document.getElementById("ka3").textContent];

        // 空いているセルを見つけて新規記録
        if (rsstArr.includes("")) {
          const i = rsstArr.findIndex(v => v === "") + 1;
          document.getElementById(`rsst${i}`).textContent = rsst;
          document.getElementById(`pa${i}`).textContent = pa;
          document.getElementById(`ta${i}`).textContent = ta;
          document.getElementById(`ka${i}`).textContent = ka;
        } else {
          // すべて埋まっている場合、データをずらす
          rsstArr = [rsstArr[1], rsstArr[2], rsst];
          paArr = [paArr[1], paArr[2], pa];
          taArr = [taArr[1], taArr[2], ta];
          kaArr = [kaArr[1], kaArr[2], ka];
          for (let i = 0; i < 3; i++) {
            document.getElementById(`rsst${i + 1}`).textContent = rsstArr[i];
            document.getElementById(`pa${i + 1}`).textContent = paArr[i];
            document.getElementById(`ta${i + 1}`).textContent = taArr[i];
            document.getElementById(`ka${i + 1}`).textContent = kaArr[i];
          }
        }

        // ヘッダーの更新（新規レコードに基づく）
        updateHeaders(recordCount);
        closeModal();
      }

      function editLast() {
        // 訂正対象の記録インデックスを検索
        const i = [3, 2, 1].find(i => document.getElementById(`rsst${i}`).textContent);
        if (!i) return alert("記録がありません");

        // モーダルに既存データをセット
        document.getElementById("rsstInput").value = document.getElementById(`rsst${i}`).textContent;
        document.getElementById("paInput").value = parseFloat(document.getElementById(`pa${i}`).textContent) * 10;
        document.getElementById("taInput").value = parseFloat(document.getElementById(`ta${i}`).textContent) * 10;
        document.getElementById("kaInput").value = parseFloat(document.getElementById(`ka${i}`).textContent) * 10;

        // 編集モードに入る
        openModal();

        // 訂正対象インデックスを保持
        window.__editRSSTIndex = i;
      }

      // ヘッダー更新のロジック（訂正後も更新しないように）
      function updateHeaders(recordCount) {
        const start = Math.max(1, recordCount - 2);
        document.getElementById("header1").textContent = `${start}回目`;
        document.getElementById("header2").textContent = `${start + 1}回目`;
        document.getElementById("header3").textContent = `${start + 2}回目`;
      }

      document.addEventListener("DOMContentLoaded", () => {
        const rsstInput = document.getElementById("rsstInput");
        const paInput = document.getElementById("paInput");
        const taInput = document.getElementById("taInput");
        const kaInput = document.getElementById("kaInput");

        rsstInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            paInput.focus();
          }
        });

        paInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            taInput.focus();
          }
        });

        taInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            kaInput.focus();
          }
        });

        kaInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            submitModal();
          }
        });
      });


    </script>
  </div>
  <div id="footer-info">
    管理者名：神崎和子　　歯科医師：鈴木守　　看護師：近藤真由美　　歯科衛生士：米村美奈子
  </div>

</body>
</html>
