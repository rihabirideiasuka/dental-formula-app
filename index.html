<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>口腔記録アプリ</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }
    .tooth-grid {
      display: grid;
      grid-template-columns: repeat(16, 40px);
      grid-gap: 4px;
      justify-content: start; /* ← centerから変更 */
      position: relative;
      margin-left: 80px; /* ←必要に応じて左余白も */
    }
    .tooth {
      width: 40px;
      height: 40px;
      border: 1px solid #999;
      margin: 2px;
      position: relative;
      text-align: center;
      box-sizing: border-box;
    }
    .tooth .number {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.2em;
      font-weight: bold;
      color: #555;
      z-index: 1;
    }

    .tooth .state {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2.2em;      /* ← サイズ拡大（元は1.5em） */
      font-weight: 200; /* ← 太字を強調なら900とかだが、数字が見えにくくなる */
      z-index: 2;
      line-height: 1;
    }

    .label-top, .label-bottom { /* ← 補助ラベルのフォント */
      font-size: 1.1em;
      font-weight: bold;
      color: blue;
      position: absolute;
      width: 100%;
      left: 0;
      text-align: center;
      line-height: 1.2;       /* ← 行間も詰め気味に */
    }
    .label-top { top: -1.2em; }
    .label-bottom { bottom: -1.2em; }
    .modal {
      display: none;
      position: fixed;
      background: rgba(0,0,0,0.6);
      top: 0; left: 0; right: 0; bottom: 0;
      justify-content: center;
      align-items: center;
      z-index: 1000; /* ← ★ これを追加！ */
    }
    .modal-content {
      background: white;
      padding: 1rem;
      border-radius: 8px;
    }
    .modal-content button {
      font-size: 1.5em;
      padding: 0.5em 1em;
      margin: 0.3em;
    }
    #lowerJaw {
      margin-top: 40px;
      position: relative;
    }
    #lowerJaw::before {
      content: "";
      position: absolute;
      top: -20px;
      left: 80;
      width: 704px;
      height: 2px;
      background: black;
    }
    .center-divider {
      position: absolute;
      top: 0;
      /* height: 88px; /* ✅ 修正: 上顎＋下顎に対応する高さ この高さをBrボタン群に合わせて調整する */
      width: 2px;
      background-color: black;
      left: 431px; /* ← 80px（margin-left）+ 352px */
      z-index: 0;
    }

    .choice-group {
      margin-bottom: 1em;
    }
    .choice-label {
      display: block;
      margin-top: 0.5em;
      font-weight: bold;
    }
    .choice-group button {
      margin: 2px;
      padding: 0.5em 1em;
      border: 1px solid #aaa;
      border-radius: 6px;
      background: #f9f9f9;
      cursor: pointer;
    }
    .choice-group button.selected {
      background-color: #4CAF50;
      color: white;
      border-color: #4CAF50;
    }
    button.selected {
      background-color: #007BFF;
      color: white;
      font-weight: bold;
    }

  </style>

</head>
<body onload="updateCenterDivider()">
<!-- 【1】歯式セクション + 基本情報入力（iPad向けUI改善） -->
<section id="tooth-section" style="margin-top: 2rem;">
  <h3>基本情報</h3>
  <div style="display: flex; flex-direction: column; gap: 1rem; max-width: 600px; font-size: 18px; border: 1px solid #ccc; padding: 1rem; border-radius: 8px; background-color: #f9f9f9;">

    <!-- 氏名とふりがな -->
    <div style="display: flex; flex-direction: column; border: 1px solid #aaa; padding: 0.5rem; border-radius: 6px;">
      <label>ふりがな：<input type="text" id="furigana" style="width: 100%; font-size: 18px;"></label>
      <label>氏名：<input type="text" id="name" style="width: 100%; font-size: 18px;"></label>
    </div>

    <!-- 性別ラジオ -->
    <div style="border: 1px solid #aaa; padding: 0.5rem; border-radius: 6px;">
      性別：
      <label><input type="radio" name="gender" value="男"> 男</label>
      <label style="margin-left: 1rem;"><input type="radio" name="gender" value="女"> 女</label>
    </div>

    <!-- 生年月日と年齢 -->
    <div style="border: 1px solid #aaa; padding: 0.5rem; border-radius: 6px;">
      <label>生年月日：<input type="date" id="birthday" style="font-size: 18px;"></label>
      <span style="margin-left: 1rem;">年齢：<span id="age">―</span>歳</span>
    </div>

    <!-- 以下はそのまま -->
    <label>要介護度：
      <select id="care-level" style="width: 100%; font-size: 18px;">
        <option value="">選択してください</option>
        <option>支援1</option>
        <option>支援2</option>
        <option>介護1</option>
        <option>介護2</option>
        <option>介護3</option>
        <option>介護4</option>
        <option>介護5</option>
      </select>
    </label>

    <label>障害高齢者の日常生活自立度：
      <select id="adl-disability" style="width: 100%; font-size: 18px;">
        <option value="">選択してください</option>
        <option>自立</option>
        <option>J1</option>
        <option>J2</option>
        <option>A1</option>
        <option>A2</option>
        <option>B1</option>
        <option>B2</option>
        <option>C1</option>
        <option>C2</option>
      </select>
    </label>

    <label>認知症高齢者の日常生活自立度：
      <select id="adl-dementia" style="width: 100%; font-size: 18px;">
        <option value="">選択してください</option>
        <option>自立</option>
        <option>Ⅰ</option>
        <option>Ⅱa</option>
        <option>Ⅱb</option>
        <option>Ⅲa</option>
        <option>Ⅲb</option>
        <option>Ⅳ</option>
        <option>M</option>
      </select>
    </label>
  </div>

  <hr style="margin: 2rem 0;">


  <h3>歯式（印付け）</h3>
  <div style="display: flex;">
    <div style="display: flex; flex-direction: column; align-items: flex-start; margin-right: 1rem; font-size: 16px;">
      <button onclick="toggleBrMode()">Br作成</button>
      <button onclick="clearBrLines()">Br消去</button>
      <div id="brStatus" style="width: 200px; min-height: 2em; line-height: 1.4; white-space: pre-wrap;">
        Br未選択
      </div>
      <div style="margin-top: 1rem;">
        <div>健全歯：／</div>
        <div>処置歯：○</div>
        <div>欠損歯：×</div>
        <div>う蝕：C</div>
        <div>ｲﾝﾌﾟﾗﾝﾄ：IMPL</div>
      </div>
    </div>

    <div style="position: relative; flex-grow: 1;">
      <div id="br-lines" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;"></div>

      <div class="tooth-grid" id="upperJaw"></div><!-- ✅ 歯番号表示はここ -->
      <div class="center-divider" style="height: calc(100% + 120px);"></div>
      <div class="tooth-grid" id="lowerJaw"></div>
    </div>
  </div>

  <!-- モーダル（歯の状態・補助ラベル） -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <p>歯の状態を選択：</p>
      <button onclick="setState('○')">○</button>
      <button onclick="setState('×')">×</button>
      <button onclick="setState('／')">／</button>
      <button onclick="setState('')">消去</button>
      <p>補助ラベル：</p>
      <button onclick="setLabel('Cr')">Cr</button>
      <button onclick="setLabel('In')">In</button>
      <button onclick="setLabel('Fck')">Fck</button>
      <button onclick="setLabel('IMPL')">IMPL</button>
      <button onclick="setLabel('死根')">死根</button>
      <button onclick="setLabel('残根')">残根</button>
      <button onclick="setLabel('C')">C</button>
      <button onclick="setLabel('C4')">C4</button>
      <button onclick="setLabel('IMPL')">IMPL</button>
      <button onclick="setLabel('')">ラベル消去</button>
    </div>
  </div>
</section>

<script>
  document.getElementById("birthday").addEventListener("change", function () {
    const birth = new Date(this.value);
    if (!isNaN(birth)) {
      const today = new Date();
      let age = today.getFullYear() - birth.getFullYear();
      const m = today.getMonth() - birth.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      document.getElementById("age").textContent = age;
    } else {
      document.getElementById("age").textContent = "―";
    }
  });


  document.getElementById("name").addEventListener("blur", function () {
    const name = this.value.trim();
    if (!name) return;

    fetch("https://labs.goo.ne.jp/api/hiragana", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        app_id: "dummy", // ← 必ず本物のAPIキーに置き換えてください
        sentence: name,
        output_type: "hiragana"
      })
    })
      .then(res => res.json())
      .then(data => {
        document.getElementById("furigana").value = data.converted || "";
      })
      .catch(() => {
        console.warn("ふりがな自動変換に失敗しました");
      });
  });
</script>




<!-- 上記の巻き微算の歯式コードの続き -->
<!-- 0. 事前情報入力フォーム -->
<section id="preliminary-info" style="margin-top: 2rem;">
  <h3>事前情報入力</h3>

  <!-- 歯科受診 -->
  <p>
    現在の歯科受診（かかりつけ医）:<br>
    <button onclick="selectButton(this, 'dentist-current')">あり</button>
    <button onclick="selectButton(this, 'dentist-current')">なし</button>
  </p>

  <!-- 直近1年間の歯科受診 -->
  <p>
    直近1年間の歯科受診:<br>
    <button onclick="selectButton(this, 'dentist-year', 'last-visit-date', true)">あり</button>
    <button onclick="selectButton(this, 'dentist-year', 'last-visit-date', false)">なし</button>
    <div id="last-visit-date" style="display:none; margin-top: 0.5rem;">
      最終受診年月: <input type="month" id="last-visit-month">
    </div>
  </p>

  <!-- 義歯の使用 -->
  <p>
    義歯の使用:<br>
    <button onclick="selectButton(this, 'denture', 'denture-type', true)">あり</button>
    <button onclick="selectButton(this, 'denture', 'denture-type', false)">なし</button>
    <div id="denture-type" style="display:none; margin-top: 0.5rem;">
      <button onclick="selectButton(this, 'denture-type')">部分</button>
      <button onclick="selectButton(this, 'denture-type')">全部</button>
    </div>
  </p>

  <!-- 栄養補給法 -->
  <p>
    栄養補給法:<br>
    <button onclick="selectButton(this, 'nutrition', 'nutrition-sub', true)">一部経口</button>
    <button onclick="selectButton(this, 'nutrition', 'nutrition-sub', false)">経口のみ</button>
    <div id="nutrition-sub" style="display:none; margin-top: 0.5rem;">
      <button onclick="toggleSelection(this)">経腸栄養</button>
      <button onclick="toggleSelection(this)">静脈栄養</button>
    </div>
  </p>

  <!-- 食事形態 -->
  <p>
    食事形態:<br>
    <button onclick="selectButton(this, 'meal', 'meal-code', true)">嚥下調整食</button>
    <button onclick="selectButton(this, 'meal', 'meal-code', false)">常食</button>
    <div id="meal-code" style="display:none; margin-top: 0.5rem;">
      コード:
      <select id="meal-code-select">
        <option value="4">4</option>
        <option value="3">3</option>
        <option value="2-2">2-2</option>
        <option value="2-1">2-1</option>
        <option value="1j">1j</option>
        <option value="0t">0t</option>
        <option value="0j">0j</option>
      </select>
    </div>
  </p>

  <!-- 誤嚥性肺炎 -->
  <p>
    誤嚥性肺炎の発症・既往:<br>
    <button onclick="selectButton(this, 'pneumonia', 'pneumonia-date', true)">あり</button>
    <button onclick="selectButton(this, 'pneumonia', 'pneumonia-date', false)">なし</button>
    <div id="pneumonia-date" style="display:none; margin-top: 0.5rem;">
      直近の発症年月: <input type="month" id="pneumonia-month">
    </div>
  </p>

  <!-- 特記事項 -->
  <p>
    その他特記事項:<br>
    <input type="text" id="other-notes" style="width: 95%;">
  </p>
</section>

<style>
  button.selected {
    background-color: #007BFF;
    color: white;
    font-weight: bold;
  }
</style>

<script>
  function selectButton(btn, group, toggleId = null, show = null) {
    const buttons = document.querySelectorAll(`button[onclick*="'${group}'"]`);
    buttons.forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");

    if (toggleId) {
      document.getElementById(toggleId).style.display = show ? 'block' : 'none';
    }
  }

  function toggleSelection(btn) {
    btn.classList.toggle("selected");
  }
</script>



<style>
button.selected {
  background-color: #007BFF;
  color: white;
  font-weight: bold;
}
</style>



<!-- 1 口腔の健康状態の評価・再評価 -->
<section id="oral-health-section" style="margin-top: 2rem;">
  <h3>1 口腔の健康状態の評価・再評価</h3>

  <label>実施日: <input type="date" id="eval-date"></label><br><br>

  <label>記入者:
    <select id="eval-author">
      <option value="山田　太郎">山田　太郎</option>
      <option value="坂口　建治">坂口　建治</option>
      <option value="本郷　彩">本郷　彩</option>
    </select>
  </label><br>

  <label>資格:
    <select id="eval-qualification">
      <option value="歯科衛生士">歯科衛生士</option>
      <option value="看護師">看護師</option>
      <option value="言語聴覚士">言語聴覚士</option>
    </select>
  </label><br><br>

  <strong>口腔衛生状態</strong><br>
  <div class="choice-group" data-group="口臭">
    <span class="choice-label">口臭:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="歯の汚れ">
    <span class="choice-label">歯の汚れ:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="義歯の汚れ">
    <span class="choice-label">義歯の汚れ:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="舌苔">
    <span class="choice-label">舌苔:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <strong>口腔機能の状態</strong><br>

  <div class="choice-group" data-group="奥歯の咬合">
    <span class="choice-label">奥歯の咬合:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="食べこぼし">
    <span class="choice-label">食べこぼし:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="むせ">
    <span class="choice-label">むせ:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="口腔乾燥">
    <span class="choice-label">口腔乾燥:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="舌の動きが悪い">
    <span class="choice-label">舌の動きが悪い:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="ぶくぶくうがい">
    <span class="choice-label">ぶくぶくうがい:</span>
    <button onclick="selectExclusive(this)">できる</button>
    <button onclick="selectExclusive(this)">できない</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="歯科受診の必要性">
    <span class="choice-label">歯科受診の必要性:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <br><strong>特記事項</strong><br>
  <div class="choice-group">
    <button onclick="selectNote(this)">歯（う蝕、修復物脱離等）、義歯、歯周病、口腔粘膜の疾患の可能性</button>
    <button onclick="selectNote(this)">音声・言語機能に関する疾患の可能性</button>
    <button onclick="selectNote(this)">その他</button>
    <input type="text" id="otherNote" placeholder="その他の内容を記入" style="display:none; width:90%; margin-top: 5px;">
  </div>
</section>




<!-- ※ 2. 口腔機能改善指導計画 セクション -->
<section id="plan-section" style="margin-top: 2rem;">
  <h3>2. 口腔機能改善管理指導計画</h3>

  <label>作成日: <input type="date" id="plan-date"></label><br><br>

  <!-- 計画立案者 -->
  <label>計画立案者:
    <select id="plan-author">
      <option value="山田　太郎">山田　太郎</option>
      <option value="坂口　建治">坂口　建治</option>
      <option value="本郷　彩">本郷　彩</option>
    </select>
  </label>
  <label>資格:
    <select id="plan-qualification">
      <option value="歯科衛生士">歯科衛生士</option>
      <option value="看護師">看護師</option>
      <option value="言語聴覚士">言語聴覚士</option>
    </select>
  </label><br><br>

  <!-- サービス提供者 -->
  <label>サービス提供者:
    <select id="provider-name">
      <option value="山田　太郎">山田　太郎</option>
      <option value="坂口　建治">坂口　建治</option>
      <option value="本郷　彩">本郷　彩</option>
    </select>
  </label>
  <label>資格:
    <select id="provider-qualification">
      <option value="歯科衛生士">歯科衛生士</option>
      <option value="看護師">看護師</option>
      <option value="言語聴覚士">言語聴覚士</option>
    </select>
  </label><br><br>

  <strong>目標項目（複数選択可）</strong><br>
  <div class="goal-selection">
    <button onclick="toggleGoal(this, 'dental')">歯科疾患</button>
    <button onclick="toggleGoal(this, 'oralHygiene')">口腔衛生</button>
    <button onclick="toggleGoal(this, 'function')">摂食嚥下等の口腔機能</button>
    <button onclick="toggleGoal(this, 'diet')">食形態</button>
    <button onclick="toggleGoal(this, 'nutrition')">栄養状態</button>
    <button onclick="toggleGoal(this, 'speech')">音声・言語機能</button>
    <button onclick="toggleGoal(this, 'pneumonia')">誤嚥性肺炎の予防</button>
    <button onclick="toggleGoal(this, 'planOther')">その他</button>
  </div><br>

  <div id="dental" class="goal-item" style="display:none;">
    <span class="choice-label"><strong>歯科疾患</strong></span><br>
    <div class="sub-goal">
      <button onclick="selectExclusive(this)">重症化防止</button>
      <button onclick="selectExclusive(this)">改善</button>
      <button onclick="selectExclusive(this)">歯科受診</button>
    </div>
  </div>

  <div id="oralHygiene" class="goal-item" style="display:none;">
    <span class="choice-label"><strong>口腔衛生</strong></span><br>
    <div class="sub-goal">
      <button onclick="selectFollowup(this, 'oralHygieneInput')">維持</button>
      <button onclick="selectFollowup(this, 'oralHygieneInput', true)">改善</button>
      <input type="text" id="oralHygieneInput" style="display:none; width:90%; margin-top:5px;">
    </div>
  </div>

  <div id="function" class="goal-item" style="display:none;">
    <span class="choice-label"><strong>摂食嚥下等の口腔機能</strong></span><br>
    <div class="sub-goal">
      <button onclick="selectFollowup(this, 'functionInput')">維持</button>
      <button onclick="selectFollowup(this, 'functionInput', true)">改善</button>
      <input type="text" id="functionInput" style="display:none; width:90%; margin-top:5px;">
    </div>
  </div>

  <div id="diet" class="goal-item" style="display:none;">
    <span class="choice-label"><strong>食形態</strong></span><br>
    <div class="sub-goal">
      <button onclick="selectFollowup(this, 'dietInput')">維持</button>
      <button onclick="selectFollowup(this, 'dietInput', true)">改善</button>
      <input type="text" id="dietInput" style="display:none; width:90%; margin-top:5px;">
    </div>
  </div>

  <div id="nutrition" class="goal-item" style="display:none;">
    <span class="choice-label"><strong>栄養状態</strong></span><br>
    <div class="sub-goal">
      <button onclick="selectFollowup(this, 'nutritionInput')">維持</button>
      <button onclick="selectFollowup(this, 'nutritionInput', true)">改善</button>
      <input type="text" id="nutritionInput" style="display:none; width:90%; margin-top:5px;">
    </div>
  </div>

  <div id="speech" class="goal-item" style="display:none;">
    <span class="choice-label"><strong>音声・言語機能</strong></span><br>
    <div class="sub-goal">
      <button onclick="selectFollowup(this, 'speechInput')">維持</button>
      <button onclick="selectFollowup(this, 'speechInput', true)">改善</button>
      <input type="text" id="speechInput" style="display:none; width:90%; margin-top:5px;">
    </div>
  </div>

  <div id="pneumonia" class="goal-item" style="display:none;">
    <span class="choice-label"><strong>誤嚥性肺炎の予防</strong></span>
  </div>

  <div id="planOther" class="goal-item" style="display:none;">
    <span class="choice-label"><strong>その他</strong></span><br>
    <input type="text" style="width: 90%;">
  </div>

  <br><strong>実施内容</strong><br>
  <div class="implementation-group">
    <button onclick="selectToggle(this)">口腔清掃</button>
    <button class="selected" onclick="selectToggle(this)">口腔清掃に関する指導</button>
    <button class="selected" onclick="selectToggle(this)">摂食嚥下等の口腔機能に関する指導</button>
    <button onclick="selectToggle(this)">音声・言語機能に関する指導</button>
    <button class="selected" onclick="selectToggle(this)">誤嚥性肺炎の予防に関する指導</button>
    <button class="selected" onclick="selectOtherImplementation(this)">その他</button>
    <input type="text" id="other-implementation" value="集団口腔体操及び個別指導" style="display:inline; width:90%; margin-top: 5px;">
  </div>
</section>


<script>
  // デフォルト日付の自動入力（今日の日付）
  document.getElementById("plan-date").value = new Date().toISOString().split("T")[0];

  // 複数選択可ボタンのON/OFF切替
  function selectToggle(btn) {
    btn.classList.toggle("selected");
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // デフォルト日付を設定
    document.getElementById("eval-date").value = new Date().toISOString().split("T")[0];
    document.getElementById("plan-date").value = new Date().toISOString().split("T")[0];

    // 記入者・資格の選択を他フィールドに自動反映
    document.getElementById("eval-author").addEventListener("change", function () {
      document.getElementById("plan-author").value = this.value;
      document.getElementById("provider-name").value = this.value;
    });

    document.getElementById("eval-qualification").addEventListener("change", function () {
      document.getElementById("plan-qualification").value = this.value;
      document.getElementById("provider-qualification").value = this.value;
    });
  });

  // 各目標項目の選択ボタン（複数選択可）→クリックでサブ項目表示/非表示
  function selectGoal(btn, targetId) {
    btn.classList.toggle("selected");
    const sub = document.getElementById(targetId);
    if (sub) {
      sub.style.display = btn.classList.contains("selected") ? "block" : "none";
    }

    // 自由記述欄も初期状態で非表示に戻す（対象がある場合のみ）
    const input = document.getElementById(targetId + 'Input');
    if (input) input.style.display = 'none';
  }

  // 排他選択（同一グループ内で1つだけ選択）
  function selectExclusive(btn) {
    const parent = btn.parentElement;
    Array.from(parent.querySelectorAll("button")).forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
  }

  // 改善など選択で記述欄表示
  function selectFollowup(btn, inputId, showInput) {
    const parent = btn.parentElement;
    Array.from(parent.querySelectorAll("button")).forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
    document.getElementById(inputId).style.display = showInput ? "inline" : "none";
  }

  // 「特記事項」用選択
  function selectNote(btn) {
    const parent = btn.parentElement;
    Array.from(parent.querySelectorAll("button")).forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");

    const isOther = btn.textContent.includes("その他");
    document.getElementById("otherNote").style.display = isOther ? "inline" : "none";
  }

  // 実施内容「その他」選択時に記述欄表示
  // 実施内容「その他」も複数選択可能にし、入力欄だけ表示
  function selectOtherImplementation(btn) {
    btn.classList.toggle("selected");
    const input = document.getElementById("other-implementation");
    input.style.display = btn.classList.contains("selected") ? "inline" : "none";
  }

  // 複数選択ON/OFFボタン
  function selectToggle(btn) {
    btn.classList.toggle("selected");
  }

  function toggleGoal(btn, targetId) {
    btn.classList.toggle("selected");
    const target = document.getElementById(targetId);
    if (target) {
      target.style.display = btn.classList.contains("selected") ? "block" : "none";
    }
  }

</script>


<!-- ※ 3. 実施記録 セクション -->
<section id="record-section" style="margin-top: 2rem;">
  <h3>3. 実施記録</h3>
  <label>実施年月日: <input type="date" id="record-date"></label>
  <br>
  <label>サービス提供者: <input type="text" id="record-provider"></label>
  <label>資格: <input type="text" id="record-qualification"></label>
  <br><br>
  <strong>実施内容（複数選択可）</strong><br>
  <div class="implementation-group">
    <button onclick="selectToggle(this)">口腔清掃</button>
    <button class="selected" onclick="selectToggle(this)">口腔清掃に関する指導</button>
    <button class="selected" onclick="selectToggle(this)">摂食嚥下等の口腔機能に関する指導</button>
    <button onclick="selectToggle(this)">音声・言語機能に関する指導</button>
    <button class="selected" onclick="selectToggle(this)">誤嚥性肺炎の予防に関する指導</button>
    <button class="selected" onclick="selectOtherImplementation(this)">その他</button>
    <input type="text" id="other-implementation" value="集団口腔体操及び個別指導" style="display:inline; width:90%; margin-top: 5px;">
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // 日付の初期値設定
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("eval-date").value = today;
    document.getElementById("plan-date").value = today;
    document.getElementById("record-date").value = today;

    // 計画立案者・サービス提供者・実施記録への連動
    document.getElementById("eval-author").addEventListener("change", function () {
      document.getElementById("plan-author").value = this.value;
      document.getElementById("provider-name").value = this.value;
      document.getElementById("record-provider").value = this.value;
    });

    document.getElementById("eval-qualification").addEventListener("change", function () {
      document.getElementById("plan-qualification").value = this.value;
      document.getElementById("provider-qualification").value = this.value;
      document.getElementById("record-qualification").value = this.value;
    });

    // ページ読み込み時に反映（初期値）
    document.getElementById("record-provider").value = document.getElementById("eval-author").value;
    document.getElementById("record-qualification").value = document.getElementById("eval-qualification").value;
  });

  // ボタンの選択切替（複数可）
  function selectToggle(btn) {
    btn.classList.toggle("selected");
  }

  // 「その他」実施内容の表示切替
  function selectOtherImplementation(btn) {
    btn.classList.toggle("selected");
    const input = document.getElementById("other-implementation");
    input.style.display = btn.classList.contains("selected") ? "inline" : "none";
  }
</script>


<section id="rsst-section" style="margin-top: 2rem;">
  <h3>4. RSSTとオーラルディアドコキネシス</h3>
  <div style="display: flex; justify-content: space-between;">
    <table border="1" style="text-align: center; border-collapse: collapse; font-size: 0.9em;">
      <thead>
        <tr>
          <th style="width: 80px;"></th>
          <th style="width: 80px;">1回目</th>
          <th style="width: 80px;">2回目</th>
          <th style="width: 80px;">3回目</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <th>RSST<br>(回/30秒)</th>
          <td id="rsst1"></td>
          <td id="rsst2"></td>
          <td id="rsst3"></td>
        </tr>
        <tr>
          <th>パ<br>(回)</th>
          <td id="pa1"></td>
          <td id="pa2"></td>
          <td id="pa3"></td>
        </tr>
        <tr>
          <th>タ<br>(回)</th>
          <td id="ta1"></td>
          <td id="ta2"></td>
          <td id="ta3"></td>
        </tr>
        <tr>
          <th>カ<br>(回)</th>
          <td id="ka1"></td>
          <td id="ka2"></td>
          <td id="ka3"></td>
        </tr>
      </tbody>
    </table>

    <div style="border: 1px solid black; padding: 10px; margin-left: 20px; width: 220px;">
      <strong>説明日・同意日</strong>
      <div style="margin-top: 10px;">
        令和　　年　　月　　日
      </div>
      <div style="margin-top: 20px;">
        利用者同意書サイン(本人)
      </div>
    </div>
  </div>
  <br>
  <button onclick="recordRSST()">記録する</button>
</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("record-date").value = new Date().toISOString().split("T")[0];

    // 2口腔機能改善管理指導計画からサービス提供者と資格を反映
    const provider = document.getElementById("provider-name")?.value || "";
    const qualification = document.getElementById("provider-qualification")?.value || "";
    document.getElementById("record-provider").value = provider;
    document.getElementById("record-qualification").value = qualification;
  });

  function selectRecordOther(btn) {
    btn.classList.toggle("selected");
    const input = document.getElementById("record-other");
    input.style.display = btn.classList.contains("selected") ? "inline" : "none";
  }
</script>




<script>
  const upperJaw = document.getElementById("upperJaw");
  const lowerJaw = document.getElementById("lowerJaw");
  const modal = document.getElementById("modal");
  let selectedTooth = null;

  const left = [8, 7, 6, 5, 4, 3, 2, 1];
  const right = [1, 2, 3, 4, 5, 6, 7, 8];

  function createTooth(id, jaw, position) {
    const div = document.createElement("div");
    div.className = "tooth";
    div.dataset.id = id;
    div.dataset.jaw = jaw;
    div.dataset.position = position;

    const numberSpan = document.createElement("span");
    numberSpan.className = "number";
    numberSpan.textContent = id;

    const stateSpan = document.createElement("span");
    stateSpan.className = "state";
    stateSpan.textContent = "";

    const topLabel = document.createElement("div");
    topLabel.className = "label-top";
    const bottomLabel = document.createElement("div");
    bottomLabel.className = "label-bottom";

    div.appendChild(numberSpan);
    div.appendChild(stateSpan);
    div.appendChild(topLabel);
    div.appendChild(bottomLabel);

    div.onclick = () => {
      if (brMode) {
        handleToothClickForBr(div);
      } else {
        selectedTooth = div;
        modal.style.display = "flex";
      }
    };
    return div;
  }

  left.concat(right).forEach((num, i) => upperJaw.appendChild(createTooth(num, "upper", i < 8 ? "left" : "right")));
  left.concat(right).forEach((num, i) => lowerJaw.appendChild(createTooth(num, "lower", i < 8 ? "left" : "right")));

  function setState(symbol) {
    if (!selectedTooth) return;
    selectedTooth.querySelector(".state").textContent = symbol;
    modal.style.display = "none";
  }

  function setLabel(label) {
    if (!selectedTooth) return;
    const jaw = selectedTooth.dataset.jaw;
    if (jaw === "upper") {
      selectedTooth.querySelector(".label-top").textContent = label;
    } else {
      selectedTooth.querySelector(".label-bottom").textContent = label;
    }
    modal.style.display = "none";
  }

  modal.onclick = e => {
    if (e.target === modal) modal.style.display = "none";
  };

  let brMode = false;
  let brStart = null;
  let brEnd = null;
  const selectedBrRanges = [];

  function toggleBrMode() {
    brMode = !brMode;
    brStart = null;
    brEnd = null;

    const status = document.getElementById("brStatus");
    status.textContent = brMode ? "Brモード ON：何番から？" : "BrモードOFF";
  }

  function handleToothClickForBr(div) {
    const status = document.getElementById("brStatus");

    if (!brStart) {
      brStart = div;
      status.textContent = `何番まで？（開始: ${brStart.dataset.id}）`;
    } else {
      brEnd = div;

      // 同じ顎のみ処理（必要ならチェック）
      if (brStart.dataset.jaw !== brEnd.dataset.jaw) {
        alert("同じ顎の歯を選択してください");
        brStart = null;
        brEnd = null;
        status.innerHTML = `Brモード ON\n何番から？`; // 改行して表示幅を保つ
        return;
      }

      selectedBrRanges.push({
        start: brStart.dataset.id,
        end: brEnd.dataset.id,
        jaw: brEnd.dataset.jaw,
        position: brEnd.dataset.position
      });

      // 線を描画（上顎下顎）
      if (brStart.dataset.jaw === brEnd.dataset.jaw) {
        drawBrLine(brStart, brEnd);
      }

      const jawLabel = brStart.dataset.jaw === "upper" ? "上" : "下";
      status.innerHTML = `Br選択完了<br>（${jawLabel}）：${brStart.dataset.id}〜${brEnd.dataset.id}`;

      brMode = false;
      brStart = null;
      brEnd = null;
    }
  }

  function submitData() {
    const userName = document.getElementById("name").value.trim();
    if (!userName) return alert("利用者名を入力してください");

    const allTeeth = document.querySelectorAll(".tooth");
    const teeth = Array.from(allTeeth).map(div => {
      const state = div.querySelector(".state").textContent;
      const jaw = div.dataset.jaw;
      const position = div.dataset.position;
      const label = jaw === "upper"
        ? div.querySelector(".label-top").textContent
        : div.querySelector(".label-bottom").textContent;
      return {
        number: div.dataset.id,
        jaw,
        position,
        state: state.trim(),
        label: label.trim()
      };
    }).filter(t => t.state || t.label);

    const data = {
      name: userName,
      record: "①",
      teeth,
      brData: selectedBrRanges
    };

    console.log("送信データ:", data);

    fetch("https://script.google.com/macros/s/AKfycbyTHDv1zLlBbnS61BYPCd1-rbaYPRo41aCQe5C_WzKYfi5I--dy32SrZCXdMxgQ1TAxyQ/exec", {
      method: "POST",
      body: JSON.stringify(data)
    })
    .then(res => res.text())
    .then(text => {
      console.log("保存レスポンス:", text);
      document.getElementById("saveStatus").textContent = text;
    })
    .catch(err => {
      console.error("保存失敗:", err);
      alert("保存に失敗しました");
    });
  }

  function drawBrLine(startElem, endElem) {
    const brContainer = document.getElementById("br-lines");

    const rect1 = startElem.getBoundingClientRect();
    const rect2 = endElem.getBoundingClientRect();
    const parentRect = brContainer.getBoundingClientRect();

    const x1 = rect1.left + rect1.width / 2 - parentRect.left;
    const x2 = rect2.left + rect2.width / 2 - parentRect.left;
    const minX = Math.min(x1, x2);
    const maxX = Math.max(x1, x2);
    const midX = (minX + maxX) / 2;

    const jaw = startElem.dataset.jaw;
    const isUpper = (jaw === "upper");

    const y = isUpper
      ? rect1.top - parentRect.top - 30  // 上顎：補助ラベルの上にBrを病が
      : rect1.bottom - parentRect.top + 30;  // 下顎：数字の下にBrを病が

    // 横線
    const line = document.createElement("div");
    line.style.position = "absolute";
    line.style.left = minX + "px";
    line.style.top = y + "px";
    line.style.width = (maxX - minX) + "px";
    line.style.height = "2px";
    line.style.backgroundColor = "red";

    // 左縦線
    const leftLine = document.createElement("div");
    leftLine.style.position = "absolute";
    leftLine.style.left = x1 + "px";
    leftLine.style.width = "2px";
    leftLine.style.height = "10px";
    leftLine.style.backgroundColor = "red";
    leftLine.style.top = isUpper ? (y + "px") : (y - 10 + "px");

    // 右縦線
    const rightLine = document.createElement("div");
    rightLine.style.position = "absolute";
    rightLine.style.left = (maxX - 1) + "px";  // 横線の右端とぴったり揃える
    rightLine.style.width = "2px";
    rightLine.style.height = "10px";
    rightLine.style.backgroundColor = "red";
    rightLine.style.top = isUpper
      ? (y + "px")           // 上顎：下向きに伸ばす
      : ((y - 8) + "px");   // 下顎：上向きに伸ばす

    // ラベル
    const label = document.createElement("div");
    label.textContent = "Br";
    label.style.position = "absolute";
    label.style.left = (midX - 10) + "px";
    label.style.top = isUpper ? (y - 20 + "px") : (y + 10 + "px");
    label.style.color = "red";
    label.style.fontWeight = "bold";
    label.style.fontSize = "18px";　// Brのフォント大きさ

    brContainer.appendChild(line);
    brContainer.appendChild(leftLine);
    brContainer.appendChild(rightLine);
    brContainer.appendChild(label);

    line.className = "br-line";
    leftLine.className = "br-line";
    rightLine.className = "br-line";
    label.className = "br-line";

  }

function clearBrLines() {
  const lines = document.querySelectorAll(".br-line");
  lines.forEach(line => line.remove());
  selectedBrRanges.length = 0; // Brのデータも初期化
  document.getElementById("brStatus").textContent = "Br未選択";
}

  function recordRSST() {
    let nextIndex = 0;
    for (let i = 1; i <= 3; i++) {
      if (document.getElementById(`rsst${i}`).textContent === '') {
        nextIndex = i;
        break;
      }
    }

    if (nextIndex === 0) {
      if (confirm("すでに3回分記録されています。全て削除して新しく記録しますか？")) {
        for (let i = 1; i <= 3; i++) {
          document.getElementById(`rsst${i}`).textContent = '';
          document.getElementById(`pa${i}`).textContent = '';
          document.getElementById(`ta${i}`).textContent = '';
          document.getElementById(`ka${i}`).textContent = '';
        }
        nextIndex = 1;
      } else {
        return;
      }
    }

    const rsst = prompt("RSSTは何回ですか？（整数）");
    if (!rsst || isNaN(rsst)) return;

    const paRaw = prompt("「パ」の回数は何回ですか？（整数）");
    const pa = (parseInt(paRaw) / 10).toFixed(1);

    const taRaw = prompt("「タ」の回数は何回ですか？（整数）");
    const ta = (parseInt(taRaw) / 10).toFixed(1);

    const kaRaw = prompt("「カ」の回数は何回ですか？（整数）");
    const ka = (parseInt(kaRaw) / 10).toFixed(1);

    document.getElementById(`rsst${nextIndex}`).textContent = parseInt(rsst);
    document.getElementById(`pa${nextIndex}`).textContent = pa;
    document.getElementById(`ta${nextIndex}`).textContent = ta;
    document.getElementById(`ka${nextIndex}`).textContent = ka;
  }

</script>
<button onclick="submitData()">保存</button>
<p id="saveStatus"></p>

<button onclick="submitData()">保存</button>
<p id="saveStatus"></p>

<!-- ← ここに追加します -->
<script>
  function updateCenterDivider() {
    const upper = document.getElementById("upperJaw");
    const lower = document.getElementById("lowerJaw");
    const divider = document.querySelector(".center-divider");

    if (upper && lower && divider) {
      const upperTop = upper.offsetTop;
      const lowerBottom = lower.offsetTop + lower.offsetHeight;

      const height = lowerBottom - upperTop;

      divider.style.top = upperTop + "px";
      divider.style.height = height + "px";

    }
  }
  window.addEventListener("resize", updateCenterDivider);
</script>

</body>
</html>
