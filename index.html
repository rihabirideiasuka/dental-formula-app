<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>口腔記録アプリ</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 1rem;
    }
    .tooth-grid {
      display: grid;
      grid-template-columns: repeat(16, 40px);
      grid-gap: 4px;
      justify-content: start; /* ← centerから変更 */
      position: relative;
      margin-left: 80px; /* ←必要に応じて左余白も */
    }
    .tooth {
      width: 40px;
      height: 40px;
      border: 1px solid #999;
      margin: 2px;
      position: relative;
      text-align: center;
      box-sizing: border-box;
    }
    .tooth .number {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.2em;
      font-weight: bold;
      color: #555;
      z-index: 1;
    }

    .tooth .state {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2.2em;      /* ← サイズ拡大（元は1.5em） */
      font-weight: 200; /* ← 太字を強調なら900とかだが、数字が見えにくくなる */
      z-index: 2;
      line-height: 1;
    }

    .label-top, .label-bottom { /* ← 補助ラベルのフォント */
      font-size: 1.1em;
      font-weight: bold;
      color: blue;
      position: absolute;
      width: 100%;
      left: 0;
      text-align: center;
      line-height: 1.2;       /* ← 行間も詰め気味に */
    }
    .label-top { top: -1.2em; }
    .label-bottom { bottom: -1.2em; }
    .modal {
      display: none;
      position: fixed;
      background: rgba(0,0,0,0.6);
      top: 0; left: 0; right: 0; bottom: 0;
      justify-content: center;
      align-items: center;
      z-index: 1000; /* ← ★ これを追加！ */
    }
    .modal-content {
      background: white;
      padding: 1rem;
      border-radius: 8px;
    }
    .modal-content button {
      font-size: 1.5em;
      padding: 0.5em 1em;
      margin: 0.3em;
    }
    #lowerJaw {
      margin-top: 40px;
      position: relative;
    }
    #lowerJaw::before {
      content: "";
      position: absolute;
      top: -20px;
      left: 80;
      width: 704px;
      height: 2px;
      background: black;
    }
    .center-divider {
      position: absolute;
      top: 0;
      /* height: 88px; /* ✅ 修正: 上顎＋下顎に対応する高さ この高さをBrボタン群に合わせて調整する */
      width: 2px;
      background-color: black;
      left: 431px; /* ← 80px（margin-left）+ 352px */
      z-index: 0;
    }

    .choice-group {
      margin-bottom: 1em;
    }
    .choice-label {
      display: block;
      margin-top: 0.5em;
      font-weight: bold;
    }
/* 共通ボタンスタイル */
button {
  padding: 1em 2em;
  font-size: 18px;
  border-radius: 8px;
  cursor: pointer;
  margin: 0.5em 0.5em 0.5em 0;
  border: 1px solid #ccc;
  background-color: white;
  transition: background-color 0.3s ease, transform 0.2s ease;
}

/* 選択されたボタン */
button.selected,
.choice-group button.selected {
  background-color: #007BFF;
  color: white;
  font-weight: bold;
  border-color: #007BFF;
}

/* ホバー時の効果 */
button:hover {
  background-color: #0056b3;
  color: white;
  transform: scale(1.05);
}

button:active {
  transform: scale(0.98);
}

/* ラベル類・その他 */
.choice-label {
  display: block;
  margin-top: 0.5em;
  font-weight: bold;
}

.choice-group {
  margin-bottom: 1em;
}

.choice-group button {
  margin: 0.3em;
}

/* CSS内に追加 */
.large-input {
  font-size: 18px;
  width: 90%;
  margin-top: 5px;
}
.rsst-button {
  padding: 1em 2em;
  font-size: 18px;
  border-radius: 8px;
  cursor: pointer;
  margin: 0.5em 0.5em 0.5em 0;
  border: 1px solid #ccc;
  background-color: white;
  transition: background-color 0.3s ease, transform 0.2s ease;
}

.rsst-button:hover {
  background-color: #0056b3;
  color: white;
  transform: scale(1.05);
}

.rsst-button:active {
  transform: scale(0.98);
}

.rsst-button.selected {
  background-color: #007BFF;
  color: white;
  font-weight: bold;
  border-color: #007BFF;
}

#rsstModal .modal-content {
  background: white;
  padding: 1.5rem;
  border-radius: 10px;
  width: 95vw;
  max-width: 750px;     /* ← 元の600pxから広げた */
  box-sizing: border-box;
}

.label-text {
  display: block;
  font-size: 16px;
  line-height: 1.5;
  margin-bottom: 0.3em;
  white-space: normal;
  word-break: break-word;
  overflow-wrap: break-word;
  width: 100%;
  box-sizing: border-box;
}

.input-block {
  margin-bottom: 1em;
  padding: 0 0.5em;
  width: 100%;
  box-sizing: border-box;
}


.large-input {
  font-size: 18px;
  width: 100%;
  padding: 6px;
  box-sizing: border-box;
}



  </style>

</head>
<body onload="updateCenterDivider()">
<!-- 【1】歯式セクション + 基本情報入力（iPad向けUI改善） -->
<!-- 基本情報セクション（整ったフォーム表示） -->
<section id="tooth-section" style="margin-top: 2rem;">
  <h3>基本情報</h3>

  <div style="max-width: 500px; margin-left: 0; font-size: 16px; display: flex; flex-direction: column; gap: 1rem;">

    <!-- 氏名・ふりがな -->
    <div style="border: 1px solid #aaa; border-radius: 6px; padding: 1rem;">
      <label style="display: block; margin-bottom: 0.5em;">ふりがな：
        <input type="text" id="furigana" style="width: 96%; font-size: 16px;">
      </label>
      <label style="display: block;">氏名：
        <input type="text" id="name" style="width: 96%; font-size: 16px; height: 2.5em;">
      </label>
    </div>

    <!-- 性別 -->
    <div style="border: 1px solid #aaa; border-radius: 6px; padding: 1rem;">
      <div>性別：</div>
      <label><input type="radio" name="gender" value="男"> 男</label>
      <label style="margin-left: 1em;"><input type="radio" name="gender" value="女"> 女</label>
    </div>

    <!-- 生年月日と年齢 -->
    <div class="birth-age-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
      <label style="font-size: 18px;">
        生年月日：
        <input type="date" id="birthday" style="width: 100%; font-size: 18px; padding: 10px; height: 44px; box-sizing: border-box;">
      </label>

      <label style="font-size: 18px;">
        年齢：
        <span id="age-display" style="
          display: inline-block;
          width: 100%;
          font-size: 18px;
          height: 44px;
          line-height: 44px;
          padding: 0 10px;
          border: 1px solid #ccc;
          border-radius: 4px;
          box-sizing: border-box;
          background-color: white;
        ">-- 歳</span>
      </label>
    </div>


    <!-- 要介護度 -->
    <div style="border: 1px solid #aaa; border-radius: 6px; padding: 1rem;">
      <label style="display: block;">要介護度：
        <select id="care-level" style="width: 100%; font-size: 16px;">
          <option value="">選択してください</option>
          <option>支援1</option>
          <option>支援2</option>
          <option>介護1</option>
          <option>介護2</option>
          <option>介護3</option>
          <option>介護4</option>
          <option>介護5</option>
        </select>
      </label>
    </div>

    <!-- 障害高齢者の自立度 -->
    <div style="border: 1px solid #aaa; border-radius: 6px; padding: 1rem;">
      <label style="display: block;">障害高齢者の日常生活自立度：
        <select id="adl-disability" style="width: 100%; font-size: 16px;">
          <option value="">選択してください</option>
          <option>自立</option>
          <option>J1</option>
          <option>J2</option>
          <option>A1</option>
          <option>A2</option>
          <option>B1</option>
          <option>B2</option>
          <option>C1</option>
          <option>C2</option>
        </select>
      </label>
    </div>

    <!-- 認知症高齢者の自立度 -->
    <div style="border: 1px solid #aaa; border-radius: 6px; padding: 1rem;">
      <label style="display: block;">認知症高齢者の日常生活自立度：
        <select id="adl-dementia" style="width: 100%; font-size: 16px;">
          <option value="">選択してください</option>
          <option>自立</option>
          <option>Ⅰ</option>
          <option>Ⅱa</option>
          <option>Ⅱb</option>
          <option>Ⅲa</option>
          <option>Ⅲb</option>
          <option>Ⅳ</option>
          <option>M</option>
        </select>
      </label>
    </div>
  </div>
</section>


  <hr style="margin: 2rem 0; border-top: 2px dashed #ccc;">



<!-- 【1】歯式セクション + 基本情報入力（iPad向けUI改善） -->
<section id="tooth-section" style="margin-top: 2rem;">
  <h3>歯式（印付け）</h3>
  <div style="display: flex;">
    <div style="display: flex; flex-direction: column; align-items: flex-start; margin-right: 1rem; font-size: 16px;">

      <!-- ✅ Br作成・消去ボタンを横並び＋大きく -->
      <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
        <button onclick="toggleBrMode()" style="padding: 0.75em 1.5em; font-size: 1.1em;">Br作成</button>
        <button onclick="clearBrLines()" style="padding: 0.75em 1.5em; font-size: 1.1em;">Br消去</button>
      </div>

      <div id="brStatus" style="width: 200px; min-height: 2em; line-height: 1.4; white-space: pre-wrap;">
        Br未選択
      </div>
      <div style="margin-top: 1rem;">
        <div>健全歯：／</div>
        <div>処置歯：○</div>
        <div>欠損歯：×</div>
        <div>う蝕：C</div>
        <div>ｲﾝﾌﾟﾗﾝﾄ：IMPL</div>
      </div>
    </div>

    <div style="position: relative; flex-grow: 1;">
      <div id="br-lines" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none;"></div>

      <div class="tooth-grid" id="upperJaw" style="position: relative;"></div>
      <div id="upper-toggle-wrapper" style="position: absolute;"></div>

      <div class="center-divider" style="height: calc(100% + 120px);"></div>

      <div class="tooth-grid" id="lowerJaw" style="position: relative;"></div>
      <div id="lower-toggle-wrapper" style="position: absolute;"></div>
    </div>
  </div>

  <!-- モーダル（歯の状態・補助ラベル） -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <p>歯の状態を選択：</p>
      <button onclick="setState('○')">○</button>
      <button onclick="setState('×')">×</button>
      <button onclick="setState('／')">／</button>
      <button onclick="setState('△')">△</button>
      <button onclick="setState('')">消去</button>
      <p>補助ラベル：</p>
      <button onclick="setLabel('Cr')">Cr</button>
      <button onclick="setLabel('In')">In</button>
      <button onclick="setLabel('Fck')">Fck</button>
      <button onclick="setLabel('死根')">死根</button>
      <button onclick="setLabel('残根')">残根</button>
      <button onclick="setLabel('C')">C</button>
      <button onclick="setLabel('C4')">C4</button>
      <button onclick="setLabel('IMPL')">IMPL</button>
      <button onclick="setLabel('')">ラベル消去</button>
    </div>
  </div>
</section>

<script>
function cyclePdFd(btn) {
  const states = ["", "PD", "FD"];
  const current = btn.textContent.trim();
  const nextIndex = (states.indexOf(current) + 1) % states.length;
  btn.textContent = states[nextIndex];
}

function positionPdFdButtons() {
  const upper8 = [...document.querySelectorAll("#upperJaw .tooth")].find(t => t.dataset.id === "8" && t.dataset.position === "right");
  const lower8 = [...document.querySelectorAll("#lowerJaw .tooth")].find(t => t.dataset.id === "8" && t.dataset.position === "right");

  const upperWrapper = document.getElementById("upper-toggle-wrapper");
  const lowerWrapper = document.getElementById("lower-toggle-wrapper");

  // 上顎の8番歯の右横にボタンを配置
  if (upper8) {
    const rect = upper8.getBoundingClientRect();
    const gridOffset = document.getElementById("upperJaw").getBoundingClientRect();
    upperWrapper.style.left = `${rect.right - gridOffset.left + 2 * rect.width + 5}px`;  // 歯の右2本分右に配置
    upperWrapper.style.top = `${rect.top - gridOffset.top}px`;
    upperWrapper.innerHTML = `<button onclick="cyclePdFd(this)" style="padding: 6px 10px; font-size: 14px;">　</button>`;
  }

  // 下顎の8番歯の右横にボタンを配置（少し下に調整）
  if (lower8) {
    const rect = lower8.getBoundingClientRect();
    const gridOffset = document.getElementById("lowerJaw").getBoundingClientRect();
    lowerWrapper.style.left = `${rect.right - gridOffset.left + 2 * rect.width + 5}px`;  // 歯の右2本分右に配置
    lowerWrapper.style.top = `${rect.top - gridOffset.top + 85}px`; // PD/FDの位置をここで少し下に調整（85px）
    lowerWrapper.innerHTML = `<button onclick="cyclePdFd(this)" style="padding: 6px 10px; font-size: 14px;">　</button>`;
  }
}

window.addEventListener("load", positionPdFdButtons);
window.addEventListener("resize", positionPdFdButtons);
</script>



<script>
  document.getElementById("birthday").addEventListener("change", function () {
    const birth = new Date(this.value);
    const ageSpan = document.getElementById("age-display");

    if (!isNaN(birth)) {
      const today = new Date();
      let age = today.getFullYear() - birth.getFullYear();
      const m = today.getMonth() - birth.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) {
        age--;
      }
      ageSpan.textContent = `${age} 歳`;
    } else {
      ageSpan.textContent = "-- 歳";
    }
  });

  document.getElementById("name").addEventListener("blur", function () {
    const name = this.value.trim();
    if (!name) return;

    fetch("https://labs.goo.ne.jp/api/hiragana", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        app_id: "dummy", // ← 必ず本物のAPIキーに置き換えてください
        sentence: name,
        output_type: "hiragana"
      })
    })
      .then(res => res.json())
      .then(data => {
        document.getElementById("furigana").value = data.converted || "";
      })
      .catch(() => {
        console.warn("ふりがな自動変換に失敗しました");
      });
  });
</script>




<!-- 上記の巻き微算の歯式コードの続き -->
<!-- 0. 事前情報入力フォーム -->
<section id="preliminary-info" style="margin-top: 2rem;">
  <h3>事前情報入力</h3>

  <!-- 歯科受診 -->
  <p>
    現在の歯科受診（かかりつけ医）:<br>
    <button onclick="selectButton(this, 'dentist-current')" style="padding: 1em 2em; font-size: 18px;">あり</button>
    <button onclick="selectButton(this, 'dentist-current')" style="padding: 1em 2em; font-size: 18px;">なし</button>
  </p>

  <!-- 直近1年間の歯科受診 -->
  <p>
    直近1年間の歯科受診:<br>
    <button onclick="selectButton(this, 'dentist-year', 'last-visit-date', true)" style="padding: 1em 2em; font-size: 18px;">あり</button>
    <button onclick="selectButton(this, 'dentist-year', 'last-visit-date', false)" style="padding: 1em 2em; font-size: 18px;">なし</button>
    <div id="last-visit-date" style="display:none; margin-top: 0.5rem;">
      最終受診年月: <input type="month" id="last-visit-month" style="font-size: 18px;">
    </div>
  </p>

  <!-- 義歯の使用（部分・全部・なし） -->
  <p>
    義歯の使用:<br>
    <button id="dentures-partial" onclick="selectDentureType(this, 'partial')" style="padding: 1em 2em; font-size: 18px;">部分</button>
    <button id="dentures-full" onclick="selectDentureType(this, 'full')" style="padding: 1em 2em; font-size: 18px;">全部</button>
    <button id="dentures-none" onclick="selectDentureType(this, 'none')" style="padding: 1em 2em; font-size: 18px;">なし</button>
  </p>

  <!-- 栄養補給法 -->
  <p>
    栄養補給法:<br>
    <button onclick="selectButton(this, 'nutrition', 'nutrition-sub', true)" style="padding: 1em 2em; font-size: 18px;">一部経口</button>
    <button onclick="selectButton(this, 'nutrition', 'nutrition-sub', false)" style="padding: 1em 2em; font-size: 18px;">経口のみ</button>
    <div id="nutrition-sub" style="display:none; margin-top: 0.5rem;">
      <button onclick="toggleSelection(this)" style="padding: 1em 2em; font-size: 18px;">経腸栄養</button>
      <button onclick="toggleSelection(this)" style="padding: 1em 2em; font-size: 18px;">静脈栄養</button>
    </div>
  </p>

  <!-- 食事形態 -->
  <p>
    食事形態:<br>
    <button onclick="selectButton(this, 'meal', 'meal-code', true)" style="padding: 1em 2em; font-size: 18px;">嚥下調整食</button>
    <button onclick="selectButton(this, 'meal', 'meal-code', false)" style="padding: 1em 2em; font-size: 18px;">常食</button>
    <div id="meal-code" style="display:none; margin-top: 0.5rem;">
      コード:
      <select id="meal-code-select" style="padding: 1em; font-size: 18px;">
        <option value="4">4</option>
        <option value="3">3</option>
        <option value="2-2">2-2</option>
        <option value="2-1">2-1</option>
        <option value="1j">1j</option>
        <option value="0t">0t</option>
        <option value="0j">0j</option>
      </select>
    </div>
  </p>

  <!-- 誤嚥性肺炎 -->
  <p>
    誤嚥性肺炎の発症・既往:<br>
    <button onclick="selectButton(this, 'pneumonia', 'pneumonia-date', true)" style="padding: 1em 2em; font-size: 18px;">あり</button>
    <button onclick="selectButton(this, 'pneumonia', 'pneumonia-date', false)" style="padding: 1em 2em; font-size: 18px;">なし</button>
    <div id="pneumonia-date" style="display:none; margin-top: 0.5rem;">
      直近の発症年月: <input type="month" id="pneumonia-month" style="font-size: 18px;">
    </div>
  </p>

  <!-- 特記事項 -->
  <p>
    その他特記事項:<br>
    <input type="text" id="other-notes" style="width: 95%; font-size: 18px; padding: 0.5em;">
  </p>
</section>

<!-- スタイル -->
<style>
  button.selected {
    background-color: #007BFF;
    color: white;
    font-weight: bold;
  }
</style>

<!-- スクリプト -->
<script>
  // 通常の単独選択ボタン処理
  function selectButton(btn, group, toggleId = null, show = null) {
    const buttons = document.querySelectorAll(`button[onclick*="'${group}'"]`);
    buttons.forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");

    if (toggleId) {
      document.getElementById(toggleId).style.display = show ? 'block' : 'none';
    }
  }

  // 義歯の使用 専用処理（partial / full / none）
  function selectDentureType(btn, type) {
    const buttons = {
      partial: document.getElementById('dentures-partial'),
      full: document.getElementById('dentures-full'),
      none: document.getElementById('dentures-none')
    };

    // すべてのボタンの選択解除
    Object.values(buttons).forEach(b => b.classList.remove('selected'));

    if (type === 'partial' || type === 'full') {
      btn.classList.add('selected');
      // 内部的に「あり」として扱いたい場合など、状態を保存してもよい
      console.log("義歯使用: あり（" + type + "）");
    } else if (type === 'none') {
      btn.classList.add('selected');
      console.log("義歯使用: なし");
    }
  }

  // 栄養補給法サブボタンの複数選択処理
  function toggleSelection(btn) {
    btn.classList.toggle("selected");
  }
</script>




<style>
button {
  padding: 1em 2em; /* ボタンのサイズを大きくして押しやすく */
  font-size: 18px;  /* 文字のサイズを大きくして視認性を高める */
  border-radius: 8px; /* 丸みのあるボタン */
  cursor: pointer;  /* カーソルを指に変更してクリックしやすく */
  margin: 0.5em 0; /* ボタン同士の間隔を広くして押しやすく */
  transition: background-color 0.3s ease, transform 0.2s ease; /* ボタンの色とサイズをアニメーションで */
}

button.selected {
  background-color: #007BFF;
  color: white;
  font-weight: bold;
}

button:hover {
  background-color: #0056b3; /* ホバー時に色が変わる */
  transform: scale(1.05);  /* ホバー時に少し大きくなる */
}

button:active {
  transform: scale(0.98); /* クリック時に少し縮む */
}
</style>


<!-- 1 口腔の健康状態の評価・再評価 -->
<section id="oral-health-section" style="margin-top: 2rem;">
  <h3>1 口腔の健康状態の評価・再評価</h3>

  <label>実施日: <input type="date" id="eval-date" style="font-size: 18px;"></label><br><br>

  <label>記入者:
    <select id="eval-author" style="font-size: 18px;">
      <option value="山田　太郎">山田　太郎</option>
      <option value="坂口　建治">坂口　建治</option>
      <option value="本郷　彩">本郷　彩</option>
    </select>
  </label><br>

  <label>資格:
    <select id="eval-qualification" style="font-size: 18px;">
      <option value="歯科衛生士">歯科衛生士</option>
      <option value="看護師">看護師</option>
      <option value="言語聴覚士">言語聴覚士</option>
    </select>
  </label><br><br>

  <strong>口腔衛生状態</strong><br>
  <div class="choice-group" data-group="口臭">
    <span class="choice-label">口臭:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="歯の汚れ">
    <span class="choice-label">歯の汚れ:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="義歯の汚れ">
    <span class="choice-label">義歯の汚れ:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="舌苔">
    <span class="choice-label">舌苔:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <strong>口腔機能の状態</strong><br>

  <div class="choice-group" data-group="奥歯の咬合">
    <span class="choice-label">奥歯の咬合:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="食べこぼし">
    <span class="choice-label">食べこぼし:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="むせ">
    <span class="choice-label">むせ:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="口腔乾燥">
    <span class="choice-label">口腔乾燥:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="舌の動きが悪い">
    <span class="choice-label">舌の動きが悪い:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="ぶくぶくうがい">
    <span class="choice-label">ぶくぶくうがい:</span>
    <button onclick="selectExclusive(this)">できる</button>
    <button onclick="selectExclusive(this)">できない</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <div class="choice-group" data-group="歯科受診の必要性">
    <span class="choice-label">歯科受診の必要性:</span>
    <button onclick="selectExclusive(this)">あり</button>
    <button onclick="selectExclusive(this)">なし</button>
    <button onclick="selectExclusive(this)">分からない</button>
  </div>

  <br><strong>特記事項</strong><br>
  <div class="choice-group">
    <button onclick="selectNote(this)">歯（う蝕、修復物脱離等）、義歯、歯周病、口腔粘膜の疾患の可能性</button>
    <button onclick="selectNote(this)">音声・言語機能に関する疾患の可能性</button>
    <button onclick="selectNote(this)">その他</button>
    <input type="text" id="otherNote" placeholder="その他の内容を記入" style="display:none; width:90%; margin-top: 5px; font-size: 18px;">
  </div>
</section>




<!-- ※ 2. 口腔機能改善指導計画 セクション -->
<section id="plan-section" style="margin-top: 2rem;">
  <h3>2. 口腔機能改善管理指導計画</h3>

  <label>作成日: <input type="date" id="plan-date" style="font-size: 18px;"></label><br><br>

  <!-- 計画立案者 -->
  <label>計画立案者:
    <select id="plan-author" style="font-size: 18px;">
      <option value="山田　太郎">山田　太郎</option>
      <option value="坂口　建治">坂口　建治</option>
      <option value="本郷　彩">本郷　彩</option>
    </select>
  </label>
  <label>資格:
    <select id="plan-qualification" style="font-size: 18px;">
      <option value="歯科衛生士">歯科衛生士</option>
      <option value="看護師">看護師</option>
      <option value="言語聴覚士">言語聴覚士</option>
    </select>
  </label><br><br>

  <!-- サービス提供者 -->
  <label>サービス提供者:
    <select id="provider-name" style="font-size: 18px;">
      <option value="山田　太郎">山田　太郎</option>
      <option value="坂口　建治">坂口　建治</option>
      <option value="本郷　彩">本郷　彩</option>
    </select>
  </label>
  <label>資格:
    <select id="provider-qualification" style="font-size: 18px;">
      <option value="歯科衛生士">歯科衛生士</option>
      <option value="看護師">看護師</option>
      <option value="言語聴覚士">言語聴覚士</option>
    </select>
  </label><br><br>

  <strong>目標項目（複数選択可）</strong><br>
  <div class="goal-selection">
    <button onclick="toggleGoal(this, 'dental')">歯科疾患</button>
    <button onclick="toggleGoal(this, 'oralHygiene')">口腔衛生</button>
    <button onclick="toggleGoal(this, 'function')">摂食嚥下等の口腔機能</button>
    <button onclick="toggleGoal(this, 'diet')">食形態</button>
    <button onclick="toggleGoal(this, 'nutrition')">栄養状態</button>
    <button onclick="toggleGoal(this, 'speech')">音声・言語機能</button>
    <button onclick="toggleGoal(this, 'pneumonia')">誤嚥性肺炎の予防</button>
    <button onclick="toggleGoal(this, 'planOther')">その他</button>
  </div><br>

  <div id="dental" class="goal-item" style="display:none;">
    <span class="choice-label"><strong>歯科疾患</strong></span><br>
    <div class="sub-goal">
      <button onclick="selectExclusive(this)">重症化防止</button>
      <button onclick="selectExclusive(this)">改善</button>
      <button onclick="selectExclusive(this)">歯科受診</button>
    </div>
  </div>

  <div id="oralHygiene" class="goal-item" style="display:none;">
    <span class="choice-label"><strong>口腔衛生</strong></span><br>
    <div class="sub-goal">
      <button onclick="selectFollowup(this, 'oralHygieneInput')">維持</button>
      <button onclick="selectFollowup(this, 'oralHygieneInput', true)">改善</button>
      <input type="text" id="oralHygieneInput" style="display:none; width:90%; margin-top:5px; font-size: 18px;">
    </div>
  </div>

  <div id="function" class="goal-item" style="display:none;">
    <span class="choice-label"><strong>摂食嚥下等の口腔機能</strong></span><br>
    <div class="sub-goal">
      <button onclick="selectFollowup(this, 'functionInput')">維持</button>
      <button onclick="selectFollowup(this, 'functionInput', true)">改善</button>
      <input type="text" id="functionInput" style="display:none; width:90%; margin-top:5px; font-size: 18px;">
    </div>
  </div>

  <div id="diet" class="goal-item" style="display:none;">
    <span class="choice-label"><strong>食形態</strong></span><br>
    <div class="sub-goal">
      <button onclick="selectFollowup(this, 'dietInput')">維持</button>
      <button onclick="selectFollowup(this, 'dietInput', true)">改善</button>
      <input type="text" id="dietInput" style="display:none; width:90%; margin-top:5px; font-size: 18px;">
    </div>
  </div>

  <div id="nutrition" class="goal-item" style="display:none;">
    <span class="choice-label"><strong>栄養状態</strong></span><br>
    <div class="sub-goal">
      <button onclick="selectFollowup(this, 'nutritionInput')">維持</button>
      <button onclick="selectFollowup(this, 'nutritionInput', true)">改善</button>
      <input type="text" id="nutritionInput" style="display:none; width:90%; margin-top:5px; font-size: 18px;">
    </div>
  </div>

  <div id="speech" class="goal-item" style="display:none;">
    <span class="choice-label"><strong>音声・言語機能</strong></span><br>
    <div class="sub-goal">
      <button onclick="selectFollowup(this, 'speechInput')">維持</button>
      <button onclick="selectFollowup(this, 'speechInput', true)">改善</button>
      <input type="text" id="speechInput" style="display:none; width:90%; margin-top:5px; font-size: 18px;">
    </div>
  </div>

  <div id="pneumonia" class="goal-item" style="display:none;">
    <span class="choice-label"><strong>誤嚥性肺炎の予防</strong></span>
  </div>

  <div id="planOther" class="goal-item" style="display:none;">
    <span class="choice-label"><strong>その他</strong></span><br>
    <input type="text" style="width: 90%; font-size: 18px;">
  </div>

  <br><strong>実施内容</strong><br>
  <div class="implementation-group">
    <button onclick="selectToggle(this)">口腔清掃</button>
    <button class="selected" onclick="selectToggle(this)">口腔清掃に関する指導</button>
    <button class="selected" onclick="selectToggle(this)">摂食嚥下等の口腔機能に関する指導</button>
    <button onclick="selectToggle(this)">音声・言語機能に関する指導</button>
    <button class="selected" onclick="selectToggle(this)">誤嚥性肺炎の予防に関する指導</button>
    <button class="selected" onclick="selectOtherImplementation(this)">その他</button>
    <input type="text" id="other-implementation" class="large-input" value="集団口腔体操及び個別指導">
  </div>
</section>


<script>
  // デフォルト日付の自動入力（今日の日付）
  document.getElementById("plan-date").value = new Date().toISOString().split("T")[0];

  // 複数選択可ボタンのON/OFF切替
  function selectToggle(btn) {
    btn.classList.toggle("selected");
  }
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // デフォルト日付を設定
    document.getElementById("eval-date").value = new Date().toISOString().split("T")[0];
    document.getElementById("plan-date").value = new Date().toISOString().split("T")[0];

    // 記入者・資格の選択を他フィールドに自動反映
    document.getElementById("eval-author").addEventListener("change", function () {
      document.getElementById("plan-author").value = this.value;
      document.getElementById("provider-name").value = this.value;
    });

    document.getElementById("eval-qualification").addEventListener("change", function () {
      document.getElementById("plan-qualification").value = this.value;
      document.getElementById("provider-qualification").value = this.value;
    });
  });

  // 各目標項目の選択ボタン（複数選択可）→クリックでサブ項目表示/非表示
  function selectGoal(btn, targetId) {
    btn.classList.toggle("selected");
    const sub = document.getElementById(targetId);
    if (sub) {
      sub.style.display = btn.classList.contains("selected") ? "block" : "none";
    }

    // 自由記述欄も初期状態で非表示に戻す（対象がある場合のみ）
    const input = document.getElementById(targetId + 'Input');
    if (input) input.style.display = 'none';
  }

  // 排他選択（同一グループ内で1つだけ選択）
  function selectExclusive(btn) {
    const parent = btn.parentElement;
    Array.from(parent.querySelectorAll("button")).forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
  }

  // 改善など選択で記述欄表示
  function selectFollowup(btn, inputId, showInput) {
    const parent = btn.parentElement;
    Array.from(parent.querySelectorAll("button")).forEach(b => b.classList.remove("selected"));
    btn.classList.add("selected");
    document.getElementById(inputId).style.display = showInput ? "inline" : "none";
  }

  // 「特記事項」用選択
  function selectNote(button) {
    // 選択状態をトグル（on/off）
    button.classList.toggle("selected");

    // 「その他」ボタンが押された場合のみ、テキスト入力を表示・非表示
    if (button.textContent === "その他") {
      const input = document.getElementById("otherNote");
      if (button.classList.contains("selected")) {
        input.style.display = "block";
      } else {
        input.style.display = "none";
      }
    }
  }


  // 実施内容「その他」選択時に記述欄表示
  // 実施内容「その他」も複数選択可能にし、入力欄だけ表示
  function selectOtherImplementation(btn) {
    btn.classList.toggle("selected");
    const input = document.getElementById("other-implementation");
    input.style.display = btn.classList.contains("selected") ? "inline" : "none";
  }

  // 複数選択ON/OFFボタン
  function selectToggle(btn) {
    btn.classList.toggle("selected");
  }

  function toggleGoal(btn, targetId) {
    btn.classList.toggle("selected");
    const target = document.getElementById(targetId);
    if (target) {
      target.style.display = btn.classList.contains("selected") ? "block" : "none";
    }
  }

</script>


<!-- ※ 3. 実施記録 セクション -->
<section id="record-section" style="margin-top: 2rem;">
  <h3>3. 実施記録</h3>
  <label>実施年月日: <input type="date" id="record-date" style="font-size: 18px;"></label>
  <br>
  <label>サービス提供者: <input type="text" id="record-provider" style="font-size: 18px;"></label>
  <label>資格: <input type="text" id="record-qualification" style="font-size: 18px;"></label>
  <br><br>
  <strong>実施内容（複数選択可）</strong><br>
  <div class="implementation-group">
    <button onclick="selectToggle(this)">口腔清掃</button>
    <button class="selected" onclick="selectToggle(this)">口腔清掃に関する指導</button>
    <button class="selected" onclick="selectToggle(this)">摂食嚥下等の口腔機能に関する指導</button>
    <button onclick="selectToggle(this)">音声・言語機能に関する指導</button>
    <button class="selected" onclick="selectToggle(this)">誤嚥性肺炎の予防に関する指導</button>
    <button class="selected" onclick="selectOtherImplementation(this)">その他</button>
    <input type="text" id="other-implementation" class="large-input" value="集団口腔体操及び個別指導">
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // 日付の初期値設定
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("eval-date").value = today;
    document.getElementById("plan-date").value = today;
    document.getElementById("record-date").value = today;

    // 計画立案者・サービス提供者・実施記録への連動
    document.getElementById("eval-author").addEventListener("change", function () {
      document.getElementById("plan-author").value = this.value;
      document.getElementById("provider-name").value = this.value;
      document.getElementById("record-provider").value = this.value;
    });

    document.getElementById("eval-qualification").addEventListener("change", function () {
      document.getElementById("plan-qualification").value = this.value;
      document.getElementById("provider-qualification").value = this.value;
      document.getElementById("record-qualification").value = this.value;
    });

    // ページ読み込み時に反映（初期値）
    document.getElementById("record-provider").value = document.getElementById("eval-author").value;
    document.getElementById("record-qualification").value = document.getElementById("eval-qualification").value;
  });

  // ボタンの選択切替（複数可）
  function selectToggle(btn) {
    btn.classList.toggle("selected");
  }

  // 「その他」実施内容の表示切替
  function selectOtherImplementation(btn) {
    btn.classList.toggle("selected");
    const input = document.getElementById("other-implementation");
    input.style.display = btn.classList.contains("selected") ? "inline" : "none";
  }
</script>


<section id="rsst-section" style="margin-top: 2rem;">
  <h3>4. RSSTとオーラルディアドコキネシス</h3>

  <div style="display: flex; flex-wrap: wrap; justify-content: flex-start; gap: 20px;">
    <div style="width: 50%; min-width: 300px; overflow-x: auto;">
      <table style="width: 100%; text-align: center; border-collapse: collapse; font-size: 1.2em; table-layout: fixed; border: 1px solid black;">
        <thead>
          <tr>
            <th style="border: 1px solid black;"></th>
            <th id="header1" style="border: 1px solid black;">1回目</th>
            <th id="header2" style="border: 1px solid black;">2回目</th>
            <th id="header3" style="border: 1px solid black;">3回目</th>
          </tr>        
        </thead>
        <tbody>
          <tr>
            <th style="word-break: break-word; border: 1px solid black;">RSST<br>(回/30秒)<br>正常値3回以上</th>
            <td id="rsst1" style="border: 1px solid black;"></td>
            <td id="rsst2" style="border: 1px solid black;"></td>
            <td id="rsst3" style="border: 1px solid black;"></td>
          </tr>
          <tr>
            <th style="word-break: break-word; border: 1px solid black;">パ(回)<br>男4.4～7.2<br>女4.2～7.2</th>
            <td id="pa1" style="border: 1px solid black;"></td>
            <td id="pa2" style="border: 1px solid black;"></td>
            <td id="pa3" style="border: 1px solid black;"></td>
          </tr>
          <tr>
            <th style="word-break: break-word; border: 1px solid black;">タ(回)<br>男4.2～7.0<br>女4.4～7.2</th>
            <td id="ta1" style="border: 1px solid black;"></td>
            <td id="ta2" style="border: 1px solid black;"></td>
            <td id="ta3" style="border: 1px solid black;"></td>
          </tr>
          <tr>
            <th style="word-break: break-word; border: 1px solid black;">カ(回)<br>男4.0～6.6<br>女4.1～6.7</th>
            <td id="ka1" style="border: 1px solid black;"></td>
            <td id="ka2" style="border: 1px solid black;"></td>
            <td id="ka3" style="border: 1px solid black;"></td>
          </tr>
        </tbody>
      </table>
    </div>

<!--
<div style="border: 1px solid black; padding: 10px; width: 220px; flex-shrink: 0;">
  <strong>説明日・同意日</strong>
  <div style="margin-top: 10px;">
    令和　　年　　月　　日
  </div>
  <div style="margin-top: 20px;">
    利用者同意書サイン(本人)
  </div>
</div>
-->


  <br>
  <button class="rsst-button" onclick="recordRSST()">記録する</button>
    <!-- RSSTの記録ボタンの近くに置く -->
  <button class="rsst-button" onclick="editLastRSST()">記録訂正</button>

</section>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("record-date").value = new Date().toISOString().split("T")[0];

    // 2口腔機能改善管理指導計画からサービス提供者と資格を反映
    const provider = document.getElementById("provider-name")?.value || "";
    const qualification = document.getElementById("provider-qualification")?.value || "";
    document.getElementById("record-provider").value = provider;
    document.getElementById("record-qualification").value = qualification;
  });

  function selectRecordOther(btn) {
    btn.classList.toggle("selected");
    const input = document.getElementById("record-other");
    input.style.display = btn.classList.contains("selected") ? "inline" : "none";
  }
</script>




<script>
  const upperJaw = document.getElementById("upperJaw");
  const lowerJaw = document.getElementById("lowerJaw");
  const modal = document.getElementById("modal");
  let selectedTooth = null;

  const left = [8, 7, 6, 5, 4, 3, 2, 1];
  const right = [1, 2, 3, 4, 5, 6, 7, 8];

  function createTooth(id, jaw, position) {
    const div = document.createElement("div");
    div.className = "tooth";
    div.dataset.id = id;
    div.dataset.jaw = jaw;
    div.dataset.position = position;

    const numberSpan = document.createElement("span");
    numberSpan.className = "number";
    numberSpan.textContent = id;

    const stateSpan = document.createElement("span");
    stateSpan.className = "state";
    stateSpan.textContent = "";

    const topLabel = document.createElement("div");
    topLabel.className = "label-top";
    const bottomLabel = document.createElement("div");
    bottomLabel.className = "label-bottom";

    div.appendChild(numberSpan);
    div.appendChild(stateSpan);
    div.appendChild(topLabel);
    div.appendChild(bottomLabel);

    div.onclick = () => {
      if (brMode) {
        handleToothClickForBr(div);
      } else {
        selectedTooth = div;
        modal.style.display = "flex";
      }
    };
    return div;
  }

  left.concat(right).forEach((num, i) => upperJaw.appendChild(createTooth(num, "upper", i < 8 ? "left" : "right")));
  left.concat(right).forEach((num, i) => lowerJaw.appendChild(createTooth(num, "lower", i < 8 ? "left" : "right")));

  function setState(symbol) {
    if (!selectedTooth) return;
    selectedTooth.querySelector(".state").textContent = symbol;
    modal.style.display = "none";
  }

  function setLabel(label) {
    if (!selectedTooth) return;
    const jaw = selectedTooth.dataset.jaw;
    if (jaw === "upper") {
      selectedTooth.querySelector(".label-top").textContent = label;
    } else {
      selectedTooth.querySelector(".label-bottom").textContent = label;
    }
    modal.style.display = "none";
  }

  modal.onclick = e => {
    if (e.target === modal) modal.style.display = "none";
  };

  let brMode = false;
  let brStart = null;
  let brEnd = null;
  const selectedBrRanges = [];

  function toggleBrMode() {
    brMode = !brMode;
    brStart = null;
    brEnd = null;

    const status = document.getElementById("brStatus");
    status.textContent = brMode ? "Brモード ON：何番から？" : "BrモードOFF";
  }

  function handleToothClickForBr(div) {
    const status = document.getElementById("brStatus");

    if (!brStart) {
      brStart = div;
      status.textContent = `何番まで？（開始: ${brStart.dataset.id}）`;
    } else {
      brEnd = div;

      // 同じ顎のみ処理（必要ならチェック）
      if (brStart.dataset.jaw !== brEnd.dataset.jaw) {
        alert("同じ顎の歯を選択してください");
        brStart = null;
        brEnd = null;
        status.innerHTML = `Brモード ON\n何番から？`; // 改行して表示幅を保つ
        return;
      }

      selectedBrRanges.push({
        start: brStart.dataset.id,
        end: brEnd.dataset.id,
        jaw: brEnd.dataset.jaw,
        position: brEnd.dataset.position
      });

      // 線を描画（上顎下顎）
      if (brStart.dataset.jaw === brEnd.dataset.jaw) {
        drawBrLine(brStart, brEnd);
      }

      const jawLabel = brStart.dataset.jaw === "upper" ? "上" : "下";
      status.innerHTML = `Br選択完了<br>（${jawLabel}）：${brStart.dataset.id}〜${brEnd.dataset.id}`;

      brMode = false;
      brStart = null;
      brEnd = null;
    }
  }

  function submitData() {
    const userName = document.getElementById("name").value.trim();
    if (!userName) return alert("利用者名を入力してください");

    const allTeeth = document.querySelectorAll(".tooth");
    const teeth = Array.from(allTeeth).map(div => {
      const state = div.querySelector(".state").textContent;
      const jaw = div.dataset.jaw;
      const position = div.dataset.position;
      const label = jaw === "upper"
        ? div.querySelector(".label-top").textContent
        : div.querySelector(".label-bottom").textContent;
      return {
        number: div.dataset.id,
        jaw,
        position,
        state: state.trim(),
        label: label.trim()
      };
    }).filter(t => t.state || t.label);

    const data = {
      name: userName,
      record: "①",
      teeth,
      brData: selectedBrRanges
    };

    console.log("送信データ:", data);

    fetch("https://script.google.com/macros/s/AKfycbyTHDv1zLlBbnS61BYPCd1-rbaYPRo41aCQe5C_WzKYfi5I--dy32SrZCXdMxgQ1TAxyQ/exec", {
      method: "POST",
      body: JSON.stringify(data)
    })
    .then(res => res.text())
    .then(text => {
      console.log("保存レスポンス:", text);
      document.getElementById("saveStatus").textContent = text;
    })
    .catch(err => {
      console.error("保存失敗:", err);
      alert("保存に失敗しました");
    });
  }

  function drawBrLine(startElem, endElem) {
    const brContainer = document.getElementById("br-lines");

    const rect1 = startElem.getBoundingClientRect();
    const rect2 = endElem.getBoundingClientRect();
    const parentRect = brContainer.getBoundingClientRect();

    const x1 = rect1.left + rect1.width / 2 - parentRect.left;
    const x2 = rect2.left + rect2.width / 2 - parentRect.left;
    const minX = Math.min(x1, x2);
    const maxX = Math.max(x1, x2);
    const midX = (minX + maxX) / 2;

    const jaw = startElem.dataset.jaw;
    const isUpper = (jaw === "upper");

    const y = isUpper
      ? rect1.top - parentRect.top - 30
      : rect1.bottom - parentRect.top + 30;

    // 横線
    const line = document.createElement("div");
    line.style.position = "absolute";
    line.style.left = minX + "px";
    line.style.top = y + "px";
    line.style.width = (maxX - minX + 2) + "px";// 線がぴったりするように調整+2に
    line.style.height = "2px";
    line.style.backgroundColor = "red";

    // 左縦線（start）
    const leftLine = document.createElement("div");
    leftLine.style.position = "absolute";
    leftLine.style.left = x1 + "px";
    leftLine.style.width = "2px";
    leftLine.style.height = "10px";
    leftLine.style.backgroundColor = "red";
    leftLine.style.top = isUpper ? (y + "px") : (y - 10 + "px");

    // 右縦線（end）
    const rightLine = document.createElement("div");
    rightLine.style.position = "absolute";
    rightLine.style.left = x2 + "px";
    rightLine.style.width = "2px";
    rightLine.style.height = "10px";
    rightLine.style.backgroundColor = "red";
    rightLine.style.top = isUpper ? (y + "px") : (y - 8 + "px");// 線がぴったりするように調整-10を-8に

    // Brラベル
    const label = document.createElement("div");
    label.textContent = "Br";
    label.style.position = "absolute";
    label.style.left = (midX - 10) + "px";
    label.style.top = isUpper ? (y - 20 + "px") : (y + 10 + "px");
    label.style.color = "red";
    label.style.fontWeight = "bold";
    label.style.fontSize = "18px";

    // DOM追加
    [line, leftLine, rightLine, label].forEach(elem => {
      elem.className = "br-line";
      brContainer.appendChild(elem);
    });
  }


function clearBrLines() {
  const lines = document.querySelectorAll(".br-line");
  lines.forEach(line => line.remove());
  selectedBrRanges.length = 0; // Brのデータも初期化
  document.getElementById("brStatus").textContent = "Br未選択";
}
</script>
<!-- RSSTモーダル -->
<div id="rsstModal" class="modal">
  <div class="modal-content">
    <h3>RSST・パ・タ・カ 記録入力</h3>

    <div class="input-block">
      <div class="label-text">RSST（回/30秒）<br>正常値 3回以上</div>
      <input type="number" id="rsstInput" class="large-input" />
    </div>

    <div class="input-block">
      <div class="label-text">パ（回）<br>男4.4～7.2 女4.2～7.2</div>
      <input type="number" id="paInput" class="large-input" />
    </div>

    <div class="input-block">
      <div class="label-text">タ（回）<br>男4.2～7.0 女4.4～7.2</div>
      <input type="number" id="taInput" class="large-input" />
    </div>

    <div class="input-block">
      <div class="label-text">カ（回）<br>男4.0～6.6 女4.1～6.7</div>
      <input type="number" id="kaInput" class="large-input" />
    </div>

    <button onclick="submitRSSTFromModal()">記録する</button>
    <button onclick="closeRSSTModal()">キャンセル</button>
  </div>
</div>


<!-- RSST用JS -->
<script>
  function recordRSST() {
    document.getElementById("rsstModal").style.display = "flex";
    setTimeout(() => {
      document.getElementById("rsstInput").focus(); // 自動フォーカス
    }, 100);
  }

  function submitRSSTFromModal() {
    const rsstInput = document.getElementById("rsstInput").value;
    const paRaw = document.getElementById("paInput").value;
    const taRaw = document.getElementById("taInput").value;
    const kaRaw = document.getElementById("kaInput").value;

    if (!rsstInput || !paRaw || !taRaw || !kaRaw) {
      alert("すべての項目を入力してください");
      return;
    }

    const paValue = (parseInt(paRaw) / 10).toFixed(1);
    const taValue = (parseInt(taRaw) / 10).toFixed(1);
    const kaValue = (parseInt(kaRaw) / 10).toFixed(1);

    const editIndex = window.__editRSSTIndex;
    if (editIndex) {
      document.getElementById(`rsst${editIndex}`).textContent = parseInt(rsstInput);
      document.getElementById(`pa${editIndex}`).textContent = paValue;
      document.getElementById(`ta${editIndex}`).textContent = taValue;
      document.getElementById(`ka${editIndex}`).textContent = kaValue;

      updateTableHeaders(editIndex + 1);
      closeRSSTModal();
      delete window.__editRSSTIndex;
      return;
    }

    // 新規記録モード（空欄に追加）
    const rsstArr = [1, 2, 3].map(i => document.getElementById(`rsst${i}`).textContent);
    const paArr   = [1, 2, 3].map(i => document.getElementById(`pa${i}`).textContent);
    const taArr   = [1, 2, 3].map(i => document.getElementById(`ta${i}`).textContent);
    const kaArr   = [1, 2, 3].map(i => document.getElementById(`ka${i}`).textContent);

    const emptyIndex = rsstArr.findIndex(val => val === "");
    if (emptyIndex !== -1) {
      const i = emptyIndex + 1;
      document.getElementById(`rsst${i}`).textContent = parseInt(rsstInput);
      document.getElementById(`pa${i}`).textContent   = paValue;
      document.getElementById(`ta${i}`).textContent   = taValue;
      document.getElementById(`ka${i}`).textContent   = kaValue;
      updateTableHeaders(i);
    } else {
      const totalCount = parseInt(document.getElementById("header3").textContent) || 3;
      const newRSST = [rsstArr[1], rsstArr[2], parseInt(rsstInput)];
      const newPa = [paArr[1], paArr[2], paValue];
      const newTa = [taArr[1], taArr[2], taValue];
      const newKa = [kaArr[1], kaArr[2], kaValue];

      [1, 2, 3].forEach((i, idx) => {
        document.getElementById(`rsst${i}`).textContent = newRSST[idx];
        document.getElementById(`pa${i}`).textContent = newPa[idx];
        document.getElementById(`ta${i}`).textContent = newTa[idx];
        document.getElementById(`ka${i}`).textContent = newKa[idx];
      });
      updateTableHeaders(totalCount + 1);
    }

    closeRSSTModal();
  }


  function closeRSSTModal() {
    document.getElementById("rsstModal").style.display = "none";
    ["rsstInput", "paInput", "taInput", "kaInput"].forEach(id => {
      document.getElementById(id).value = "";
    });
  }

  function updateTableHeaders(latestIndex) {
    const start = Math.max(1, latestIndex - 2);
    document.getElementById("header1").textContent = `${start}回目`;
    document.getElementById("header2").textContent = `${start + 1}回目`;
    document.getElementById("header3").textContent = `${start + 2}回目`;
  }
</script>

<!-- 保存ボタン（既存のまま） -->
<button onclick="submitData()">保存</button>
<p id="saveStatus"></p>

<!-- センターディバイダー調整（そのまま） -->
<script>
  function updateCenterDivider() {
    const upper = document.getElementById("upperJaw");
    const lower = document.getElementById("lowerJaw");
    const divider = document.querySelector(".center-divider");

    if (upper && lower && divider) {
      const upperTop = upper.offsetTop;
      const lowerBottom = lower.offsetTop + lower.offsetHeight;
      const height = lowerBottom - upperTop;
      divider.style.top = upperTop + "px";
      divider.style.height = height + "px";
    }
  }
  window.addEventListener("resize", updateCenterDivider);
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const fields = ["rsstInput", "paInput", "taInput", "kaInput"];

  fields.forEach((id, index) => {
    const input = document.getElementById(id);
    input.addEventListener("keydown", function (e) {
      if (e.key === "Enter" || e.key === "Tab") {
        e.preventDefault();
        const nextId = fields[index + 1];
        if (nextId) {
          document.getElementById(nextId).focus();
        } else {
          // 最後（kaInput）なら記録処理を実行
          submitRSSTFromModal();
        }
      }
    });
  });
});
</script>
<script>
function editLastRSST() {
  const rsst3 = document.getElementById("rsst3").textContent;
  const pa3 = document.getElementById("pa3").textContent;
  const ta3 = document.getElementById("ta3").textContent;
  const ka3 = document.getElementById("ka3").textContent;

  // 3回目が空なら2回目、2回目も空なら1回目
  let latestIndex = 3;
  if (!rsst3) latestIndex = 2;
  if (!document.getElementById(`rsst${latestIndex}`).textContent) latestIndex = 1;
  if (!document.getElementById(`rsst${latestIndex}`).textContent) {
    alert("まだ記録がありません。訂正できません。");
    return;
  }

  // モーダルを開いて再入力
  document.getElementById("rsstModal").style.display = "flex";

  // モーダルに最新値を事前入力
  document.getElementById("rsstInput").value = document.getElementById(`rsst${latestIndex}`).textContent || "";
  document.getElementById("paInput").value = parseFloat(document.getElementById(`pa${latestIndex}`).textContent || "") * 10 || "";
  document.getElementById("taInput").value = parseFloat(document.getElementById(`ta${latestIndex}`).textContent || "") * 10 || "";
  document.getElementById("kaInput").value = parseFloat(document.getElementById(`ka${latestIndex}`).textContent || "") * 10 || "";

  // 修正用フラグをセット
  window.__editRSSTIndex = latestIndex;
}
</script>
</body>


</html>
